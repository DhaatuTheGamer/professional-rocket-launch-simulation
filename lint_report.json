[{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\core\\Game.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OrbitalElements' is defined but never used.","line":8,"column":36,"messageId":"unusedVar","endLine":8,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"OrbitalElements"},"fix":{"range":[158,175],"text":""},"desc":"Remove unused variable \"OrbitalElements\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CONFIG' is defined but never used.","line":10,"column":5,"messageId":"unusedVar","endLine":10,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CONFIG"},"fix":{"range":[219,226],"text":""},"desc":"Remove unused variable \"CONFIG\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SASModes' is defined but never used.","line":26,"column":15,"messageId":"unusedVar","endLine":26,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SASModes"},"fix":{"range":[626,636],"text":""},"desc":"Remove unused variable \"SASModes\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":208,"column":20,"messageId":"unexpectedAny","endLine":208,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7299,7302],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7299,7302],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":209,"column":20,"messageId":"unexpectedAny","endLine":209,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7339,7342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7339,7342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":210,"column":20,"messageId":"unexpectedAny","endLine":210,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7401,7404],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7401,7404],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":20,"messageId":"unexpectedAny","endLine":211,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7445,7448],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7445,7448],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":212,"column":20,"messageId":"unexpectedAny","endLine":212,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7494,7497],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7494,7497],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":213,"column":20,"messageId":"unexpectedAny","endLine":213,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7549,7552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7549,7552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":298,"column":43,"messageId":"unexpectedAny","endLine":298,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10493,10496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10493,10496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":302,"column":20,"messageId":"unexpectedAny","endLine":302,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10578,10581],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10578,10581],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":303,"column":20,"messageId":"unexpectedAny","endLine":303,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10631,10634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10631,10634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":304,"column":20,"messageId":"unexpectedAny","endLine":304,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10692,10695],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10692,10695],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":305,"column":20,"messageId":"unexpectedAny","endLine":305,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10733,10736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10733,10736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":363,"column":24,"messageId":"unexpectedAny","endLine":363,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12795,12798],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12795,12798],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":364,"column":24,"messageId":"unexpectedAny","endLine":364,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12852,12855],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12852,12855],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":365,"column":24,"messageId":"unexpectedAny","endLine":365,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12917,12920],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12917,12920],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":412,"column":28,"messageId":"unexpectedAny","endLine":412,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14773,14776],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14773,14776],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":417,"column":43,"messageId":"unexpectedAny","endLine":417,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14899,14902],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14899,14902],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":581,"column":20,"messageId":"unexpectedAny","endLine":581,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21143,21146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21143,21146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":582,"column":20,"messageId":"unexpectedAny","endLine":582,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21204,21207],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21204,21207],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-useless-assignment","severity":2,"message":"This assigned value is not used in subsequent statements.","line":952,"column":17,"messageId":"unnecessaryAssignment","endLine":952,"endColumn":24},{"ruleId":"no-useless-assignment","severity":2,"message":"This assigned value is not used in subsequent statements.","line":953,"column":17,"messageId":"unnecessaryAssignment","endLine":953,"endColumn":22},{"ruleId":"no-useless-assignment","severity":2,"message":"This assigned value is not used in subsequent statements.","line":1006,"column":17,"messageId":"unnecessaryAssignment","endLine":1006,"endColumn":26},{"ruleId":"no-useless-assignment","severity":2,"message":"This assigned value is not used in subsequent statements.","line":1007,"column":17,"messageId":"unnecessaryAssignment","endLine":1007,"endColumn":22},{"ruleId":"no-useless-assignment","severity":2,"message":"This assigned value is not used in subsequent statements.","line":1079,"column":21,"messageId":"unnecessaryAssignment","endLine":1079,"endColumn":26}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Game\r\n * \r\n * Main game controller class.\r\n * Manages game loop, physics updates, rendering, and subsystems.\r\n */\r\n\r\nimport { CameraMode, MissionState, OrbitalElements, IVessel } from '../types';\r\nimport {\r\n    CONFIG,\r\n    PIXELS_PER_METER,\r\n    R_EARTH,\r\n    getAtmosphericDensity\r\n} from '../constants';\r\nimport {\r\n    state,\r\n    updateDimensions,\r\n    setAudioEngine,\r\n    setMissionLog,\r\n    setAssetLoader,\r\n    addParticle\r\n} from '../state';\r\nimport { InputManager } from './InputManager';\r\nimport { AudioEngine } from '../utils/AudioEngine';\r\nimport { AssetLoader } from '../utils/AssetLoader';\r\nimport { SAS, SASModes } from '../utils/SAS';\r\nimport { MissionLog } from '../ui/MissionLog';\r\nimport { Navball } from '../ui/Navball';\r\nimport { TelemetrySystem } from '../ui/Telemetry';\r\nimport { Particle } from '../physics/Particle';\r\nimport { FullStack, Booster, UpperStage, Payload, Fairing } from '../physics/RocketComponents';\r\nimport { FlightComputer } from '../guidance/FlightComputer';\r\nimport { BlackBoxRecorder } from '../telemetry/BlackBoxRecorder';\r\nimport { EnvironmentSystem, formatTimeOfDay, getWindDirectionString } from '../physics/Environment';\r\nimport { setWindVelocity, setDensityMultiplier } from '../state';\r\nimport { ManeuverPlanner } from '../ui/ManeuverPlanner';\r\nimport { MissionControl } from '../ui/MissionControl';\r\nimport { UI_COLORS } from '../ui/UIConstants';\r\nimport { FlightTerminationSystem } from '../safety/FlightTermination';\r\nimport { LaunchChecklist } from '../safety/LaunchChecklist';\r\nimport { FaultInjector } from '../safety/FaultInjector';\r\nimport { Vessel } from '../physics/Vessel';\r\n\r\nexport class Game {\r\n    // Canvas and rendering\r\n    private canvas: HTMLCanvasElement;\r\n    private ctx: CanvasRenderingContext2D;\r\n    private width: number;\r\n    private height: number;\r\n    public groundY: number;\r\n\r\n    // Subsystems\r\n    public input: InputManager;\r\n    public audio: AudioEngine;\r\n    public assets: AssetLoader;\r\n    public navball: Navball;\r\n    public telemetry: TelemetrySystem;\r\n    public missionLog: MissionLog;\r\n    public sas: SAS;\r\n    public flightComputer: FlightComputer;\r\n    public blackBox: BlackBoxRecorder;\r\n    public environment: EnvironmentSystem;\r\n    public maneuverPlanner: ManeuverPlanner;\r\n    public missionControl: MissionControl;\r\n    public fts: FlightTerminationSystem;\r\n    public checklist: LaunchChecklist;\r\n    public faultInjector: FaultInjector;\r\n\r\n    // Game state\r\n    public entities: IVessel[] = [];\r\n    private nextOrbitUpdateIndex: number = 0;\r\n    public particles: Particle[] = [];\r\n    private cameraY: number = 0;\r\n    private cameraMode: CameraMode = 'ROCKET';\r\n    private cameraShakeX: number = 0;\r\n    private cameraShakeY: number = 0;\r\n    private timeScale: number = 1.0;\r\n\r\n    // Tracked vessels\r\n    public trackedEntity: IVessel | null = null;\r\n    public mainStack: IVessel | null = null;\r\n    public booster: Booster | null = null;\r\n    public upperStage: UpperStage | null = null;\r\n\r\n    // Mission state\r\n    private missionState: MissionState = {\r\n        liftoff: false,\r\n        supersonic: false,\r\n        maxq: false\r\n    };\r\n\r\n    // Timing\r\n    private lastTime: number = 0;\r\n    private accumulator: number = 0;\r\n    private readonly FIXED_DT: number = 1 / 60;\r\n    public missionTime: number = 0;\r\n    private lastStageTime: number = 0;\r\n\r\n    // Bloom effect (for engine glow)\r\n    private bloomCanvas: HTMLCanvasElement;\r\n    private bloomCtx: CanvasRenderingContext2D;\r\n\r\n    // HUD state cache for minimizing DOM updates\r\n    private lastHUDState = {\r\n        // Environment\r\n        windSpeed: -1,\r\n        windDir: '',\r\n        timeOfDay: '',\r\n        launchStatus: '',\r\n        maxQWarning: false,\r\n\r\n        // Telemetry\r\n        alt: '',\r\n        vel: '',\r\n        apogee: '',\r\n        fuelPct: -1,\r\n        thrustPct: -1,\r\n\r\n        // Flight Data\r\n        aoa: '',\r\n        aoaColor: '',\r\n        stability: '',\r\n        stabilityColor: '',\r\n\r\n        // TPS & Engine\r\n        skinTemp: '',\r\n        skinTempColor: '',\r\n        tpsStatus: '',\r\n        tpsStatusColor: '',\r\n        engineStatus: '',\r\n        engineStatusColor: '',\r\n        igniters: -1,\r\n        ignitersColor: '',\r\n\r\n        // FTS\r\n        ftsState: '',\r\n        ftsStateColor: ''\r\n    };\r\n\r\n    // HUD element cache\r\n    private hudWindSpeed: HTMLElement | null = null;\r\n    private hudWindDir: HTMLElement | null = null;\r\n    private hudTimeOfDay: HTMLElement | null = null;\r\n    private hudLaunchStatus: HTMLElement | null = null;\r\n    private hudMaxQ: HTMLElement | null = null;\r\n    private hudAlt: HTMLElement | null = null;\r\n    private hudVel: HTMLElement | null = null;\r\n    private hudApogee: HTMLElement | null = null;\r\n    private gaugeFuel: HTMLElement | null = null;\r\n    private gaugeThrust: HTMLElement | null = null;\r\n    private hudAoa: HTMLElement | null = null;\r\n    private hudStability: HTMLElement | null = null;\r\n    private hudSkinTemp: HTMLElement | null = null;\r\n    private hudTpsStatus: HTMLElement | null = null;\r\n    private hudEngineStatus: HTMLElement | null = null;\r\n    private hudIgniters: HTMLElement | null = null;\r\n    private hudFtsState: HTMLElement | null = null;\r\n\r\n    constructor() {\r\n        // Get canvas\r\n        const canvas = document.getElementById('canvas') as HTMLCanvasElement;\r\n        if (!canvas) throw new Error('Canvas element not found');\r\n        this.canvas = canvas;\r\n\r\n        const ctx = canvas.getContext('2d');\r\n        if (!ctx) throw new Error('Could not get 2D context');\r\n        this.ctx = ctx;\r\n\r\n        // Set dimensions\r\n        this.width = window.innerWidth;\r\n        this.height = window.innerHeight;\r\n        this.canvas.width = this.width;\r\n        this.canvas.height = this.height;\r\n        this.groundY = this.height - 100;\r\n\r\n        // Initialize subsystems\r\n        this.input = new InputManager();\r\n        this.audio = new AudioEngine();\r\n        this.assets = new AssetLoader();\r\n        this.navball = new Navball();\r\n        this.telemetry = new TelemetrySystem();\r\n        this.missionLog = new MissionLog();\r\n        this.sas = new SAS();\r\n        this.flightComputer = new FlightComputer(this.groundY);\r\n        this.blackBox = new BlackBoxRecorder(this.groundY);\r\n        this.environment = new EnvironmentSystem();\r\n        this.maneuverPlanner = new ManeuverPlanner(this);\r\n        this.missionControl = new MissionControl(this);\r\n        this.fts = new FlightTerminationSystem();\r\n        this.checklist = new LaunchChecklist('checklist-panel');\r\n        this.faultInjector = new FaultInjector('fis-panel');\r\n\r\n        // Bloom canvas for glow effects\r\n        this.bloomCanvas = document.createElement('canvas');\r\n        this.bloomCanvas.width = this.width / 4;\r\n        this.bloomCanvas.height = this.height / 4;\r\n        const bloomCtx = this.bloomCanvas.getContext('2d');\r\n        if (!bloomCtx) throw new Error('Could not get bloom context');\r\n        this.bloomCtx = bloomCtx;\r\n\r\n        // Update global state\r\n        updateDimensions(this.width, this.height, this.groundY);\r\n        setAudioEngine(this.audio);\r\n        setMissionLog(this.missionLog);\r\n        setAssetLoader(this.assets);\r\n\r\n        // Expose to window for legacy compatibility\r\n        (window as any).state = state;\r\n        (window as any).PIXELS_PER_METER = PIXELS_PER_METER;\r\n        (window as any).R_EARTH = R_EARTH;\r\n        (window as any).navball = this.navball;\r\n        (window as any).missionLog = this.missionLog;\r\n        (window as any).audio = this.audio;\r\n\r\n        this.initHUDCache();\r\n    }\r\n\r\n    /**\r\n     * Initialize HUD element cache\r\n     */\r\n    private initHUDCache(): void {\r\n        this.hudWindSpeed = document.getElementById('hud-wind-speed');\r\n        this.hudWindDir = document.getElementById('hud-wind-dir');\r\n        this.hudTimeOfDay = document.getElementById('hud-time-of-day');\r\n        this.hudLaunchStatus = document.getElementById('hud-launch-status');\r\n        this.hudMaxQ = document.getElementById('hud-maxq-warning');\r\n        this.hudAlt = document.getElementById('hud-alt');\r\n        this.hudVel = document.getElementById('hud-vel');\r\n        this.hudApogee = document.getElementById('hud-apogee');\r\n        this.gaugeFuel = document.getElementById('gauge-fuel');\r\n        this.gaugeThrust = document.getElementById('gauge-thrust');\r\n        this.hudAoa = document.getElementById('hud-aoa');\r\n        this.hudStability = document.getElementById('hud-stability');\r\n        this.hudSkinTemp = document.getElementById('hud-skin-temp');\r\n        this.hudTpsStatus = document.getElementById('hud-tps-status');\r\n        this.hudEngineStatus = document.getElementById('hud-engine-status');\r\n        this.hudIgniters = document.getElementById('hud-igniters');\r\n        this.hudFtsState = document.getElementById('hud-fts-state');\r\n    }\r\n\r\n    /**\r\n     * Initialize game\r\n     */\r\n    async init(): Promise<void> {\r\n        // Audio requires user interaction\r\n        document.addEventListener('click', () => {\r\n            this.audio.resume();\r\n            this.audio.init();\r\n        }, { once: true });\r\n\r\n        document.addEventListener('touchstart', () => {\r\n            this.audio.resume();\r\n            this.audio.init();\r\n        }, { once: true });\r\n\r\n        // Toggle Maneuver Planner with 'O'\r\n        window.addEventListener('keydown', (e) => {\r\n            if (e.key === 'o' || e.key === 'O') {\r\n                this.maneuverPlanner.toggle();\r\n            }\r\n        });\r\n\r\n        // Load assets\r\n        await this.assets.loadAll();\r\n\r\n        // Reset game state\r\n        this.reset();\r\n\r\n        // Start game loop\r\n        this.animate(0);\r\n    }\r\n\r\n    /**\r\n     * Reset to initial state\r\n     */\r\n    reset(): void {\r\n        this.entities = [];\r\n        this.particles = [];\r\n        this.cameraY = 0;\r\n        this.timeScale = 1;\r\n        this.missionState = { liftoff: false, supersonic: false, maxq: false };\r\n\r\n        // Reset safety systems\r\n        this.fts.reset();\r\n        this.checklist.reset();\r\n        this.faultInjector.reset();\r\n\r\n        // Create initial rocket\r\n        const rocket = new FullStack(this.width / 2, this.groundY - 160);\r\n        this.entities.push(rocket);\r\n        this.mainStack = rocket;\r\n        this.trackedEntity = rocket;\r\n\r\n        // Set FTS launch position\r\n        this.fts.setLaunchPosition(rocket.x);\r\n\r\n        // Update global state\r\n        state.entities = this.entities as any;\r\n        state.particles = [];\r\n\r\n        // Legacy globals\r\n        (window as any).mainStack = this.mainStack;\r\n        (window as any).trackedEntity = this.trackedEntity;\r\n        (window as any).booster = null;\r\n        (window as any).upperStage = null;\r\n    }\r\n\r\n    /**\r\n     * Perform staging sequence\r\n     */\r\n    public performStaging(): void {\r\n        if (Date.now() - this.lastStageTime < 1000) return;\r\n        this.lastStageTime = Date.now();\r\n\r\n        if (!this.trackedEntity) return;\r\n\r\n        if (this.trackedEntity instanceof FullStack) {\r\n            this.missionLog.log(\"STAGING: S1 SEP\", \"warn\");\r\n            this.audio.playStaging();\r\n\r\n            // Create staging particles\r\n            for (let i = 0; i < 30; i++) {\r\n                addParticle(new Particle(\r\n                    this.trackedEntity.x + (Math.random() - 0.5) * 20,\r\n                    this.trackedEntity.y + 80,\r\n                    'smoke',\r\n                    this.trackedEntity.vx + (Math.random() - 0.5) * 20,\r\n                    this.trackedEntity.vy + (Math.random() - 0.5) * 20\r\n                ));\r\n            }\r\n\r\n            // Remove full stack\r\n            this.entities = this.entities.filter(e => e !== this.trackedEntity);\r\n\r\n            // Create booster\r\n            this.booster = new Booster(\r\n                this.trackedEntity.x,\r\n                this.trackedEntity.y,\r\n                this.trackedEntity.vx,\r\n                this.trackedEntity.vy\r\n            );\r\n            this.booster.angle = this.trackedEntity.angle;\r\n            this.booster.fuel = 0.05;\r\n            this.booster.active = true;\r\n            this.entities.push(this.booster);\r\n\r\n            // Create upper stage\r\n            this.upperStage = new UpperStage(\r\n                this.trackedEntity.x,\r\n                this.trackedEntity.y - 60,\r\n                this.trackedEntity.vx,\r\n                this.trackedEntity.vy + 2\r\n            );\r\n            this.upperStage.angle = this.trackedEntity.angle;\r\n            this.upperStage.active = true;\r\n            this.upperStage.throttle = 1.0;\r\n            this.entities.push(this.upperStage);\r\n\r\n            this.mainStack = this.upperStage;\r\n            this.trackedEntity = this.upperStage;\r\n\r\n            // Sync globals\r\n            (window as any).mainStack = this.mainStack;\r\n            (window as any).trackedEntity = this.trackedEntity;\r\n            (window as any).booster = this.booster;\r\n\r\n        } else if (this.trackedEntity instanceof UpperStage) {\r\n            if (!this.trackedEntity.fairingsDeployed) {\r\n                // Fairing separation\r\n                this.trackedEntity.fairingsDeployed = true;\r\n                this.missionLog.log(\"FAIRING SEP\", \"info\");\r\n                this.audio.playStaging();\r\n\r\n                const fL = new Fairing(\r\n                    this.trackedEntity.x - 12,\r\n                    this.trackedEntity.y - 40,\r\n                    this.trackedEntity.vx - 10,\r\n                    this.trackedEntity.vy,\r\n                    -1\r\n                );\r\n                fL.angle = this.trackedEntity.angle - 0.5;\r\n                this.entities.push(fL);\r\n\r\n                const fR = new Fairing(\r\n                    this.trackedEntity.x + 12,\r\n                    this.trackedEntity.y - 40,\r\n                    this.trackedEntity.vx + 10,\r\n                    this.trackedEntity.vy,\r\n                    1\r\n                );\r\n                fR.angle = this.trackedEntity.angle + 0.5;\r\n                this.entities.push(fR);\r\n            } else {\r\n                // Payload deployment\r\n                this.missionLog.log(\"PAYLOAD DEP\", \"success\");\r\n                this.audio.playStaging();\r\n\r\n                this.trackedEntity.active = false;\r\n                this.trackedEntity.throttle = 0;\r\n\r\n                const payload = new Payload(\r\n                    this.trackedEntity.x,\r\n                    this.trackedEntity.y - 20,\r\n                    this.trackedEntity.vx,\r\n                    this.trackedEntity.vy + 1\r\n                );\r\n                payload.angle = this.trackedEntity.angle;\r\n                this.entities.push(payload);\r\n\r\n                this.trackedEntity = payload;\r\n                this.mainStack = payload;\r\n                (window as any).trackedEntity = payload;\r\n            }\r\n        }\r\n\r\n        // Update state\r\n        state.entities = this.entities as any;\r\n    }\r\n\r\n    /**\r\n     * Physics update\r\n     */\r\n    private updatePhysics(dt: number): void {\r\n        // Time warp controls\r\n        if (this.input.actions.TIME_WARP_UP && this.timeScale < 100) {\r\n            this.timeScale *= 1.1;\r\n        }\r\n        if (this.input.actions.TIME_WARP_DOWN && this.timeScale > 1) {\r\n            this.timeScale *= 0.9;\r\n        }\r\n\r\n        // Map mode toggle\r\n        if (this.input.actions.MAP_MODE) {\r\n            this.cameraMode = this.cameraMode === 'MAP' ? 'ROCKET' : 'MAP';\r\n            this.input.actions.MAP_MODE = false;\r\n        }\r\n\r\n\r\n        const simDt = dt * this.timeScale;\r\n\r\n        // Update environment system\r\n        this.environment.update(simDt);\r\n\r\n        // Update global wind state for tracked entity's altitude\r\n        if (this.trackedEntity) {\r\n            const alt = (this.groundY - this.trackedEntity.y - this.trackedEntity.h) / PIXELS_PER_METER;\r\n            const envState = this.environment.getState(alt);\r\n            setWindVelocity(envState.windVelocity);\r\n            setDensityMultiplier(envState.densityMultiplier);\r\n\r\n            // Update environment HUD\r\n            this.updateEnvironmentHUD(envState);\r\n\r\n            // Update Mission Control\r\n            this.missionControl.update(simDt, this.missionTime);\r\n        }\r\n\r\n        // Control active vessel\r\n        if (this.mainStack && this.mainStack.active) {\r\n            // Flight Computer control (takes priority when active)\r\n            if (this.flightComputer.isActive()) {\r\n                const fcOutput = this.flightComputer.update(this.mainStack, simDt);\r\n\r\n                // Apply pitch control via angle target\r\n                if (fcOutput.pitchAngle !== null) {\r\n                    // Flight computer controls pitch angle directly\r\n                    // Use SAS in STABILITY mode to achieve target\r\n                    const targetAngle = fcOutput.pitchAngle;\r\n                    const angleError = targetAngle - this.mainStack.angle;\r\n                    // Simple P-control for gimbal\r\n                    this.mainStack.gimbalAngle = Math.max(-0.5, Math.min(0.5, angleError * 2));\r\n                }\r\n\r\n                // Apply throttle control\r\n                if (fcOutput.throttle !== null) {\r\n                    this.mainStack.throttle = fcOutput.throttle;\r\n                }\r\n\r\n                // Handle abort\r\n                if (fcOutput.abort) {\r\n                    this.mainStack.throttle = 0;\r\n                    this.missionLog.log(\"FC: ABORT COMMAND\", \"warn\");\r\n                }\r\n            } else {\r\n                // Manual steering\r\n                const steer = this.input.getSteering();\r\n\r\n                if (Math.abs(steer) > 0.1) {\r\n                    // Manual control\r\n                    this.mainStack.gimbalAngle = steer * 0.4;\r\n                } else if (this.sas.isActive()) {\r\n                    // SAS control\r\n                    const sasOut = this.sas.update(this.mainStack, simDt);\r\n                    this.mainStack.gimbalAngle = sasOut;\r\n                } else {\r\n                    this.mainStack.gimbalAngle = 0;\r\n                }\r\n            }\r\n\r\n            // Throttle (manual always works, even in FC mode for override)\r\n            if (this.input.actions.THROTTLE_UP) {\r\n                this.mainStack.throttle = Math.min(1, this.mainStack.throttle + 0.02 * this.timeScale);\r\n            }\r\n            if (this.input.actions.THROTTLE_DOWN) {\r\n                this.mainStack.throttle = Math.max(0, this.mainStack.throttle - 0.02 * this.timeScale);\r\n            }\r\n            if (this.input.actions.CUT_ENGINE) {\r\n                this.mainStack.throttle = 0;\r\n            }\r\n        }\r\n\r\n        // Update entities\r\n        this.entities.forEach(e => {\r\n            e.applyPhysics(simDt, {});\r\n            e.spawnExhaust(this.timeScale);\r\n        });\r\n\r\n        // Transfer particles from global state\r\n        if (state.particles.length > 0) {\r\n            this.particles.push(...(state.particles as Particle[]));\r\n            state.particles = [];\r\n        }\r\n\r\n        // Mission events\r\n        if (this.trackedEntity) {\r\n            const alt = (this.groundY - this.trackedEntity.y - this.trackedEntity.h) / PIXELS_PER_METER;\r\n            const vel = Math.sqrt(this.trackedEntity.vx ** 2 + this.trackedEntity.vy ** 2);\r\n            const rho = getAtmosphericDensity(alt);\r\n\r\n            this.audio.setThrust(this.trackedEntity.throttle, rho, vel);\r\n\r\n            if (!this.missionState.liftoff && alt > 20) {\r\n                this.missionState.liftoff = true;\r\n                this.missionLog.log(\"LIFTOFF\", \"warn\");\r\n                this.audio.speak(\"Liftoff\");\r\n                // Auto-start black box recording on liftoff\r\n                if (this.blackBox.getState() === 'idle') {\r\n                    this.blackBox.start('Flight');\r\n                }\r\n            }\r\n\r\n            // Record to black box\r\n            if (this.missionState.liftoff) {\r\n                this.missionTime += simDt;\r\n                this.blackBox.record(this.trackedEntity, this.missionTime);\r\n            }\r\n\r\n            // Auto-stop black box on crash\r\n            if (this.trackedEntity.crashed && this.blackBox.isRecording()) {\r\n                this.blackBox.stop('crashed');\r\n            }\r\n\r\n            // Update FTS\r\n            if (this.missionState.liftoff && !this.trackedEntity.crashed) {\r\n                this.fts.update(this.trackedEntity, this.groundY, simDt);\r\n            }\r\n\r\n            // Update Fault Injector\r\n            if (this.trackedEntity instanceof Vessel) {\r\n                this.faultInjector.update(\r\n                    this.trackedEntity,\r\n                    (this.trackedEntity as Vessel).reliability,\r\n                    this.groundY,\r\n                    simDt\r\n                );\r\n            }\r\n        }\r\n\r\n        // Update particles\r\n        for (let i = this.particles.length - 1; i >= 0; i--) {\r\n            const p = this.particles[i];\r\n            if (p) {\r\n                p.update(this.groundY, this.timeScale);\r\n                if (p.isDead()) {\r\n                    this.particles.splice(i, 1);\r\n                }\r\n            }\r\n        }\r\n\r\n        // Sync globals\r\n        (window as any).trackedEntity = this.trackedEntity;\r\n        (window as any).mainStack = this.mainStack;\r\n    }\r\n\r\n    /**\r\n     * Update environment HUD elements\r\n     */\r\n    private updateEnvironmentHUD(envState: import('../physics/Environment').EnvironmentState): void {\r\n        // Optimized: Use cached DOM elements to avoid expensive getElementById calls\r\n        const hudWindSpeed = this.hudWindSpeed;\r\n        const hudWindDir = this.hudWindDir;\r\n        const hudTimeOfDay = this.hudTimeOfDay;\r\n        const hudLaunchStatus = this.hudLaunchStatus;\r\n        const last = this.lastHUDState;\r\n\r\n        if (hudWindSpeed) {\r\n            const speed = Math.round(envState.surfaceWindSpeed);\r\n            if (last.windSpeed !== speed) {\r\n                last.windSpeed = speed;\r\n                hudWindSpeed.textContent = speed + ' m/s';\r\n\r\n                // Color coding based on wind limits\r\n                if (speed > 15) {\r\n                    hudWindSpeed.style.color = UI_COLORS.RED;\r\n                } else if (speed > 10) {\r\n                    hudWindSpeed.style.color = UI_COLORS.YELLOW;\r\n                } else {\r\n                    hudWindSpeed.style.color = UI_COLORS.GREEN;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (hudWindDir) {\r\n            const dirStr = getWindDirectionString(envState.surfaceWindDirection);\r\n            if (last.windDir !== dirStr) {\r\n                last.windDir = dirStr;\r\n                hudWindDir.textContent = dirStr;\r\n            }\r\n        }\r\n\r\n        if (hudTimeOfDay) {\r\n            const timeStr = formatTimeOfDay(envState.timeOfDay);\r\n            if (last.timeOfDay !== timeStr) {\r\n                last.timeOfDay = timeStr;\r\n                hudTimeOfDay.textContent = timeStr;\r\n            }\r\n        }\r\n\r\n        if (hudLaunchStatus) {\r\n            const statusStr = envState.isLaunchSafe ? 'GO' : 'NO GO';\r\n\r\n            if (last.launchStatus !== statusStr) {\r\n                last.launchStatus = statusStr;\r\n                hudLaunchStatus.textContent = statusStr;\r\n\r\n                if (envState.isLaunchSafe) {\r\n                    hudLaunchStatus.style.color = UI_COLORS.GREEN;\r\n                    hudLaunchStatus.className = 'go-status';\r\n                } else {\r\n                    hudLaunchStatus.style.color = UI_COLORS.RED;\r\n                    hudLaunchStatus.className = 'no-go-status';\r\n                }\r\n            }\r\n\r\n            // Add Max-Q warning\r\n            if (envState.maxQWindWarning && !last.maxQWarning) {\r\n                last.maxQWarning = true;\r\n                const hudMaxQ = this.hudMaxQ;\r\n                if (hudMaxQ) {\r\n                    hudMaxQ.textContent = '⚠ HIGH WIND SHEAR';\r\n                    hudMaxQ.style.display = 'block';\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * Update orbit prediction paths\r\n     */\r\n    private updateOrbitPaths(now: number): void {\r\n        const totalEntities = this.entities.length;\r\n        if (totalEntities === 0) return;\r\n\r\n        // Spread updates over ~6 frames (assuming 60fps) or 100ms\r\n        const updateBudget = Math.max(1, Math.ceil(totalEntities / 6));\r\n\r\n        for (let i = 0; i < updateBudget; i++) {\r\n            const index = (this.nextOrbitUpdateIndex + i) % totalEntities;\r\n            const e = this.entities[index];\r\n\r\n            if (!e || e.crashed) continue;\r\n\r\n            // Throttle: minimum 100ms between updates\r\n            if (now - e.lastOrbitUpdate < 100) continue;\r\n\r\n            const alt = (this.groundY - e.y - e.h) / PIXELS_PER_METER;\r\n            let needsUpdate = false;\r\n\r\n            if (e.throttle > 0) needsUpdate = true;\r\n            if (alt < 140000) needsUpdate = true;\r\n            if (now - e.lastOrbitUpdate > 1000) needsUpdate = true;\r\n            if (!e.orbitPath) needsUpdate = true;\r\n\r\n            if (needsUpdate) {\r\n                e.orbitPath = [];\r\n                e.lastOrbitUpdate = now;\r\n\r\n                // Simple orbit prediction\r\n                const simState = {\r\n                    x: e.x / 10,\r\n                    y: e.y / 10,\r\n                    vx: e.vx,\r\n                    vy: e.vy\r\n                };\r\n\r\n                const dtPred = 10;\r\n                const startPhi = simState.x / R_EARTH;\r\n                const startR = R_EARTH + (this.groundY / 10 - simState.y - e.h / 10);\r\n                e.orbitPath.push({ phi: startPhi, r: startR });\r\n\r\n                for (let j = 0; j < 200; j++) {\r\n                    const pAlt = this.groundY / 10 - simState.y - e.h / 10;\r\n                    const pRad = pAlt + R_EARTH;\r\n                    const pG = 9.8 * Math.pow(R_EARTH / pRad, 2);\r\n                    const pFy = pG - (simState.vx ** 2) / pRad;\r\n\r\n                    simState.vy += pFy * dtPred;\r\n                    simState.x += simState.vx * dtPred;\r\n                    simState.y += simState.vy * dtPred;\r\n\r\n                    if (simState.y * 10 > this.groundY) break;\r\n\r\n                    const pPhi = (simState.x * 10) / R_EARTH;\r\n                    const pR = R_EARTH + (this.groundY / 10 - simState.y - e.h / 10);\r\n                    e.orbitPath.push({ phi: pPhi, r: pR });\r\n                }\r\n            }\r\n        }\r\n\r\n        this.nextOrbitUpdateIndex = (this.nextOrbitUpdateIndex + updateBudget) % totalEntities;\r\n    }\r\n\r\n    /**\r\n     * Draw the scene\r\n     */\r\n    private draw(): void {\r\n        if (this.cameraMode === 'MAP') {\r\n            this.drawMapView();\r\n        } else {\r\n            this.drawRocketView();\r\n        }\r\n\r\n        // Draw Mission Control Overlay\r\n        this.missionControl.draw(this.ctx, this.width, this.height);\r\n    }\r\n\r\n    /**\r\n     * Draw orbital map view\r\n     */\r\n    private drawMapView(): void {\r\n        this.ctx.fillStyle = '#000';\r\n        this.ctx.fillRect(0, 0, this.width, this.height);\r\n\r\n        const cx = this.width / 2;\r\n        const cy = this.height / 2;\r\n        const scale = 0.00005;\r\n\r\n        // Draw Earth\r\n        const rEarthPx = R_EARTH * scale;\r\n        this.ctx.fillStyle = '#3498db';\r\n        this.ctx.beginPath();\r\n        this.ctx.arc(cx, cy, rEarthPx, 0, Math.PI * 2);\r\n        this.ctx.fill();\r\n\r\n        // Draw vessels and orbits\r\n        this.entities.forEach(e => {\r\n            if (e.crashed) return;\r\n\r\n            const alt = (this.groundY - e.y - e.h) / PIXELS_PER_METER;\r\n            const r = R_EARTH + alt;\r\n            const phi = e.x / R_EARTH;\r\n\r\n            const ox = cx + Math.cos(phi - Math.PI / 2) * r * scale;\r\n            const oy = cy + Math.sin(phi - Math.PI / 2) * r * scale;\r\n\r\n            // Vessel dot\r\n            this.ctx.fillStyle = e === this.trackedEntity ? '#f1c40f' : '#aaa';\r\n            this.ctx.beginPath();\r\n            this.ctx.arc(ox, oy, 3, 0, Math.PI * 2);\r\n            this.ctx.fill();\r\n\r\n            // Orbit path\r\n            if (e.orbitPath) {\r\n                this.ctx.strokeStyle = this.ctx.fillStyle;\r\n                this.ctx.beginPath();\r\n                e.orbitPath.forEach((p, i) => {\r\n                    const px = cx + Math.cos(p.phi - Math.PI / 2) * p.r * scale;\r\n                    const py = cy + Math.sin(p.phi - Math.PI / 2) * p.r * scale;\r\n                    if (i === 0) {\r\n                        this.ctx.moveTo(px, py);\r\n                    } else {\r\n                        this.ctx.lineTo(px, py);\r\n                    }\r\n                });\r\n                this.ctx.stroke();\r\n            }\r\n        });\r\n\r\n        // Label\r\n        this.ctx.fillStyle = 'white';\r\n        this.ctx.font = '20px monospace';\r\n        this.ctx.fillText(\"MAP MODE\", 20, 40);\r\n    }\r\n\r\n    /**\r\n     * Draw rocket flight view\r\n     */\r\n    private drawRocketView(): void {\r\n        this.ctx.clearRect(0, 0, this.width, this.height);\r\n\r\n        // Sky gradient\r\n        const alt = -this.cameraY;\r\n        const spaceRatio = Math.min(Math.max(alt / 60000, 0), 1);\r\n\r\n        const grd = this.ctx.createLinearGradient(0, 0, 0, this.height);\r\n        const rBot = Math.floor(135 * (1 - spaceRatio));\r\n        const gBot = Math.floor(206 * (1 - spaceRatio));\r\n        const bBot = Math.floor(235 * (1 - spaceRatio));\r\n        const bTop = Math.floor(20 * (1 - spaceRatio));\r\n\r\n        grd.addColorStop(0, `rgb(0, 0, ${bTop})`);\r\n        grd.addColorStop(1, `rgb(${rBot}, ${gBot}, ${bBot})`);\r\n        this.ctx.fillStyle = grd;\r\n        this.ctx.fillRect(0, 0, this.width, this.height);\r\n\r\n        // Camera follow\r\n        if (this.trackedEntity) {\r\n            let targetY = this.trackedEntity.y - this.height * 0.6;\r\n            if (this.cameraMode === 'ROCKET') {\r\n                targetY = this.trackedEntity.y - this.height / 2;\r\n            }\r\n\r\n            if (targetY < 0) {\r\n                this.cameraY += (targetY - this.cameraY) * 0.1;\r\n            } else {\r\n                this.cameraY += (0 - this.cameraY) * 0.1;\r\n            }\r\n\r\n            // Camera shake from dynamic pressure\r\n            const q = this.trackedEntity.q ?? 0;\r\n            const shake = Math.min(q / 200, 10);\r\n            this.cameraShakeX = (Math.random() - 0.5) * shake;\r\n            this.cameraShakeY = (Math.random() - 0.5) * shake;\r\n        }\r\n\r\n        this.ctx.save();\r\n        this.ctx.translate(this.cameraShakeX, -this.cameraY + this.cameraShakeY);\r\n\r\n        // Ground\r\n        this.ctx.fillStyle = '#2ecc71';\r\n        this.ctx.fillRect(-50000, this.groundY, 100000, 500);\r\n\r\n        // Particles\r\n        Particle.drawParticles(this.ctx, this.particles);\r\n\r\n        // Entities\r\n        this.entities.forEach(e => e.draw(this.ctx, 0));\r\n\r\n        this.ctx.restore();\r\n\r\n        // HUD\r\n        this.drawHUD();\r\n    }\r\n\r\n    /**\r\n     * Draw heads-up display\r\n     * Optimized: Uses cached DOM elements to avoid expensive getElementById calls every frame.\r\n     */\r\n    private drawHUD(): void {\r\n        if (!this.trackedEntity) return;\r\n\r\n        const velAngle = Math.atan2(this.trackedEntity.vx, -this.trackedEntity.vy);\r\n        this.navball.draw(this.trackedEntity.angle, velAngle);\r\n\r\n        const alt = (this.groundY - this.trackedEntity.y - this.trackedEntity.h) / PIXELS_PER_METER;\r\n        const vel = Math.sqrt(this.trackedEntity.vx ** 2 + this.trackedEntity.vy ** 2);\r\n\r\n        // Apogee estimate\r\n        const g = 9.8;\r\n        const apogeeEst = alt + (this.trackedEntity.vy < 0\r\n            ? (this.trackedEntity.vy ** 2) / (2 * g)\r\n            : 0);\r\n\r\n        // Update DOM HUD\r\n        const hudAlt = this.hudAlt;\r\n        const hudVel = this.hudVel;\r\n        const hudApogee = this.hudApogee;\r\n        const gaugeFuel = this.gaugeFuel;\r\n        const gaugeThrust = this.gaugeThrust;\r\n        const hudAoa = this.hudAoa;\r\n        const hudStability = this.hudStability;\r\n        const last = this.lastHUDState;\r\n\r\n        if (hudAlt) {\r\n            const altStr = (alt / 1000).toFixed(1);\r\n            if (last.alt !== altStr) {\r\n                last.alt = altStr;\r\n                hudAlt.textContent = altStr;\r\n            }\r\n        }\r\n\r\n        if (hudVel) {\r\n            const velStr = Math.floor(vel).toString();\r\n            if (last.vel !== velStr) {\r\n                last.vel = velStr;\r\n                hudVel.textContent = velStr;\r\n            }\r\n        }\r\n\r\n        if (hudApogee) {\r\n            const apStr = (Math.max(alt, apogeeEst) / 1000).toFixed(1);\r\n            if (last.apogee !== apStr) {\r\n                last.apogee = apStr;\r\n                hudApogee.textContent = apStr;\r\n            }\r\n        }\r\n\r\n        if (gaugeFuel) {\r\n            const fuelPct = this.trackedEntity.fuel;\r\n            // Only update if changed by more than 0.001\r\n            if (Math.abs(last.fuelPct - fuelPct) > 0.001) {\r\n                last.fuelPct = fuelPct;\r\n                gaugeFuel.style.height = (fuelPct * 100) + '%';\r\n            }\r\n        }\r\n\r\n        if (gaugeThrust) {\r\n            const thrustPct = this.trackedEntity.throttle;\r\n            if (Math.abs(last.thrustPct - thrustPct) > 0.001) {\r\n                last.thrustPct = thrustPct;\r\n                gaugeThrust.style.height = (thrustPct * 100) + '%';\r\n            }\r\n        }\r\n\r\n        // Aerodynamic stability display\r\n        if (hudAoa) {\r\n            const aoaDeg = Math.abs(this.trackedEntity.aoa * 180 / Math.PI);\r\n            const aoaStr = aoaDeg.toFixed(1) + '°';\r\n\r\n            if (last.aoa !== aoaStr) {\r\n                last.aoa = aoaStr;\r\n                hudAoa.textContent = aoaStr;\r\n\r\n                // Color coding: green < 5°, yellow 5-15°, red > 15°\r\n                let color = UI_COLORS.GREEN;\r\n                if (aoaDeg > 15) {\r\n                    color = UI_COLORS.RED;\r\n                } else if (aoaDeg > 5) {\r\n                    color = UI_COLORS.YELLOW;\r\n                }\r\n\r\n                if (last.aoaColor !== color) {\r\n                    last.aoaColor = color;\r\n                    hudAoa.style.color = color;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (hudStability) {\r\n            const margin = this.trackedEntity.stabilityMargin;\r\n            let stabStr = '';\r\n            let color = '';\r\n\r\n            if (this.trackedEntity.isAeroStable) {\r\n                stabStr = (margin * 100).toFixed(1) + '%';\r\n                color = UI_COLORS.GREEN;\r\n            } else {\r\n                stabStr = 'UNSTABLE';\r\n                color = UI_COLORS.RED;\r\n            }\r\n\r\n            if (last.stability !== stabStr) {\r\n                last.stability = stabStr;\r\n                hudStability.textContent = stabStr;\r\n            }\r\n\r\n            if (last.stabilityColor !== color) {\r\n                last.stabilityColor = color;\r\n                hudStability.style.color = color;\r\n            }\r\n        }\r\n\r\n        // Thermal protection system display\r\n        const hudSkinTemp = this.hudSkinTemp;\r\n        const hudTpsStatus = this.hudTpsStatus;\r\n\r\n        if (hudSkinTemp) {\r\n            // Convert from Kelvin to Celsius\r\n            const tempC = Math.round(this.trackedEntity.skinTemp - 273.15);\r\n            const tempStr = tempC + '°C';\r\n\r\n            if (last.skinTemp !== tempStr) {\r\n                last.skinTemp = tempStr;\r\n                hudSkinTemp.textContent = tempStr;\r\n\r\n                let color = UI_COLORS.GREEN;\r\n                // Color coding based on temperature ratio to max\r\n                if (this.trackedEntity.isThermalCritical) {\r\n                    color = UI_COLORS.RED;  // Red - critical\r\n                } else if (tempC > 400) {\r\n                    color = UI_COLORS.ORANGE;  // Orange - warning\r\n                } else if (tempC > 200) {\r\n                    color = UI_COLORS.YELLOW;  // Yellow - elevated\r\n                }\r\n\r\n                if (last.skinTempColor !== color) {\r\n                    last.skinTempColor = color;\r\n                    hudSkinTemp.style.color = color;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (hudTpsStatus) {\r\n            const shieldPct = Math.round(this.trackedEntity.heatShieldRemaining * 100);\r\n            let statusStr = '';\r\n            let color = '';\r\n\r\n            if (shieldPct > 0) {\r\n                statusStr = shieldPct + '%';\r\n                if (this.trackedEntity.isAblating) {\r\n                    color = UI_COLORS.ORANGE;  // Orange when ablating\r\n                } else if (shieldPct < 30) {\r\n                    color = UI_COLORS.RED;  // Red when low\r\n                } else {\r\n                    color = UI_COLORS.GREEN;  // Green\r\n                }\r\n            } else {\r\n                statusStr = 'N/A';\r\n                color = UI_COLORS.GRAY;  // Gray when no TPS\r\n            }\r\n\r\n            if (last.tpsStatus !== statusStr) {\r\n                last.tpsStatus = statusStr;\r\n                hudTpsStatus.textContent = statusStr;\r\n            }\r\n\r\n            if (last.tpsStatusColor !== color) {\r\n                last.tpsStatusColor = color;\r\n                hudTpsStatus.style.color = color;\r\n            }\r\n        }\r\n\r\n        // Propulsion system display\r\n        const hudEngineStatus = this.hudEngineStatus;\r\n        const hudIgniters = this.hudIgniters;\r\n\r\n        if (hudEngineStatus) {\r\n            const state = this.trackedEntity.engineState;\r\n            let statusStr = '';\r\n            let color = '';\r\n\r\n            switch (state) {\r\n                case 'off':\r\n                    statusStr = 'OFF';\r\n                    color = UI_COLORS.GRAY;\r\n                    break;\r\n                case 'starting':\r\n                    statusStr = 'SPOOL';\r\n                    color = UI_COLORS.YELLOW;\r\n                    break;\r\n                case 'running':\r\n                    statusStr = 'RUN';\r\n                    color = UI_COLORS.GREEN;\r\n                    break;\r\n                case 'shutdown':\r\n                    statusStr = 'STOP';\r\n                    color = UI_COLORS.ORANGE;\r\n                    break;\r\n            }\r\n\r\n            if (last.engineStatus !== statusStr) {\r\n                last.engineStatus = statusStr;\r\n                hudEngineStatus.textContent = statusStr;\r\n            }\r\n\r\n            if (last.engineStatusColor !== color) {\r\n                last.engineStatusColor = color;\r\n                hudEngineStatus.style.color = color;\r\n            }\r\n        }\r\n\r\n        if (hudIgniters) {\r\n            const count = this.trackedEntity.ignitersRemaining;\r\n            if (last.igniters !== count) {\r\n                last.igniters = count;\r\n                hudIgniters.textContent = count.toString();\r\n\r\n                let color = '';\r\n                if (count === 0) {\r\n                    color = UI_COLORS.RED;  // Red - no restarts\r\n                } else if (count === 1) {\r\n                    color = UI_COLORS.ORANGE;  // Orange - last one\r\n                } else {\r\n                    color = UI_COLORS.GREEN;  // Green\r\n                }\r\n\r\n                if (last.ignitersColor !== color) {\r\n                    last.ignitersColor = color;\r\n                    hudIgniters.style.color = color;\r\n                }\r\n            }\r\n        }\r\n\r\n        // FTS Status display\r\n        const hudFtsState = this.hudFtsState;\r\n        if (hudFtsState) {\r\n            const ftsStatus = this.fts.getStatus();\r\n            let ftsStr: string = ftsStatus.state;\r\n            let ftsColor = '';\r\n\r\n            switch (ftsStatus.state) {\r\n                case 'SAFE':\r\n                    ftsColor = UI_COLORS.GREEN;\r\n                    break;\r\n                case 'WARNING':\r\n                    ftsStr = `WARN ${(this.fts.config.warningDurationS - ftsStatus.warningTimer).toFixed(0)}s`;\r\n                    ftsColor = UI_COLORS.YELLOW;\r\n                    break;\r\n                case 'ARM':\r\n                    ftsStr = ftsStatus.armed ? 'ARMED' : 'ARM';\r\n                    ftsColor = UI_COLORS.ORANGE;\r\n                    break;\r\n                case 'DESTRUCT':\r\n                    ftsStr = 'DESTRUCT';\r\n                    ftsColor = UI_COLORS.RED;\r\n                    break;\r\n            }\r\n\r\n            if (last.ftsState !== ftsStr) {\r\n                last.ftsState = ftsStr;\r\n                hudFtsState.textContent = ftsStr;\r\n            }\r\n\r\n            if (last.ftsStateColor !== ftsColor) {\r\n                last.ftsStateColor = ftsColor;\r\n                hudFtsState.style.color = ftsColor;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Main animation loop\r\n     */\r\n    private animate(currentTime: number): void {\r\n        if (!this.lastTime) this.lastTime = currentTime;\r\n\r\n        const deltaTime = Math.min((currentTime - this.lastTime) / 1000, 0.1);\r\n        this.lastTime = currentTime;\r\n        this.accumulator += deltaTime;\r\n\r\n        // Fixed timestep physics\r\n        while (this.accumulator >= this.FIXED_DT) {\r\n            this.updatePhysics(this.FIXED_DT);\r\n            this.accumulator -= this.FIXED_DT;\r\n        }\r\n\r\n        if (this.cameraMode === 'MAP') {\r\n            this.updateOrbitPaths(currentTime);\r\n        }\r\n\r\n        this.draw();\r\n\r\n        requestAnimationFrame((t) => this.animate(t));\r\n    }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\core\\InputManager.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\core\\SimulationStore.ts","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":132,"column":17,"messageId":"unexpected","endLine":132,"endColumn":63,"suggestions":[{"messageId":"addBrackets","fix":{"range":[4488,4739],"text":"{ const { width, height, groundY } = this.state;\r\n                this.state = {\r\n                    ...SimulationStore.INITIAL_STATE,\r\n                    width, height, groundY // Preserve window dimensions\r\n                };\r\n                break; }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { IVessel, Vec2 } from '../types';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface GameState {\r\n    // Dimensions\r\n    width: number;\r\n    height: number;\r\n    groundY: number;\r\n\r\n    // Entities\r\n    entities: IVessel[];\r\n    activeVesselId: string | null;\r\n\r\n    // Mission State\r\n    missionTime: number;\r\n    liftoff: boolean;\r\n    stageNumber: number;\r\n\r\n    // Environment\r\n    windVelocity: Vec2;\r\n    atmosphericDensityMultiplier: number;\r\n\r\n    // System State\r\n    paused: boolean;\r\n    timeScale: number;\r\n    autopilotEnabled: boolean;\r\n}\r\n\r\nexport type Action =\r\n    | { type: 'SET_DIMENSIONS'; width: number; height: number; groundY: number }\r\n    | { type: 'ADD_ENTITY'; entity: IVessel }\r\n    | { type: 'REMOVE_ENTITY'; entity: IVessel }\r\n    | { type: 'SET_ACTIVE_VESSEL'; id: string }\r\n    | { type: 'UPDATE_PHYSICS'; time: number; entities: IVessel[] }  // Bulk update\r\n    | { type: 'SET_WIND'; velocity: Vec2 }\r\n    | { type: 'SET_DENSITY_MULTIPLIER'; multiplier: number }\r\n    | { type: 'SET_AUTOPILOT'; enabled: boolean }\r\n    | { type: 'SET_PAUSED'; paused: boolean }\r\n    | { type: 'SET_TIME_SCALE'; scale: number }\r\n    | { type: 'LIFTOFF' }\r\n    | { type: 'STAGE_SEPARATION' }\r\n    | { type: 'RESET' };\r\n\r\ntype Listener = () => void;\r\n\r\n// ============================================================================\r\n// Simulation Store\r\n// ============================================================================\r\n\r\nexport class SimulationStore {\r\n    private state: GameState;\r\n    private listeners: Set<Listener> = new Set();\r\n\r\n    // Initial state matching the existing global state defaults\r\n    private static readonly INITIAL_STATE: GameState = {\r\n        width: 1920,\r\n        height: 1080,\r\n        groundY: 1000,\r\n        entities: [],\r\n        activeVesselId: null,\r\n        missionTime: 0,\r\n        liftoff: false,\r\n        stageNumber: 0,\r\n        windVelocity: { x: 0, y: 0 },\r\n        atmosphericDensityMultiplier: 1.0,\r\n        paused: false,\r\n        timeScale: 1.0,\r\n        autopilotEnabled: false\r\n    };\r\n\r\n    constructor() {\r\n        this.state = { ...SimulationStore.INITIAL_STATE };\r\n    }\r\n\r\n    /**\r\n     * Component-Entity-System style retrieval\r\n     * But for now, just basic state access to replace global object.\r\n     */\r\n\r\n    getState(): Readonly<GameState> {\r\n        return this.state;\r\n    }\r\n\r\n    dispatch(action: Action): void {\r\n        switch (action.type) {\r\n            case 'SET_DIMENSIONS':\r\n                this.state.width = action.width;\r\n                this.state.height = action.height;\r\n                this.state.groundY = action.groundY;\r\n                break;\r\n            case 'ADD_ENTITY':\r\n                this.state.entities.push(action.entity);\r\n                break;\r\n            case 'REMOVE_ENTITY':\r\n                this.state.entities = this.state.entities.filter(e => e !== action.entity);\r\n                break;\r\n            case 'SET_ACTIVE_VESSEL':\r\n                this.state.activeVesselId = action.id;\r\n                break;\r\n            case 'UPDATE_PHYSICS':\r\n                this.state.missionTime = action.time;\r\n                // Entities updated by reference usually in physics loop, \r\n                // but if we were strictly immutable we'd replace them.\r\n                // For performance/hybrid approach, we might just trigger listeners.\r\n                break;\r\n            case 'SET_WIND':\r\n                this.state.windVelocity = action.velocity;\r\n                break;\r\n            case 'SET_DENSITY_MULTIPLIER':\r\n                this.state.atmosphericDensityMultiplier = action.multiplier;\r\n                break;\r\n            case 'SET_AUTOPILOT':\r\n                this.state.autopilotEnabled = action.enabled;\r\n                break;\r\n            case 'SET_PAUSED':\r\n                this.state.paused = action.paused;\r\n                break;\r\n            case 'SET_TIME_SCALE':\r\n                this.state.timeScale = action.scale;\r\n                break;\r\n            case 'LIFTOFF':\r\n                this.state.liftoff = true;\r\n                break;\r\n            case 'STAGE_SEPARATION':\r\n                this.state.stageNumber++;\r\n                break;\r\n            case 'RESET':\r\n                // Reset but keep dimensions might be desired, but strict reset goes to initial.\r\n                const { width, height, groundY } = this.state;\r\n                this.state = {\r\n                    ...SimulationStore.INITIAL_STATE,\r\n                    width, height, groundY // Preserve window dimensions\r\n                };\r\n                break;\r\n        }\r\n\r\n        this.notify();\r\n    }\r\n\r\n    subscribe(listener: Listener): () => void {\r\n        this.listeners.add(listener);\r\n        return () => this.listeners.delete(listener);\r\n    }\r\n\r\n    private notify(): void {\r\n        this.listeners.forEach(l => l());\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\guidance\\FlightComputer.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SAS' is defined but never used.","line":17,"column":10,"messageId":"unusedVar","endLine":17,"endColumn":13,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"SAS"},"fix":{"range":[533,573],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ScriptCommand' is defined but never used.","line":20,"column":10,"messageId":"unusedVar","endLine":20,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ScriptCommand"},"fix":{"range":[605,630],"text":""},"desc":"Remove unused variable \"ScriptCommand\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ConditionClause' is defined but never used.","line":23,"column":10,"messageId":"unusedVar","endLine":23,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ConditionClause"},"fix":{"range":[681,708],"text":""},"desc":"Remove unused variable \"ConditionClause\"."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":394,"column":17,"messageId":"unexpected","endLine":394,"endColumn":57,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13085,13212],"text":"{ const pitchDeg = action.value as number;\r\n                output.pitchAngle = pitchDeg * Math.PI / 180;\r\n                break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":408,"column":17,"messageId":"unexpected","endLine":408,"endColumn":63,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13514,13710],"text":"{ const sasValue = action.value as SASModeValue;\r\n                output.sasMode = SASMode[sasValue];\r\n                if (this.onSASChange) this.onSASChange(output.sasMode);\r\n                break; }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * FlightComputer - Autonomous Guidance & Navigation System\r\n * \r\n * Executes mission scripts to control the rocket autonomously.\r\n * Evaluates conditions against current telemetry and executes actions.\r\n * \r\n * Usage:\r\n *   const fc = new FlightComputer();\r\n *   fc.loadScript(scriptText);\r\n *   fc.activate();\r\n *   // In game loop:\r\n *   fc.update(vessel, dt);\r\n */\r\n\r\nimport { type IVessel, SASMode } from '../types/index.ts';\r\nimport { PIXELS_PER_METER, getAtmosphericDensity, getDynamicPressure } from '../constants.ts';\r\nimport { SAS } from '../utils/SAS.ts';\r\nimport {\r\n    type MissionScript,\r\n    type ScriptCommand,\r\n    type ScriptCondition,\r\n    type ScriptAction,\r\n    type ConditionClause,\r\n    type ComparisonOperator,\r\n    type ConditionVariable,\r\n    parseMissionScript,\r\n    resetScript,\r\n    type SASModeValue\r\n} from './FlightScript.ts';\r\n\r\n// ============================================================================\r\n// Flight Computer Modes\r\n// ============================================================================\r\n\r\nexport type FlightComputerMode = 'OFF' | 'STANDBY' | 'RUNNING' | 'PAUSED' | 'COMPLETE';\r\n\r\n// ============================================================================\r\n// Execution State\r\n// ============================================================================\r\n\r\nexport interface FlightComputerState {\r\n    mode: FlightComputerMode;\r\n    script: MissionScript | null;\r\n    activeCommandIndex: number;\r\n    elapsedTime: number;           // Seconds since activation\r\n    lastTriggeredCommand: string | null;\r\n    targetPitch: number | null;    // Current pitch target (degrees)\r\n    targetThrottle: number | null; // Current throttle target (0-1)\r\n}\r\n\r\n// ============================================================================\r\n// Output Commands\r\n// ============================================================================\r\n\r\nexport interface FlightComputerOutput {\r\n    pitchAngle: number | null;     // Desired pitch in radians (from vertical)\r\n    throttle: number | null;       // Desired throttle (0-1)\r\n    stage: boolean;                // Should trigger staging\r\n    sasMode: SASMode | null;       // SAS mode to set\r\n    abort: boolean;                // Emergency abort\r\n}\r\n\r\n// ============================================================================\r\n// Flight Computer Class\r\n// ============================================================================\r\n\r\nexport class FlightComputer {\r\n    /** Current state */\r\n    public state: FlightComputerState;\r\n\r\n    /** Ground level Y position for altitude calculation */\r\n    private groundY: number;\r\n\r\n    /** Callback for staging */\r\n    public onStage: (() => void) | null = null;\r\n\r\n    /** Callback for SAS mode change */\r\n    public onSASChange: ((mode: SASMode) => void) | null = null;\r\n\r\n    /**\r\n     * Create a new Flight Computer\r\n     */\r\n    constructor(groundY: number) {\r\n        this.groundY = groundY;\r\n        this.state = this.createInitialState();\r\n    }\r\n\r\n    /**\r\n     * Create initial state\r\n     */\r\n    private createInitialState(): FlightComputerState {\r\n        return {\r\n            mode: 'OFF',\r\n            script: null,\r\n            activeCommandIndex: -1,\r\n            elapsedTime: 0,\r\n            lastTriggeredCommand: null,\r\n            targetPitch: null,\r\n            targetThrottle: null\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Load and parse a mission script\r\n     */\r\n    loadScript(scriptText: string, name: string = 'Mission Script'): { success: boolean; errors: string[] } {\r\n        const result = parseMissionScript(scriptText, name);\r\n\r\n        if (result.success && result.script) {\r\n            this.state.script = result.script;\r\n            this.state.mode = 'STANDBY';\r\n            this.state.activeCommandIndex = -1;\r\n            this.state.elapsedTime = 0;\r\n            return { success: true, errors: [] };\r\n        }\r\n\r\n        const errors = result.errors.map(e => `Line ${e.line}: ${e.error}`);\r\n        return { success: false, errors };\r\n    }\r\n\r\n    /**\r\n     * Load a pre-parsed script\r\n     */\r\n    loadParsedScript(script: MissionScript): void {\r\n        resetScript(script);\r\n        this.state.script = script;\r\n        this.state.mode = 'STANDBY';\r\n        this.state.activeCommandIndex = -1;\r\n        this.state.elapsedTime = 0;\r\n    }\r\n\r\n    /**\r\n     * Activate the flight computer\r\n     */\r\n    activate(): void {\r\n        if (this.state.script && this.state.script.commands.length > 0) {\r\n            this.state.mode = 'RUNNING';\r\n            this.state.elapsedTime = 0;\r\n            resetScript(this.state.script);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Deactivate the flight computer\r\n     */\r\n    deactivate(): void {\r\n        this.state.mode = 'OFF';\r\n        this.state.targetPitch = null;\r\n        this.state.targetThrottle = null;\r\n    }\r\n\r\n    /**\r\n     * Pause/resume the flight computer\r\n     */\r\n    togglePause(): void {\r\n        if (this.state.mode === 'RUNNING') {\r\n            this.state.mode = 'PAUSED';\r\n        } else if (this.state.mode === 'PAUSED') {\r\n            this.state.mode = 'RUNNING';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Toggle flight computer on/off\r\n     */\r\n    toggle(): void {\r\n        if (this.state.mode === 'OFF' || this.state.mode === 'STANDBY') {\r\n            this.activate();\r\n        } else {\r\n            this.deactivate();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if flight computer is active\r\n     */\r\n    isActive(): boolean {\r\n        return this.state.mode === 'RUNNING';\r\n    }\r\n\r\n    /**\r\n     * Get current status string for HUD display\r\n     */\r\n    getStatusString(): string {\r\n        switch (this.state.mode) {\r\n            case 'OFF': return 'FC: OFF';\r\n            case 'STANDBY': return 'FC: READY';\r\n            case 'RUNNING': return 'FC: ACTIVE';\r\n            case 'PAUSED': return 'FC: PAUSED';\r\n            case 'COMPLETE': return 'FC: DONE';\r\n            default: return 'FC: ---';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get active command text for HUD display\r\n     */\r\n    getActiveCommandText(): string {\r\n        if (!this.state.script || this.state.mode !== 'RUNNING') {\r\n            return '';\r\n        }\r\n\r\n        // Find the most recently triggered command that isn't a one-shot\r\n        const activeCommands = this.state.script.commands.filter(\r\n            cmd => cmd.state === 'active' || cmd.state === 'completed'\r\n        );\r\n\r\n        if (activeCommands.length === 0) {\r\n            return 'Waiting...';\r\n        }\r\n\r\n        const last = activeCommands[activeCommands.length - 1];\r\n        if (!last) {\r\n            return 'Waiting...';\r\n        }\r\n        return last.rawText.substring(0, 40) + (last.rawText.length > 40 ? '...' : '');\r\n    }\r\n\r\n    /**\r\n     * Update flight computer and get output commands\r\n     */\r\n    update(vessel: IVessel, dt: number): FlightComputerOutput {\r\n        const output: FlightComputerOutput = {\r\n            pitchAngle: null,\r\n            throttle: null,\r\n            stage: false,\r\n            sasMode: null,\r\n            abort: false\r\n        };\r\n\r\n        // Only process when running\r\n        if (this.state.mode !== 'RUNNING' || !this.state.script) {\r\n            return output;\r\n        }\r\n\r\n        // Update elapsed time\r\n        this.state.elapsedTime += dt;\r\n\r\n        // Calculate telemetry values\r\n        const telemetry = this.calculateTelemetry(vessel);\r\n\r\n        // Evaluate each command\r\n        for (const command of this.state.script.commands) {\r\n            // Skip completed one-shot commands\r\n            if (command.state === 'completed' && command.oneShot) {\r\n                continue;\r\n            }\r\n\r\n            // Evaluate condition\r\n            const conditionMet = this.evaluateCondition(command.condition, telemetry);\r\n\r\n            if (conditionMet) {\r\n                // Execute action\r\n                const actionResult = this.executeAction(command.action);\r\n\r\n                // Merge into output\r\n                if (actionResult.pitchAngle !== null) {\r\n                    output.pitchAngle = actionResult.pitchAngle;\r\n                    this.state.targetPitch = actionResult.pitchAngle * 180 / Math.PI;\r\n                }\r\n                if (actionResult.throttle !== null) {\r\n                    output.throttle = actionResult.throttle;\r\n                    this.state.targetThrottle = actionResult.throttle;\r\n                }\r\n                if (actionResult.stage) output.stage = true;\r\n                if (actionResult.sasMode !== null) output.sasMode = actionResult.sasMode;\r\n                if (actionResult.abort) output.abort = true;\r\n\r\n                // Update command state\r\n                if (command.oneShot) {\r\n                    command.state = 'completed';\r\n                    this.state.lastTriggeredCommand = command.rawText;\r\n                } else {\r\n                    command.state = 'active';\r\n                }\r\n            } else if (!command.oneShot && command.state === 'active') {\r\n                // Continuous command no longer satisfied\r\n                command.state = 'pending';\r\n            }\r\n        }\r\n\r\n        // Apply stored targets if no new commands\r\n        if (output.pitchAngle === null && this.state.targetPitch !== null) {\r\n            output.pitchAngle = this.state.targetPitch * Math.PI / 180;\r\n        }\r\n        if (output.throttle === null && this.state.targetThrottle !== null) {\r\n            output.throttle = this.state.targetThrottle;\r\n        }\r\n\r\n        // Check if all commands are complete\r\n        const allComplete = this.state.script.commands.every(\r\n            cmd => cmd.state === 'completed' || (!cmd.oneShot && cmd.state !== 'pending')\r\n        );\r\n        if (allComplete && this.state.script.commands.length > 0) {\r\n            // Keep running but mark as complete for display\r\n            // this.state.mode = 'COMPLETE';\r\n        }\r\n\r\n        return output;\r\n    }\r\n\r\n    /**\r\n     * Calculate telemetry values from vessel state\r\n     */\r\n    private calculateTelemetry(vessel: IVessel): Record<ConditionVariable, number> {\r\n        const alt = (this.groundY - vessel.y - vessel.h) / PIXELS_PER_METER;\r\n        const vx = vessel.vx;\r\n        const vy = vessel.vy;\r\n        const speed = Math.sqrt(vx * vx + vy * vy);\r\n\r\n        // Estimate apogee (simple ballistic calculation)\r\n        const g = 9.8;\r\n        const apogee = alt + (vy < 0 ? (vy * vy) / (2 * g) : 0);\r\n\r\n        // Dynamic pressure\r\n        const rho = getAtmosphericDensity(alt);\r\n        const q = getDynamicPressure(rho, speed) / 1000; // kPa\r\n\r\n        return {\r\n            'ALTITUDE': alt,\r\n            'VELOCITY': speed,\r\n            'VERTICAL_VEL': -vy,  // Positive = up\r\n            'HORIZONTAL_VEL': Math.abs(vx),\r\n            'APOGEE': apogee,\r\n            'FUEL': vessel.fuel,\r\n            'TIME': this.state.elapsedTime,\r\n            'THROTTLE': vessel.throttle,\r\n            'DYNAMIC_PRESSURE': q\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Evaluate a condition against telemetry values\r\n     */\r\n    private evaluateCondition(condition: ScriptCondition, telemetry: Record<ConditionVariable, number>): boolean {\r\n        const results: boolean[] = [];\r\n\r\n        for (const clause of condition.clauses) {\r\n            const value = telemetry[clause.variable];\r\n            const result = this.evaluateComparison(value, clause.operator, clause.value);\r\n            results.push(result);\r\n        }\r\n\r\n        // Combine results using logical operators\r\n        if (results.length === 1) {\r\n            return results[0] ?? false;\r\n        }\r\n\r\n        let combined = results[0] ?? false;\r\n        for (let i = 0; i < condition.logicalOperators.length; i++) {\r\n            const op = condition.logicalOperators[i];\r\n            const nextResult = results[i + 1] ?? false;\r\n\r\n            if (op === 'AND') {\r\n                combined = combined && nextResult;\r\n            } else if (op === 'OR') {\r\n                combined = combined || nextResult;\r\n            }\r\n        }\r\n\r\n        return combined;\r\n    }\r\n\r\n    /**\r\n     * Evaluate a single comparison\r\n     */\r\n    private evaluateComparison(actual: number, operator: ComparisonOperator, expected: number): boolean {\r\n        switch (operator) {\r\n            case '>': return actual > expected;\r\n            case '<': return actual < expected;\r\n            case '>=': return actual >= expected;\r\n            case '<=': return actual <= expected;\r\n            case '==': return Math.abs(actual - expected) < 0.001;\r\n            case '!=': return Math.abs(actual - expected) >= 0.001;\r\n            default: return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Execute an action and return the output\r\n     */\r\n    private executeAction(action: ScriptAction): FlightComputerOutput {\r\n        const output: FlightComputerOutput = {\r\n            pitchAngle: null,\r\n            throttle: null,\r\n            stage: false,\r\n            sasMode: null,\r\n            abort: false\r\n        };\r\n\r\n        switch (action.type) {\r\n            case 'PITCH':\r\n                // Convert degrees to radians\r\n                const pitchDeg = action.value as number;\r\n                output.pitchAngle = pitchDeg * Math.PI / 180;\r\n                break;\r\n\r\n            case 'THROTTLE':\r\n                output.throttle = action.value as number;\r\n                break;\r\n\r\n            case 'STAGE':\r\n                output.stage = true;\r\n                if (this.onStage) this.onStage();\r\n                break;\r\n\r\n            case 'SAS':\r\n                const sasValue = action.value as SASModeValue;\r\n                output.sasMode = SASMode[sasValue];\r\n                if (this.onSASChange) this.onSASChange(output.sasMode);\r\n                break;\r\n\r\n            case 'ABORT':\r\n                output.abort = true;\r\n                output.throttle = 0;\r\n                break;\r\n        }\r\n\r\n        return output;\r\n    }\r\n\r\n    /**\r\n     * Get script command count\r\n     */\r\n    getCommandCount(): number {\r\n        return this.state.script?.commands.length ?? 0;\r\n    }\r\n\r\n    /**\r\n     * Get completed command count\r\n     */\r\n    getCompletedCount(): number {\r\n        if (!this.state.script) return 0;\r\n        return this.state.script.commands.filter(c => c.state === 'completed').length;\r\n    }\r\n}\r\n\r\n// ============================================================================\r\n// Preset Mission Scripts\r\n// ============================================================================\r\n\r\nexport const PRESET_SCRIPTS = {\r\n    'Gravity Turn to 100km': `# Gravity Turn to 100km Orbit\r\n# Standard ascent profile\r\n\r\nWHEN ALTITUDE > 100 THEN PITCH 85\r\nWHEN ALTITUDE > 1000 THEN PITCH 80\r\nWHEN ALTITUDE > 3000 THEN PITCH 75\r\nWHEN ALTITUDE > 5000 THEN PITCH 70\r\nWHEN ALTITUDE > 8000 THEN PITCH 65\r\nWHEN ALTITUDE > 12000 THEN PITCH 60\r\nWHEN ALTITUDE > 18000 THEN PITCH 55\r\nWHEN ALTITUDE > 25000 THEN PITCH 50\r\nWHEN ALTITUDE > 35000 THEN PITCH 45\r\nWHEN ALTITUDE > 50000 THEN PITCH 30\r\nWHEN ALTITUDE > 70000 THEN PITCH 10\r\nWHEN APOGEE > 100000 THEN THROTTLE 0\r\n`,\r\n\r\n    'Suborbital Hop': `# Suborbital Hop\r\n# Simple up and down trajectory\r\n\r\nWHEN ALTITUDE > 100 THEN PITCH 90\r\nWHEN ALTITUDE > 30000 THEN THROTTLE 50\r\nWHEN ALTITUDE > 50000 THEN THROTTLE 0\r\nWHEN VERTICAL_VEL < -100 THEN SAS RETROGRADE\r\n`,\r\n\r\n    'Booster Return': `# Booster Return Profile\r\n# For first stage recovery\r\n\r\nWHEN ALTITUDE > 100 THEN PITCH 85\r\nWHEN ALTITUDE > 5000 THEN PITCH 70\r\nWHEN ALTITUDE > 15000 THEN PITCH 45\r\nWHEN FUEL < 0.3 THEN STAGE\r\nWHEN VERTICAL_VEL < -50 THEN SAS RETROGRADE\r\nWHEN ALTITUDE < 5000 AND VERTICAL_VEL < -100 THEN THROTTLE 100\r\n`\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\guidance\\FlightScript.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\main.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FullStack' is defined but never used.","line":12,"column":10,"messageId":"unusedVar","endLine":12,"endColumn":19,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"FullStack"},"fix":{"range":[321,378],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Main Entry Point\r\n * \r\n * Initializes the game and sets up UI event listeners.\r\n * This is the entry point for the bundled application.\r\n */\r\n\r\nimport { Game } from './core/Game';\r\nimport { CONFIG, PIXELS_PER_METER } from './constants';\r\nimport { state } from './state';\r\nimport { SASModes } from './utils/SAS';\r\nimport { FullStack } from './physics/RocketComponents';\r\nimport { ScriptEditor } from './ui/ScriptEditor';\r\nimport { exportFlightData } from './telemetry/TelemetryExporter';\r\nimport { VABEditor } from './ui/VABEditor';\r\nimport { VehicleBlueprint, calculateStats } from './vab/VehicleBlueprint';\r\nimport { Vessel } from './physics/Vessel';\r\n\r\n// Create and initialize game\r\nconst game = new Game();\r\ngame.init();\r\n\r\n// UI Cache for optimized updates\r\nconst uiCache = {\r\n    fcStatus: null as HTMLElement | null,\r\n    launchBtn: null as HTMLElement | null,\r\n    bbStatus: null as HTMLElement | null,\r\n    sasModeText: null as HTMLElement | null,\r\n    tooltipOverlay: null as HTMLElement | null\r\n};\r\n\r\nfunction initUI() {\r\n    uiCache.fcStatus = document.getElementById('fc-status');\r\n    uiCache.launchBtn = document.getElementById('launch-btn');\r\n    uiCache.bbStatus = document.getElementById('bb-status');\r\n    uiCache.sasModeText = document.getElementById('sas-mode-text');\r\n    uiCache.tooltipOverlay = document.getElementById('tooltip-overlay');\r\n}\r\ninitUI();\r\n\r\n// Create Script Editor UI for Flight Computer\r\nconst scriptEditor = new ScriptEditor(game.flightComputer);\r\n\r\n// Create VAB Editor with launch callback\r\nconst vabEditor = new VABEditor('vab-modal', (blueprint: VehicleBlueprint) => {\r\n    // Apply blueprint stats to CONFIG for now (future: ModularVessel)\r\n    const stats = calculateStats(blueprint);\r\n    CONFIG.FUEL_MASS = stats.fuelMass;\r\n\r\n    // Hide splash and reset\r\n    const splashScreen = document.getElementById('splash-screen');\r\n    if (splashScreen) splashScreen.style.display = 'none';\r\n\r\n    game.reset();\r\n    game.missionLog.log(`${blueprint.name} configured - ΔV: ${stats.totalDeltaV.toFixed(0)} m/s`, \"info\");\r\n    showOnboarding();\r\n});\r\n\r\n// ========================================\r\n// UI/UX IMPROVEMENTS - Event Listeners\r\n// ========================================\r\n\r\n// Track flight phase for dynamic buttons\r\nlet flightPhase: 'prelaunch' | 'ascending' | 'descending' | 'landed' = 'prelaunch';\r\n\r\n// --- IMPROVEMENT #7: Onboarding System ---\r\nfunction showOnboarding(): void {\r\n    if (localStorage.getItem('onboarding-complete')) return;\r\n    const overlay = uiCache.tooltipOverlay;\r\n    if (overlay) overlay.classList.add('visible');\r\n}\r\n\r\ndocument.getElementById('tooltip-dismiss')?.addEventListener('click', () => {\r\n    const overlay = uiCache.tooltipOverlay;\r\n    if (overlay) overlay.classList.remove('visible');\r\n    localStorage.setItem('onboarding-complete', 'true');\r\n});\r\n\r\n// --- Splash Screen Buttons ---\r\ndocument.getElementById('start-btn')?.addEventListener('click', () => {\r\n    const splash = document.getElementById('splash-screen');\r\n    if (splash) splash.style.display = 'none';\r\n    game.missionLog.log(\"Mission Control Active\", \"info\");\r\n    showOnboarding();\r\n});\r\n\r\ndocument.getElementById('open-vab-btn')?.addEventListener('click', () => {\r\n    vabEditor.show();\r\n});\r\n\r\n// --- IMPROVEMENT #2: Dynamic Action Buttons ---\r\nfunction updateActionButton(): void {\r\n    const btn = uiCache.launchBtn;\r\n    if (!btn || !game.trackedEntity) return;\r\n\r\n    const alt = (state.groundY - game.trackedEntity.y - game.trackedEntity.h) / PIXELS_PER_METER;\r\n    const vy = game.trackedEntity.vy;\r\n\r\n    if (game.trackedEntity.throttle === 0 && alt < 100) {\r\n        // Pre-launch\r\n        btn.textContent = '🚀 INITIATE LAUNCH';\r\n        btn.className = 'primary state-launch';\r\n        flightPhase = 'prelaunch';\r\n    } else if (vy < 0) {\r\n        // Ascending\r\n        btn.textContent = '🛑 ABORT MISSION';\r\n        btn.className = 'primary state-abort';\r\n        flightPhase = 'ascending';\r\n    } else if (vy > 0 && alt > 1000) {\r\n        // Descending from high altitude\r\n        btn.textContent = '🦿 DEPLOY LEGS';\r\n        btn.className = 'primary state-deploy';\r\n        flightPhase = 'descending';\r\n    }\r\n}\r\n\r\n// Launch/Abort/Deploy button\r\ndocument.getElementById('launch-btn')?.addEventListener('click', () => {\r\n    if (flightPhase === 'prelaunch' && game.mainStack?.throttle === 0) {\r\n        game.mainStack.active = true;\r\n        game.mainStack.throttle = 1.0;\r\n        game.missionLog.log(\"IGNITION SEQUENCE START\", \"warn\");\r\n        updateActionButton();\r\n    } else if (flightPhase === 'ascending') {\r\n        // Abort - cut engines\r\n        if (game.mainStack) game.mainStack.throttle = 0;\r\n        game.missionLog.log(\"ABORT INITIATED\", \"warn\");\r\n    } else if (flightPhase === 'descending') {\r\n        game.missionLog.log(\"LANDING LEGS DEPLOYED\", \"info\");\r\n    }\r\n});\r\n\r\n// --- IMPROVEMENT #9: Color-Coded Toggle Buttons ---\r\ndocument.getElementById('autopilot-btn')?.addEventListener('click', (e) => {\r\n    const btn = e.target as HTMLButtonElement;\r\n    state.autopilotEnabled = !state.autopilotEnabled;\r\n    btn.textContent = state.autopilotEnabled ? '🤖 Auto-Land: ON' : '🤖 Auto-Land: OFF';\r\n    btn.classList.toggle('enabled', state.autopilotEnabled);\r\n});\r\n\r\ndocument.getElementById('audio-btn')?.addEventListener('click', (e) => {\r\n    const btn = e.target as HTMLButtonElement;\r\n    const muted = game.audio.toggleMute();\r\n    btn.textContent = muted ? '🔇 Enable Audio' : '🔊 Disable Audio';\r\n    btn.classList.remove('enabled', 'disabled');\r\n    btn.classList.add(muted ? 'disabled' : 'enabled');\r\n});\r\n\r\n// --- IMPROVEMENT #4: SAS Control with Mode Indicator ---\r\ndocument.querySelectorAll('.sas-btn').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n        document.querySelectorAll('.sas-btn').forEach(b => b.classList.remove('active'));\r\n        btn.classList.add('active');\r\n\r\n        const mode = btn.id.replace('sas-', '').toUpperCase() as keyof typeof SASModes;\r\n        const sasMode = SASModes[mode] ?? SASModes.OFF;\r\n        game.sas.setMode(sasMode, game.trackedEntity?.angle ?? 0);\r\n\r\n        // Update SAS mode indicator\r\n        const modeText = uiCache.sasModeText;\r\n        const modeIcons: Record<string, string> = {\r\n            OFF: '⭕',\r\n            STABILITY: '⚡',\r\n            PROGRADE: '⬆️',\r\n            RETROGRADE: '⬇️'\r\n        };\r\n\r\n        if (modeText) {\r\n            modeText.textContent = mode;\r\n            const iconEl = modeText.previousElementSibling;\r\n            if (iconEl) iconEl.textContent = modeIcons[mode] ?? '🎯';\r\n        }\r\n    });\r\n});\r\n\r\n// --- IMPROVEMENT #10: Camera Mode Panel ---\r\ndocument.querySelectorAll('#camera-panel button').forEach(btn => {\r\n    btn.addEventListener('click', () => {\r\n        document.querySelectorAll('#camera-panel button').forEach(b => b.classList.remove('active'));\r\n        btn.classList.add('active');\r\n\r\n        const camMode = parseInt((btn as HTMLButtonElement).dataset.cam ?? '1');\r\n        game.input.cameraMode = camMode;\r\n        game.missionLog.log(`Camera: ${btn.textContent?.trim()}`, \"info\");\r\n    });\r\n});\r\n\r\n// --- Maneuver Planner Button ---\r\ndocument.getElementById('maneuver-btn')?.addEventListener('click', () => {\r\n    game.maneuverPlanner.toggle();\r\n});\r\n\r\n// --- Mission Control Button ---\r\ndocument.getElementById('mission-control-btn')?.addEventListener('click', () => {\r\n    game.missionControl.toggle();\r\n});\r\n\r\n// --- Checklist Button ---\r\ndocument.getElementById('checklist-btn')?.addEventListener('click', () => {\r\n    game.checklist.toggle();\r\n});\r\n\r\n// --- FTS Destruct Button ---\r\ndocument.getElementById('fts-destruct-btn')?.addEventListener('click', () => {\r\n    if (game.trackedEntity) {\r\n        const success = game.fts.triggerManualDestruct(game.trackedEntity);\r\n        if (!success) {\r\n            game.missionLog.log('FTS: Arm the system first (press T)', 'warn');\r\n        }\r\n    }\r\n});\r\n\r\n// --- FIS Panel Fault Toggle ---\r\ndocument.getElementById('fis-panel')?.addEventListener('fis-toggle', ((e: CustomEvent) => {\r\n    const faultId = e.detail?.faultId;\r\n    if (faultId && game.trackedEntity && game.trackedEntity instanceof Vessel) {\r\n        game.faultInjector.toggleFault(\r\n            faultId,\r\n            game.trackedEntity,\r\n            (game.trackedEntity as Vessel).reliability\r\n        );\r\n    }\r\n}) as EventListener);\r\n\r\n// --- Flight Computer Button ---\r\ndocument.getElementById('fc-btn')?.addEventListener('click', () => {\r\n    scriptEditor.open();\r\n});\r\n\r\n// --- Flight Computer HUD Update ---\r\nfunction updateFCStatus(): void {\r\n    const fcStatus = uiCache.fcStatus;\r\n    if (!fcStatus) return;\r\n\r\n    const isActive = game.flightComputer.isActive();\r\n    const isStandby = game.flightComputer.state.mode !== 'OFF';\r\n\r\n    if (isActive || isStandby) {\r\n        fcStatus.classList.add('active');\r\n\r\n        let modeDiv = fcStatus.querySelector('.fc-mode');\r\n        if (!modeDiv) {\r\n            modeDiv = document.createElement('div');\r\n            modeDiv.className = 'fc-mode';\r\n            fcStatus.appendChild(modeDiv);\r\n        }\r\n        modeDiv.textContent = game.flightComputer.getStatusString();\r\n\r\n        let commandDiv = fcStatus.querySelector('.fc-command');\r\n        if (isActive) {\r\n            if (!commandDiv) {\r\n                commandDiv = document.createElement('div');\r\n                commandDiv.className = 'fc-command';\r\n                fcStatus.appendChild(commandDiv);\r\n            }\r\n            commandDiv.textContent = game.flightComputer.getActiveCommandText();\r\n        } else {\r\n            if (commandDiv) {\r\n                commandDiv.remove();\r\n            }\r\n        }\r\n    } else {\r\n        fcStatus.classList.remove('active');\r\n        fcStatus.textContent = '';\r\n    }\r\n}\r\n\r\n// ========================================\r\n// KEYBOARD SHORTCUTS\r\n// ========================================\r\nwindow.addEventListener('keydown', (e) => {\r\n    // Prevent default for game keys\r\n    if ([' ', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {\r\n        e.preventDefault();\r\n    }\r\n\r\n    // SPACE - Launch or Stage\r\n    if (e.key === ' ') {\r\n        if (flightPhase === 'prelaunch' && game.mainStack?.throttle === 0) {\r\n            // Gate launch on checklist\r\n            if (!game.checklist.isReadyForLaunch()) {\r\n                game.missionLog.log('LAUNCH HOLD — Complete checklist first (press C)', 'warn');\r\n                game.checklist.show();\r\n                return;\r\n            }\r\n            // Initial ignition\r\n            game.mainStack.active = true;\r\n            game.mainStack.throttle = 1.0;\r\n            game.missionLog.log(\"IGNITION SEQUENCE START\", \"warn\");\r\n            game.checklist.hide();\r\n            updateActionButton();\r\n        } else if (flightPhase !== 'prelaunch') {\r\n            // Staging\r\n            game.performStaging();\r\n        }\r\n    }\r\n\r\n    // S - Staging\r\n    if (e.key === 's' || e.key === 'S') {\r\n        game.performStaging();\r\n    }\r\n\r\n    // 1, 2, 3 - Camera modes\r\n    if (e.key === '1') {\r\n        document.querySelector<HTMLButtonElement>('#camera-panel button[data-cam=\"1\"]')?.click();\r\n    } else if (e.key === '2') {\r\n        document.querySelector<HTMLButtonElement>('#camera-panel button[data-cam=\"2\"]')?.click();\r\n    } else if (e.key === '3') {\r\n        document.querySelector<HTMLButtonElement>('#camera-panel button[data-cam=\"3\"]')?.click();\r\n    }\r\n\r\n    // A - Toggle Autopilot\r\n    if (e.key === 'a' || e.key === 'A') {\r\n        document.getElementById('autopilot-btn')?.click();\r\n    }\r\n\r\n    // G - Toggle Flight Computer\r\n    if (e.key === 'g' || e.key === 'G') {\r\n        game.flightComputer.toggle();\r\n        game.missionLog.log(`Flight Computer: ${game.flightComputer.getStatusString()}`, \"info\");\r\n\r\n        // Update FC button state\r\n        const fcBtn = document.getElementById('fc-btn');\r\n        if (fcBtn) {\r\n            fcBtn.classList.toggle('enabled', game.flightComputer.isActive());\r\n        }\r\n    }\r\n\r\n    // F - Open Script Editor\r\n    if (e.key === 'f' || e.key === 'F') {\r\n        scriptEditor.open();\r\n    }\r\n\r\n    // R - Toggle Black Box Recording\r\n    if (e.key === 'r' || e.key === 'R') {\r\n        game.blackBox.toggle();\r\n        const status = game.blackBox.getStatusString();\r\n        game.missionLog.log(`Black Box: ${status || 'IDLE'}`, \"info\");\r\n    }\r\n\r\n    // E - Export Flight Data\r\n    if (e.key === 'e' || e.key === 'E') {\r\n        const frames = game.blackBox.getFrames();\r\n        if (frames.length > 0) {\r\n            exportFlightData(frames, game.blackBox.getSummary(), 'csv');\r\n            game.missionLog.log(`Exported ${frames.length} frames to CSV`, \"success\");\r\n        } else {\r\n            game.missionLog.log(\"No flight data to export\", \"warn\");\r\n        }\r\n    }\r\n\r\n    // T - Toggle FTS Arm\r\n    if (e.key === 't' || e.key === 'T') {\r\n        game.fts.toggleArm();\r\n        const ftsBtn = document.getElementById('fts-destruct-btn');\r\n        if (ftsBtn) {\r\n            ftsBtn.classList.toggle('armed', game.fts.getStatus().armed);\r\n        }\r\n    }\r\n\r\n    // C - Toggle Checklist\r\n    if (e.key === 'c' || e.key === 'C') {\r\n        game.checklist.toggle();\r\n    }\r\n\r\n    // Ctrl+I - Toggle Fault Injection System (instructor)\r\n    if (e.key === 'i' && e.ctrlKey) {\r\n        e.preventDefault();\r\n        game.faultInjector.toggle();\r\n    }\r\n});\r\n\r\n// Update action button periodically\r\nsetInterval(updateActionButton, 500);\r\nsetInterval(updateFCStatus, 100);\r\n\r\n// Update Black Box status in HUD\r\nfunction updateBlackBoxStatus(): void {\r\n    const bbStatus = uiCache.bbStatus;\r\n    if (bbStatus) {\r\n        const status = game.blackBox.getStatusString();\r\n        bbStatus.textContent = status;\r\n        bbStatus.classList.toggle('recording', game.blackBox.isRecording());\r\n    }\r\n}\r\nsetInterval(updateBlackBoxStatus, 200);\r\n\r\n// Export button handler\r\ndocument.getElementById('export-btn')?.addEventListener('click', () => {\r\n    const frames = game.blackBox.getFrames();\r\n    if (frames.length > 0) {\r\n        exportFlightData(frames, game.blackBox.getSummary(), 'csv');\r\n        game.missionLog.log(`Exported ${frames.length} frames to CSV`, \"success\");\r\n    } else {\r\n        game.missionLog.log(\"No flight data to export\", \"warn\");\r\n    }\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\Aerodynamics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\Environment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\OrbitalMechanics.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PhysicsState' is defined but never used.","line":8,"column":25,"messageId":"unusedVar","endLine":8,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PhysicsState"},"fix":{"range":[246,260],"text":""},"desc":"Remove unused variable \"PhysicsState\"."}]},{"ruleId":"no-useless-assignment","severity":2,"message":"This assigned value is not used in subsequent statements.","line":88,"column":9,"messageId":"unnecessaryAssignment","endLine":88,"endColumn":10}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Orbital Mechanics Module\r\n * \r\n * Provides physics calculations for orbital maneuvers and trajectory planning.\r\n * Includes Keplerian element calculation, Vis-Viva equation, and maneuver planning algorithms.\r\n */\r\n\r\nimport type { Vector2D, PhysicsState } from '../types/index.ts';\r\nimport { Vec2 } from '../types/index.ts';\r\nimport { R_EARTH, GRAVITY } from '../constants.ts';\r\n\r\n// Standard gravitational parameter for Earth (mu = GM)\r\n// G = 6.67430e-11, M = 5.972e24 => mu ≈ 3.986e14 m^3/s^2\r\n// Using simulated values from constants for consistency:\r\n// R_EARTH = 6371000m, GRAVITY = 9.8m/s^2 (at surface)\r\n// mu = g0 * R^2\r\nexport const MU = GRAVITY * R_EARTH * R_EARTH;\r\n\r\n/**\r\n * Launch Site Configuration\r\n */\r\nexport const LAUNCH_SITE = {\r\n    name: 'Cape Canaveral',\r\n    lat: 28.5 * (Math.PI / 180), // Radians\r\n    lon: -80.5 * (Math.PI / 180), // Radians\r\n    azimuth: 90 * (Math.PI / 180) // Radians (Due East)\r\n};\r\n\r\n/**\r\n * Calculated orbital elements from state vector\r\n */\r\nexport interface KeplerianElements {\r\n    /** Semi-major axis (meters) - negative for hyperbolas */\r\n    semiMajorAxis: number;\r\n    /** Eccentricity (dimensionless) */\r\n    eccentricity: number;\r\n    /** Apoapsis altitude (meters) */\r\n    apoapsis: number;\r\n    /** Periapsis altitude (meters) */\r\n    periapsis: number;\r\n    /** True anomaly (radians) */\r\n    trueAnomaly: number;\r\n    /** Period (seconds) */\r\n    period: number;\r\n    /** Specific orbital energy (J/kg) */\r\n    specificEnergy: number;\r\n}\r\n\r\n/**\r\n * Maneuver plan result\r\n */\r\nexport interface ManeuverPlan {\r\n    /** Required Delta-V (m/s) */\r\n    deltaV: number;\r\n    /** Estimated burn time (seconds) */\r\n    burnTime: number;\r\n    /** Description of the maneuver */\r\n    description: string;\r\n    /** Target orbit parameters */\r\n    targetOrbit: {\r\n        apoapsis: number;\r\n        periapsis: number;\r\n    };\r\n}\r\n\r\n/**\r\n * Calculate orbital elements from state vectors\r\n * @param r Position vector relative to center of Earth (meters)\r\n * @param v Velocity vector (m/s)\r\n */\r\nexport function calculateOrbitalElements(r: Vector2D, v: Vector2D): KeplerianElements {\r\n    const rMag = Vec2.magnitude(r);\r\n    const vMag = Vec2.magnitude(v); // Speed relative to Earth center\r\n\r\n    // 1. Specific Angular Momentum (h = r x v) in 2D\r\n    //For 2D, we treat as scalar h = x*vy - y*vx\r\n    const h = r.x * v.y - r.y * v.x;\r\n\r\n    // 2. Specific Orbital Energy (E = v^2/2 - mu/r)\r\n    const E = (vMag * vMag) / 2 - MU / rMag;\r\n\r\n    // 3. Semi-major axis (a = -mu / 2E)\r\n    // For parabolas (E=0), a is infinite\r\n    const a = Math.abs(E) < 1e-10 ? Infinity : -MU / (2 * E);\r\n\r\n    // 4. Eccentricity vector (e_vec = (v x h)/mu - r/r)\r\n    // Simplified for magnitude: e = sqrt(1 + 2Eh^2/mu^2)\r\n    let e = 0;\r\n    if (a !== Infinity) {\r\n        e = Math.sqrt(Math.max(0, 1 + (2 * E * h * h) / (MU * MU)));\r\n    } else {\r\n        e = 1; // Parabolic\r\n    }\r\n\r\n    // 5. Apoapsis and Periapsis radii\r\n    const rp = a * (1 - e);\r\n    const ra = a * (1 + e);\r\n\r\n    // Altitudes (subtract Earth radius)\r\n    const periapsisAlt = rp - R_EARTH;\r\n    const apoapsisAlt = ra === Infinity ? Infinity : ra - R_EARTH;\r\n\r\n    // 6. True Anomaly (angle from periapsis)\r\n    // difficult in 2D without argument of periapsis. Simplified:\r\n    // angle between e_vec and r_vec.\r\n    // For now, return angle of position vector relative to some reference if needed\r\n    // or calc via: cos(nu) = (a(1-e^2)/r - 1) / e\r\n    let trueAnomaly = 0;\r\n    if (e > 1e-6) {\r\n        const cosNu = (a * (1 - e * e) / rMag - 1) / e;\r\n        // Clamp to [-1, 1] for acos\r\n        trueAnomaly = Math.acos(Math.max(-1, Math.min(1, cosNu)));\r\n        // Check sign using flight path angle (v dot r)\r\n        if (Vec2.dot(r, v) < 0) {\r\n            trueAnomaly = 2 * Math.PI - trueAnomaly;\r\n        }\r\n    }\r\n\r\n    // 7. Period (T = 2*pi*sqrt(a^3/mu))\r\n    const period = 2 * Math.PI * Math.sqrt(Math.max(0, Math.pow(a, 3)) / MU);\r\n\r\n    return {\r\n        semiMajorAxis: a,\r\n        eccentricity: e,\r\n        apoapsis: apoapsisAlt,\r\n        periapsis: periapsisAlt,\r\n        trueAnomaly,\r\n        period,\r\n        specificEnergy: E\r\n    };\r\n}\r\n\r\n/**\r\n * Calculate velocity required at a given radius for a specific semi-major axis\r\n * Vis-Viva Equation: v^2 = GM * (2/r - 1/a)\r\n * @param r Current radius from center of Earth (m)\r\n * @param a Target semi-major axis (m)\r\n * @returns Velocity (m/s)\r\n */\r\nexport function calculateVisViva(r: number, a: number): number {\r\n    return Math.sqrt(MU * (2 / r - 1 / a));\r\n}\r\n\r\n/**\r\n * Calculate velocity for a circular orbit at specific radius\r\n * @param r Radius from center of Earth (m)\r\n */\r\nexport function calculateCircularVelocity(r: number): number {\r\n    return Math.sqrt(MU / r);\r\n}\r\n\r\n/**\r\n * Calculate Hohmann Transfer parameters\r\n * @param r1 Radius of initial circular orbit\r\n * @param r2 Radius of target circular orbit\r\n * @returns Maneuver plan including both burns\r\n */\r\nexport function calculateHohmannTransfer(\r\n    r1: number,\r\n    r2: number,\r\n    thrust: number,\r\n    mass: number\r\n): { deltaV1: number; deltaV2: number; transferTime: number; burnTime1: number } {\r\n    // 1. Semi-major axis of transfer orbit\r\n    const aTransfer = (r1 + r2) / 2;\r\n\r\n    // 2. Initial velocity (v1) for circular orbit at r1\r\n    const v1 = Math.sqrt(MU / r1);\r\n\r\n    // 3. Transfer velocity (vTransfer1) at periapsis/apoapsis (at r1)\r\n    // Vis-Viva: v^2 = mu * (2/r - 1/a)\r\n    const vTransfer1 = Math.sqrt(MU * (2 / r1 - 1 / aTransfer));\r\n\r\n    // 4. First Burn Delta-V\r\n    const deltaV1 = Math.abs(vTransfer1 - v1);\r\n\r\n    // 5. Final velocity (v2) for circular orbit at r2\r\n    const v2 = Math.sqrt(MU / r2);\r\n\r\n    // 6. Transfer velocity (vTransfer2) at arrival (at r2)\r\n    const vTransfer2 = Math.sqrt(MU * (2 / r2 - 1 / aTransfer));\r\n\r\n    // 7. Second Burn Delta-V\r\n    const deltaV2 = Math.abs(v2 - vTransfer2);\r\n\r\n    // 8. Transfer Time (half period)\r\n    // T = 2*pi * sqrt(a^3 / mu)\r\n    const transferTime = Math.PI * Math.sqrt(Math.pow(aTransfer, 3) / MU);\r\n\r\n    // 9. Estimate initial burn time\r\n    const burnTime1 = (deltaV1 * mass) / Math.max(1, thrust);\r\n\r\n    return { deltaV1, deltaV2, transferTime, burnTime1 };\r\n}\r\n\r\n/**\r\n * Calculate Circularization Burn from known orbital elements\r\n * @param elements Keplerian elements\r\n * @param atApoapsis True to circularize at apoapsis (raise periapsis), False for periapsis (lower apoapsis)\r\n * @param thrust Force (N)\r\n * @param mass Vehicle mass (kg)\r\n */\r\nexport function calculateCircularizationFromElements(\r\n    elements: KeplerianElements,\r\n    atApoapsis: boolean,\r\n    thrust: number,\r\n    mass: number\r\n): ManeuverPlan {\r\n    // Current orbital radii\r\n    // Be careful with valid numbers if orbit is hyperbolic\r\n    const ra = elements.apoapsis + R_EARTH;\r\n    const rp = elements.periapsis + R_EARTH;\r\n    const a = elements.semiMajorAxis;\r\n\r\n    // Radius where burn occurs\r\n    const rBurn = atApoapsis ? ra : rp;\r\n\r\n    // Velocity at that point in CURRENT orbit\r\n    const vCurrent = calculateVisViva(rBurn, a);\r\n\r\n    // Target velocity for CIRCULAR orbit at that radius\r\n    // Vis-Viva with a = r (circular) -> v^2 = MU/r\r\n    const vTarget = Math.sqrt(MU / rBurn);\r\n\r\n    // Delta-V required\r\n    const deltaV = Math.abs(vTarget - vCurrent);\r\n\r\n    // Estimate burn time: t = (m * dv) / F \r\n    const burnTime = (deltaV * mass) / Math.max(1, thrust);\r\n\r\n    const label = atApoapsis ? \"Circularize at Apoapsis\" : \"Circularize at Periapsis\";\r\n    // Target altitude is the altitude of the burn point (since we circularize there)\r\n    const targetAlt = rBurn - R_EARTH;\r\n\r\n    return {\r\n        deltaV,\r\n        burnTime,\r\n        description: label,\r\n        targetOrbit: {\r\n            apoapsis: targetAlt,\r\n            periapsis: targetAlt\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Calculate Ground Track (Latitude/Longitude)\r\n * \r\n * Uses spherical trigonometry to project downrange distance onto Earth's surface.\r\n * Accounts for Earth's rotation (Coriolis/inertial frame offset).\r\n * \r\n * @param downrange Downrange distance from launch site (meters) (x coordinate in sim)\r\n * @param time Mission elapsed time (seconds)\r\n * @returns { lat: number, lon: number } (Radians)\r\n */\r\nexport function calculateGroundTrack(downrange: number, time: number): { lat: number, lon: number } {\r\n    const lat0 = LAUNCH_SITE.lat;\r\n    const lon0 = LAUNCH_SITE.lon;\r\n    const az = LAUNCH_SITE.azimuth; // Launch azimuth\r\n\r\n    // Angular distance traveled along great circle\r\n    const c = downrange / R_EARTH;\r\n\r\n    // Spherical Law of Cosines for Latitude\r\n    // sin(lat) = sin(lat0)*cos(c) + cos(lat0)*sin(c)*cos(az)\r\n    const sinLat = Math.sin(lat0) * Math.cos(c) + Math.cos(lat0) * Math.sin(c) * Math.cos(az);\r\n    const lat = Math.asin(Math.max(-1, Math.min(1, sinLat)));\r\n\r\n    // Longitude difference (delta lambda)\r\n    // tan(dLon) = (sin(c)*sin(az)) / (cos(lat0)*cos(c) - sin(lat0)*sin(c)*cos(az))\r\n    // Or simplified using known lat:\r\n    // sin(dLon) = sin(az) * sin(c) / cos(lat) -- problematic at poles\r\n    // Let's use `atan2` form for robustness\r\n    const y = Math.sin(c) * Math.sin(az);\r\n    const x = Math.cos(lat0) * Math.cos(c) - Math.sin(lat0) * Math.sin(c) * Math.cos(az);\r\n    const dLon = Math.atan2(y, x);\r\n\r\n    // Earth rotation (Omega_Earth ~ 7.2921e-5 rad/s)\r\n    const OMEGA_EARTH = 7.2921159e-5;\r\n    const rotOffset = OMEGA_EARTH * time;\r\n\r\n    // Final longitude\r\n    let lon = lon0 + dLon - rotOffset;\r\n\r\n    // Normalize to -PI to PI\r\n    lon = ((lon + Math.PI) % (2 * Math.PI)) - Math.PI;\r\n\r\n    return { lat, lon };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\Particle.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\Propulsion.ts","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":275,"column":13,"messageId":"unexpected","endLine":275,"endColumn":54,"suggestions":[{"messageId":"addBrackets","fix":{"range":[7521,8136],"text":"{ const spoolRate = 1 / config.spoolUpTime;\r\n            newState.spoolProgress = Math.min(1, state.spoolProgress + spoolRate * dt);\r\n\r\n            // Throttle ramps up with spool progress\r\n            newState.actualThrottle = commandedThrottle * newState.spoolProgress;\r\n\r\n            // Transition to running when spooled up\r\n            if (newState.spoolProgress >= 1) {\r\n                newState.engineState = 'running';\r\n            }\r\n\r\n            // Abort if throttle zeroed\r\n            if (commandedThrottle <= 0) {\r\n                newState = commandShutdown(newState);\r\n            }\r\n            break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":299,"column":13,"messageId":"unexpected","endLine":299,"endColumn":37,"suggestions":[{"messageId":"addBrackets","fix":{"range":[8209,9056],"text":"{ if (state.actualThrottle > 0) {\r\n                newState.totalBurnTime += dt;\r\n            }\r\n\r\n            // Throttle follows command with small lag\r\n            const throttleLag = 0.1; // 100ms response\r\n            const throttleDelta = commandedThrottle - state.actualThrottle;\r\n            newState.actualThrottle += throttleDelta * Math.min(1, dt / throttleLag);\r\n\r\n            // Clamp\r\n            newState.actualThrottle = Math.max(0, Math.min(1, newState.actualThrottle));\r\n\r\n            // Shutdown if throttle zeroed\r\n            if (commandedThrottle <= 0) {\r\n                newState = commandShutdown(newState);\r\n            }\r\n\r\n            // Flame out if fuel exhausted\r\n            if (!hasFuel) {\r\n                newState.engineState = 'off';\r\n                newState.actualThrottle = 0;\r\n            }\r\n            break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":300,"column":13,"messageId":"unexpected","endLine":300,"endColumn":76,"suggestions":[{"messageId":"addBrackets","fix":{"range":[8209,9056],"text":"{ if (state.actualThrottle > 0) {\r\n                newState.totalBurnTime += dt;\r\n            }\r\n\r\n            // Throttle follows command with small lag\r\n            const throttleLag = 0.1; // 100ms response\r\n            const throttleDelta = commandedThrottle - state.actualThrottle;\r\n            newState.actualThrottle += throttleDelta * Math.min(1, dt / throttleLag);\r\n\r\n            // Clamp\r\n            newState.actualThrottle = Math.max(0, Math.min(1, newState.actualThrottle));\r\n\r\n            // Shutdown if throttle zeroed\r\n            if (commandedThrottle <= 0) {\r\n                newState = commandShutdown(newState);\r\n            }\r\n\r\n            // Flame out if fuel exhausted\r\n            if (!hasFuel) {\r\n                newState.engineState = 'off';\r\n                newState.actualThrottle = 0;\r\n            }\r\n            break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":320,"column":13,"messageId":"unexpected","endLine":320,"endColumn":59,"suggestions":[{"messageId":"addBrackets","fix":{"range":[9125,9495],"text":"{ const shutdownRate = 1 / config.spoolDownTime;\r\n            newState.actualThrottle = Math.max(0, state.actualThrottle - shutdownRate * dt);\r\n\r\n            // Transition to off when spooled down\r\n            if (newState.actualThrottle <= 0) {\r\n                newState.engineState = 'off';\r\n                newState.spoolProgress = 0;\r\n            }\r\n            break; }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Realistic Propulsion Physics\r\n * \r\n * Models engine constraints including:\r\n * - Ullage simulation (fuel settling requirement)\r\n * - Spool-up/down times (turbo-machinery lag)\r\n * - Restart limits (igniter cartridges)\r\n * - Engine state machine\r\n */\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\n/** Engine operational states */\r\nexport type EngineState = 'off' | 'starting' | 'running' | 'shutdown';\r\n\r\n/**\r\n * Propulsion system configuration\r\n */\r\nexport interface PropulsionConfig {\r\n    /** Time to reach full thrust from ignition (seconds) */\r\n    spoolUpTime: number;\r\n\r\n    /** Time to shutdown from running (seconds) */\r\n    spoolDownTime: number;\r\n\r\n    /** Number of igniter cartridges (TEA/TEB) */\r\n    igniterCount: number;\r\n\r\n    /** Minimum acceleration for fuel settling (m/s²) */\r\n    minUllageAccel: number;\r\n\r\n    /** Time of thrust needed to settle fuel (seconds) */\r\n    ullageSettleTime: number;\r\n\r\n    /** Whether this component has an engine */\r\n    hasEngine: boolean;\r\n}\r\n\r\n/**\r\n * Current propulsion system state\r\n */\r\nexport interface PropulsionState {\r\n    /** Current engine state */\r\n    engineState: EngineState;\r\n\r\n    /** Actual throttle output (lagged behind commanded) */\r\n    actualThrottle: number;\r\n\r\n    /** User commanded throttle */\r\n    commandedThrottle: number;\r\n\r\n    /** Remaining igniter cartridges */\r\n    ignitersRemaining: number;\r\n\r\n    /** Whether fuel is settled (ullage satisfied) */\r\n    ullageSettled: boolean;\r\n\r\n    /** Time fuel has been settling (seconds) */\r\n    ullageTimer: number;\r\n\r\n    /** Spool-up progress during startup (0-1) */\r\n    spoolProgress: number;\r\n\r\n    /** Total burn time for this engine */\r\n    totalBurnTime: number;\r\n\r\n    /** Last ignition attempt result */\r\n    lastIgnitionResult: 'none' | 'success' | 'no_ullage' | 'no_igniters' | 'no_fuel';\r\n}\r\n\r\n// ============================================================================\r\n// Default Configurations\r\n// ============================================================================\r\n\r\n/**\r\n * Full Stack propulsion config (Merlin-like first stage)\r\n */\r\nexport const FULLSTACK_PROP_CONFIG: PropulsionConfig = {\r\n    spoolUpTime: 2.0,\r\n    spoolDownTime: 0.5,\r\n    igniterCount: 3,\r\n    minUllageAccel: 0.1,\r\n    ullageSettleTime: 0.5,\r\n    hasEngine: true\r\n};\r\n\r\n/**\r\n * Booster propulsion config (landing capable)\r\n */\r\nexport const BOOSTER_PROP_CONFIG: PropulsionConfig = {\r\n    spoolUpTime: 1.5,\r\n    spoolDownTime: 0.3,\r\n    igniterCount: 5,      // Multiple landing burns\r\n    minUllageAccel: 0.1,\r\n    ullageSettleTime: 0.3,\r\n    hasEngine: true\r\n};\r\n\r\n/**\r\n * Upper Stage propulsion config (vacuum Merlin)\r\n */\r\nexport const UPPER_STAGE_PROP_CONFIG: PropulsionConfig = {\r\n    spoolUpTime: 3.0,     // Slower vacuum engine\r\n    spoolDownTime: 1.0,\r\n    igniterCount: 4,\r\n    minUllageAccel: 0.05, // Lower requirement in space\r\n    ullageSettleTime: 1.0,\r\n    hasEngine: true\r\n};\r\n\r\n/**\r\n * Payload propulsion config (no engine)\r\n */\r\nexport const PAYLOAD_PROP_CONFIG: PropulsionConfig = {\r\n    spoolUpTime: 0,\r\n    spoolDownTime: 0,\r\n    igniterCount: 0,\r\n    minUllageAccel: 0,\r\n    ullageSettleTime: 0,\r\n    hasEngine: false\r\n};\r\n\r\n// ============================================================================\r\n// Core Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Create initial propulsion state\r\n */\r\nexport function createInitialPropulsionState(config: PropulsionConfig): PropulsionState {\r\n    return {\r\n        engineState: 'off',\r\n        actualThrottle: 0,\r\n        commandedThrottle: 0,\r\n        ignitersRemaining: config.igniterCount,\r\n        ullageSettled: true,  // Settled on ground\r\n        ullageTimer: 0,\r\n        spoolProgress: 0,\r\n        totalBurnTime: 0,\r\n        lastIgnitionResult: 'none'\r\n    };\r\n}\r\n\r\n/**\r\n * Check if ullage requirements are satisfied\r\n * Fuel settles when under acceleration (gravity or thrust)\r\n */\r\nexport function updateUllageStatus(\r\n    state: PropulsionState,\r\n    config: PropulsionConfig,\r\n    currentAcceleration: number,\r\n    dt: number\r\n): PropulsionState {\r\n    const newState = { ...state };\r\n\r\n    // If we have sufficient acceleration, fuel is settling\r\n    if (currentAcceleration >= config.minUllageAccel) {\r\n        newState.ullageTimer += dt;\r\n        if (newState.ullageTimer >= config.ullageSettleTime) {\r\n            newState.ullageSettled = true;\r\n        }\r\n    } else {\r\n        // Fuel unsettles quickly in microgravity\r\n        newState.ullageTimer = Math.max(0, newState.ullageTimer - dt * 2);\r\n        if (newState.ullageTimer <= 0) {\r\n            newState.ullageSettled = false;\r\n        }\r\n    }\r\n\r\n    return newState;\r\n}\r\n\r\n/**\r\n * Attempt to ignite the engine\r\n * Returns updated state with ignition result\r\n */\r\nexport function attemptIgnition(\r\n    state: PropulsionState,\r\n    config: PropulsionConfig,\r\n    hasFuel: boolean\r\n): PropulsionState {\r\n    const newState = { ...state };\r\n\r\n    // Already running or starting\r\n    if (state.engineState === 'running' || state.engineState === 'starting') {\r\n        return newState;\r\n    }\r\n\r\n    // No engine\r\n    if (!config.hasEngine) {\r\n        newState.lastIgnitionResult = 'none';\r\n        return newState;\r\n    }\r\n\r\n    // Check fuel\r\n    if (!hasFuel) {\r\n        newState.lastIgnitionResult = 'no_fuel';\r\n        return newState;\r\n    }\r\n\r\n    // Check ullage\r\n    if (!state.ullageSettled) {\r\n        newState.lastIgnitionResult = 'no_ullage';\r\n        return newState;\r\n    }\r\n\r\n    // Check igniters\r\n    if (state.ignitersRemaining <= 0) {\r\n        newState.lastIgnitionResult = 'no_igniters';\r\n        return newState;\r\n    }\r\n\r\n    // Success! Start the engine\r\n    newState.engineState = 'starting';\r\n    newState.ignitersRemaining--;\r\n    newState.spoolProgress = 0;\r\n    newState.lastIgnitionResult = 'success';\r\n\r\n    return newState;\r\n}\r\n\r\n/**\r\n * Command engine shutdown\r\n */\r\nexport function commandShutdown(state: PropulsionState): PropulsionState {\r\n    const newState = { ...state };\r\n\r\n    if (state.engineState === 'running') {\r\n        newState.engineState = 'shutdown';\r\n        newState.commandedThrottle = 0;\r\n    } else if (state.engineState === 'starting') {\r\n        // Abort startup\r\n        newState.engineState = 'off';\r\n        newState.spoolProgress = 0;\r\n        newState.actualThrottle = 0;\r\n    }\r\n\r\n    return newState;\r\n}\r\n\r\n/**\r\n * Update propulsion state for this timestep\r\n * Handles spool-up/down, throttle lag, and state transitions\r\n */\r\nexport function updatePropulsionState(\r\n    state: PropulsionState,\r\n    config: PropulsionConfig,\r\n    commandedThrottle: number,\r\n    hasFuel: boolean,\r\n    currentAcceleration: number,\r\n    dt: number\r\n): PropulsionState {\r\n    let newState = { ...state };\r\n    newState.commandedThrottle = commandedThrottle;\r\n\r\n    // Update ullage status\r\n    newState = updateUllageStatus(newState, config, currentAcceleration, dt);\r\n\r\n    // State machine\r\n    switch (state.engineState) {\r\n        case 'off':\r\n            newState.actualThrottle = 0;\r\n            newState.spoolProgress = 0;\r\n\r\n            // Auto-attempt ignition when throttle commanded\r\n            if (commandedThrottle > 0) {\r\n                newState = attemptIgnition(newState, config, hasFuel);\r\n            }\r\n            break;\r\n\r\n        case 'starting':\r\n            // Spool up\r\n            const spoolRate = 1 / config.spoolUpTime;\r\n            newState.spoolProgress = Math.min(1, state.spoolProgress + spoolRate * dt);\r\n\r\n            // Throttle ramps up with spool progress\r\n            newState.actualThrottle = commandedThrottle * newState.spoolProgress;\r\n\r\n            // Transition to running when spooled up\r\n            if (newState.spoolProgress >= 1) {\r\n                newState.engineState = 'running';\r\n            }\r\n\r\n            // Abort if throttle zeroed\r\n            if (commandedThrottle <= 0) {\r\n                newState = commandShutdown(newState);\r\n            }\r\n            break;\r\n\r\n        case 'running':\r\n            // Track burn time\r\n            if (state.actualThrottle > 0) {\r\n                newState.totalBurnTime += dt;\r\n            }\r\n\r\n            // Throttle follows command with small lag\r\n            const throttleLag = 0.1; // 100ms response\r\n            const throttleDelta = commandedThrottle - state.actualThrottle;\r\n            newState.actualThrottle += throttleDelta * Math.min(1, dt / throttleLag);\r\n\r\n            // Clamp\r\n            newState.actualThrottle = Math.max(0, Math.min(1, newState.actualThrottle));\r\n\r\n            // Shutdown if throttle zeroed\r\n            if (commandedThrottle <= 0) {\r\n                newState = commandShutdown(newState);\r\n            }\r\n\r\n            // Flame out if fuel exhausted\r\n            if (!hasFuel) {\r\n                newState.engineState = 'off';\r\n                newState.actualThrottle = 0;\r\n            }\r\n            break;\r\n\r\n        case 'shutdown':\r\n            // Spool down\r\n            const shutdownRate = 1 / config.spoolDownTime;\r\n            newState.actualThrottle = Math.max(0, state.actualThrottle - shutdownRate * dt);\r\n\r\n            // Transition to off when spooled down\r\n            if (newState.actualThrottle <= 0) {\r\n                newState.engineState = 'off';\r\n                newState.spoolProgress = 0;\r\n            }\r\n            break;\r\n    }\r\n\r\n    return newState;\r\n}\r\n\r\n/**\r\n * Get effective thrust multiplier based on propulsion state\r\n * Returns 0-1 multiplier to apply to max thrust\r\n */\r\nexport function getEffectiveThrustMultiplier(state: PropulsionState): number {\r\n    return state.actualThrottle;\r\n}\r\n\r\n/**\r\n * Get display string for engine state\r\n */\r\nexport function getEngineStateDisplay(state: PropulsionState): string {\r\n    switch (state.engineState) {\r\n        case 'off': return 'OFF';\r\n        case 'starting': return `STARTING ${Math.round(state.spoolProgress * 100)}%`;\r\n        case 'running': return 'RUNNING';\r\n        case 'shutdown': return 'SHUTDOWN';\r\n    }\r\n}\r\n\r\n/**\r\n * Get color for engine state display\r\n */\r\nexport function getEngineStateColor(state: PropulsionState): string {\r\n    switch (state.engineState) {\r\n        case 'off': return '#95a5a6';      // Gray\r\n        case 'starting': return '#f1c40f'; // Yellow\r\n        case 'running': return '#2ecc71';  // Green\r\n        case 'shutdown': return '#e67e22'; // Orange\r\n    }\r\n}\r\n\r\n/**\r\n * Get ignition failure message\r\n */\r\nexport function getIgnitionFailureMessage(state: PropulsionState): string | null {\r\n    switch (state.lastIgnitionResult) {\r\n        case 'no_ullage': return 'IGNITION FAILED: Fuel not settled (need ullage thrust)';\r\n        case 'no_igniters': return 'IGNITION FAILED: No igniter cartridges remaining';\r\n        case 'no_fuel': return 'IGNITION FAILED: No fuel';\r\n        default: return null;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\Reliability.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\RocketComponents.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ReliabilityConfig' is defined but never used.","line":32,"column":10,"messageId":"unusedVar","endLine":32,"endColumn":27,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"ReliabilityConfig"},"fix":{"range":[879,931],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Rocket Components\r\n * \r\n * Concrete vessel implementations for different rocket stages.\r\n * Each extends the base Vessel class with specific properties and rendering.\r\n */\r\n\r\nimport { Vessel } from './Vessel';\r\nimport { CONFIG, PIXELS_PER_METER } from '../constants';\r\nimport { state } from '../state';\r\nimport { PIDController } from '../utils/PIDController';\r\nimport { StageSeparation } from '../types';\r\nimport {\r\n    DEFAULT_AERO_CONFIG,\r\n    BOOSTER_AERO_CONFIG,\r\n    UPPER_STAGE_AERO_CONFIG,\r\n    PAYLOAD_AERO_CONFIG\r\n} from './Aerodynamics';\r\nimport {\r\n    DEFAULT_TPS_CONFIG,\r\n    BOOSTER_TPS_CONFIG,\r\n    UPPER_STAGE_TPS_CONFIG,\r\n    PAYLOAD_TPS_CONFIG\r\n} from './ThermalProtection';\r\nimport {\r\n    FULLSTACK_PROP_CONFIG,\r\n    BOOSTER_PROP_CONFIG,\r\n    UPPER_STAGE_PROP_CONFIG,\r\n    PAYLOAD_PROP_CONFIG,\r\n    createInitialPropulsionState\r\n} from './Propulsion';\r\nimport { ReliabilityConfig } from './Reliability';\r\n\r\n/**\r\n * Full Stack - Complete rocket before staging\r\n * First stage booster + second stage + payload fairing\r\n */\r\nexport class FullStack extends Vessel {\r\n    constructor(x: number, y: number) {\r\n        super(x, y);\r\n        this.h = 160;\r\n        this.mass = CONFIG.MASS_BOOSTER + CONFIG.MASS_UPPER + CONFIG.FUEL_MASS;\r\n        this.maxThrust = CONFIG.MAX_THRUST_BOOSTER;\r\n        this.ispVac = CONFIG.ISP_VAC_BOOSTER;\r\n        this.ispSL = CONFIG.ISP_SL_BOOSTER;\r\n\r\n        // Reliability: Brand new engines, generally reliable but infant mortality risk\r\n        this.reliabilityConfig = {\r\n            mtbfEngine: 1200,      // Good reliability\r\n            mtbfStructure: 10000,  // Sturdy\r\n            mtbfElectronics: 3000,\r\n            ignitionReliability: 0.98,\r\n            wearFactor: 1.0\r\n        };\r\n\r\n        // Full stack has good stability with fins at the base\r\n        this.aeroConfig = DEFAULT_AERO_CONFIG;\r\n        // Standard aluminum skin, moderate thermal tolerance\r\n        this.tpsConfig = DEFAULT_TPS_CONFIG;\r\n        // Merlin-like first stage propulsion\r\n        this.propConfig = FULLSTACK_PROP_CONFIG;\r\n        this.propState = createInitialPropulsionState(FULLSTACK_PROP_CONFIG);\r\n        this.ignitersRemaining = FULLSTACK_PROP_CONFIG.igniterCount;\r\n    }\r\n\r\n    draw(ctx: CanvasRenderingContext2D, camY: number): void {\r\n        if (this.crashed) return;\r\n\r\n        ctx.save();\r\n        ctx.translate(this.x, this.y - camY);\r\n        ctx.rotate(this.angle);\r\n\r\n        this.drawPlasma(ctx);\r\n        this.drawShockwave(ctx);\r\n\r\n        const rocketImg = state.assets?.get('rocket_body');\r\n        const engineImg = state.assets?.get('rocket_engine');\r\n\r\n        if (rocketImg && engineImg) {\r\n            // Draw engine (gimbaled)\r\n            ctx.save();\r\n            ctx.translate(0, 160);\r\n            ctx.rotate(this.gimbalAngle);\r\n            ctx.drawImage(engineImg, -15, -10, 30, 40);\r\n            ctx.restore();\r\n\r\n            // Draw body\r\n            ctx.drawImage(rocketImg, -20, 0, 40, 160);\r\n        } else {\r\n            // Fallback procedural rendering\r\n            // Body (white with nose cone)\r\n            ctx.fillStyle = '#fff';\r\n            ctx.fillRect(-20, 0, 40, 60);\r\n            ctx.beginPath();\r\n            ctx.moveTo(-20, 0);\r\n            ctx.quadraticCurveTo(0, -40, 20, 0);\r\n            ctx.fill();\r\n\r\n            // First stage (light gray)\r\n            ctx.fillStyle = '#eee';\r\n            ctx.fillRect(-20, 60, 40, 100);\r\n\r\n            // Engine (gimbaled)\r\n            ctx.save();\r\n            ctx.translate(0, 160);\r\n            ctx.rotate(this.gimbalAngle);\r\n            ctx.fillStyle = '#333';\r\n            ctx.beginPath();\r\n            ctx.moveTo(-10, 0);\r\n            ctx.lineTo(-15, 20);\r\n            ctx.lineTo(15, 20);\r\n            ctx.lineTo(10, 0);\r\n            ctx.fill();\r\n            ctx.restore();\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n}\r\n\r\n/**\r\n * Booster - First stage after separation\r\n * Capable of propulsive landing with autopilot\r\n */\r\nexport class Booster extends Vessel {\r\n    /** Stage separation config */\r\n    public nextStage: StageSeparation;\r\n\r\n    /** PID controller for tilt stabilization */\r\n    private pidTilt: PIDController;\r\n\r\n    /** PID controller for throttle during landing */\r\n    private pidThrottle: PIDController;\r\n\r\n    constructor(x: number, y: number, vx: number = 0, vy: number = 0) {\r\n        super(x, y);\r\n        this.vx = vx;\r\n        this.vy = vy;\r\n        this.h = 100;\r\n        this.mass = CONFIG.MASS_BOOSTER;\r\n        this.maxThrust = CONFIG.MAX_THRUST_BOOSTER;\r\n        this.fuel = 0.3; // Remaining fuel after staging\r\n        this.ispVac = CONFIG.ISP_VAC_BOOSTER;\r\n        this.ispSL = CONFIG.ISP_SL_BOOSTER;\r\n        this.active = true;\r\n\r\n        // Reliability: Reuse adds wear\r\n        this.reliabilityConfig = {\r\n            mtbfEngine: 800,       // Slightly degraded from reuse/stress\r\n            mtbfStructure: 8000,\r\n            mtbfElectronics: 2000,\r\n            ignitionReliability: 0.95, // Relight is harder\r\n            wearFactor: 1.5        // Wears out faster\r\n        };\r\n\r\n        // PID controllers for landing\r\n        // Negative Kp because positive angle needs negative correction\r\n        this.pidTilt = new PIDController(-5.0, 0.0, -50.0);\r\n        this.pidThrottle = new PIDController(0.1, 0.001, 0.5);\r\n\r\n        // Booster has grid fins for stability during descent\r\n        this.aeroConfig = BOOSTER_AERO_CONFIG;\r\n        // Grid fins and re-entry capable with some TPS coating\r\n        this.tpsConfig = BOOSTER_TPS_CONFIG;\r\n        // Landing-capable with multiple restarts\r\n        this.propConfig = BOOSTER_PROP_CONFIG;\r\n        this.propState = createInitialPropulsionState(BOOSTER_PROP_CONFIG);\r\n        this.ignitersRemaining = BOOSTER_PROP_CONFIG.igniterCount;\r\n\r\n        this.nextStage = {\r\n            type: 'UpperStage',\r\n            separationVelocity: 3,\r\n            offsetY: -20\r\n        };\r\n    }\r\n\r\n    applyPhysics(dt: number, keys: Record<string, boolean>): void {\r\n        if (state.autopilotEnabled && this.active && !this.crashed) {\r\n            this.runAutopilot(dt);\r\n        }\r\n        super.applyPhysics(dt, keys);\r\n    }\r\n\r\n    protected override runAutopilot(dt: number): void {\r\n        const alt = (state.groundY - this.y - this.h) / PIXELS_PER_METER;\r\n\r\n        // 1. Angle control - keep vertical\r\n        const tiltOutput = this.pidTilt.update(this.angle, dt);\r\n        this.gimbalAngle = Math.max(-0.4, Math.min(0.4, tiltOutput));\r\n\r\n        // 2. Suicide burn calculation\r\n        const g = 9.8;\r\n        const maxAccel = (this.maxThrust / this.mass) - g;\r\n        // v² = 2ad → d = v² / 2a\r\n        const stopDist = (this.vy * this.vy) / (2 * maxAccel);\r\n\r\n        // Start burn when altitude approaches stopping distance\r\n        if (this.vy > 0 && alt < stopDist + 100) {\r\n            this.throttle = 1.0;\r\n\r\n            // Terminal precision control\r\n            if (alt < 50) {\r\n                const targetVel = alt * 0.2;\r\n                const err = this.vy - targetVel;\r\n                this.throttle = Math.min(1, Math.max(0, 0.5 + err * 0.2));\r\n            }\r\n        } else {\r\n            this.throttle = 0;\r\n        }\r\n\r\n        // Cut engines at touchdown\r\n        if (alt < 1) {\r\n            this.throttle = 0;\r\n        }\r\n    }\r\n\r\n    draw(ctx: CanvasRenderingContext2D, camY: number): void {\r\n        if (this.crashed) return;\r\n\r\n        ctx.save();\r\n        ctx.translate(this.x, this.y - camY);\r\n        ctx.rotate(this.angle);\r\n\r\n        this.drawPlasma(ctx);\r\n\r\n        const rocketImg = state.assets?.get('rocket_body');\r\n        const engineImg = state.assets?.get('rocket_engine');\r\n\r\n        if (rocketImg && engineImg) {\r\n            ctx.drawImage(rocketImg, -20, 0, 40, 100);\r\n\r\n            ctx.save();\r\n            ctx.translate(0, 100);\r\n            ctx.rotate(this.gimbalAngle);\r\n            ctx.drawImage(engineImg, -15, -10, 30, 40);\r\n            ctx.restore();\r\n        } else {\r\n            ctx.fillStyle = '#eee';\r\n            ctx.fillRect(-20, 0, 40, 100);\r\n\r\n            ctx.save();\r\n            ctx.translate(0, 100);\r\n            ctx.rotate(this.gimbalAngle);\r\n            ctx.fillStyle = '#222';\r\n            ctx.beginPath();\r\n            ctx.moveTo(-10, 0);\r\n            ctx.lineTo(-15, 20);\r\n            ctx.lineTo(15, 20);\r\n            ctx.lineTo(10, 0);\r\n            ctx.fill();\r\n            ctx.restore();\r\n        }\r\n\r\n        // Deploy landing legs when low altitude\r\n        if ((state.groundY - this.y - this.h) / PIXELS_PER_METER < 200) {\r\n            ctx.fillStyle = '#111';\r\n            ctx.fillRect(-40, 90, 20, 5);\r\n            ctx.fillRect(20, 90, 20, 5);\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n}\r\n\r\n/**\r\n * Upper Stage - Second stage after booster separation\r\n * Contains payload fairing\r\n */\r\nexport class UpperStage extends Vessel {\r\n    /** Whether fairings have been jettisoned */\r\n    public fairingsDeployed: boolean = false;\r\n\r\n    /** Stage separation config */\r\n    public nextStage: StageSeparation;\r\n\r\n    constructor(x: number, y: number, vx: number = 0, vy: number = 0) {\r\n        super(x, y);\r\n        this.vx = vx;\r\n        this.vy = vy;\r\n        this.h = 60;\r\n        this.mass = CONFIG.MASS_UPPER;\r\n        this.maxThrust = CONFIG.MAX_THRUST_UPPER;\r\n        this.active = true;\r\n        this.ispVac = CONFIG.ISP_VAC_UPPER;\r\n        this.ispSL = CONFIG.ISP_SL_UPPER;\r\n\r\n        // Reliability: Vacuum engine\r\n        this.reliabilityConfig = {\r\n            mtbfEngine: 2000,      // Very reliable vacuum engine\r\n            mtbfStructure: 5000,   // Lighter structure, more fragile\r\n            mtbfElectronics: 3000,\r\n            ignitionReliability: 0.99,\r\n            wearFactor: 1.0\r\n        };\r\n\r\n        // Upper stage less stable without booster mass below\r\n        this.aeroConfig = UPPER_STAGE_AERO_CONFIG;\r\n        // Fairing provides protection during ascent\r\n        this.tpsConfig = UPPER_STAGE_TPS_CONFIG;\r\n        // Vacuum engine with slower spool-up\r\n        this.propConfig = UPPER_STAGE_PROP_CONFIG;\r\n        this.propState = createInitialPropulsionState(UPPER_STAGE_PROP_CONFIG);\r\n        this.ignitersRemaining = UPPER_STAGE_PROP_CONFIG.igniterCount;\r\n\r\n        this.nextStage = {\r\n            type: 'Payload',\r\n            separationVelocity: 2,\r\n            offsetY: -10\r\n        };\r\n    }\r\n\r\n    draw(ctx: CanvasRenderingContext2D, camY: number): void {\r\n        if (this.crashed) return;\r\n\r\n        ctx.save();\r\n        ctx.translate(this.x, this.y - camY);\r\n        ctx.rotate(this.angle);\r\n\r\n        this.drawPlasma(ctx);\r\n        this.drawShockwave(ctx);\r\n\r\n        const rocketImg = state.assets?.get('rocket_body');\r\n        const engineImg = state.assets?.get('rocket_engine');\r\n        const fairingImg = state.assets?.get('fairing');\r\n\r\n        if (rocketImg && engineImg) {\r\n            // Engine\r\n            ctx.save();\r\n            ctx.translate(0, 60);\r\n            ctx.drawImage(engineImg, -10, -5, 20, 25);\r\n            ctx.restore();\r\n\r\n            // Tank\r\n            ctx.drawImage(rocketImg, -20, 0, 40, 60);\r\n\r\n            // Fairing\r\n            if (!this.fairingsDeployed) {\r\n                if (fairingImg) {\r\n                    ctx.drawImage(fairingImg, -20, -40, 40, 40);\r\n                } else {\r\n                    ctx.fillStyle = '#fff';\r\n                    ctx.beginPath();\r\n                    ctx.moveTo(-20, 0);\r\n                    ctx.quadraticCurveTo(0, -40, 20, 0);\r\n                    ctx.fill();\r\n                }\r\n            } else {\r\n                // Exposed payload indicator\r\n                ctx.fillStyle = '#f1c40f';\r\n                ctx.fillRect(-10, -5, 20, 5);\r\n            }\r\n        } else {\r\n            // Engine\r\n            ctx.fillStyle = '#444';\r\n            ctx.beginPath();\r\n            ctx.moveTo(-10, 60);\r\n            ctx.lineTo(10, 60);\r\n            ctx.lineTo(15, 75);\r\n            ctx.lineTo(-15, 75);\r\n            ctx.fill();\r\n\r\n            // Tank\r\n            ctx.fillStyle = '#fff';\r\n            ctx.fillRect(-20, 0, 40, 60);\r\n\r\n            // Fairing or payload\r\n            if (!this.fairingsDeployed) {\r\n                ctx.beginPath();\r\n                ctx.moveTo(-20, 0);\r\n                ctx.quadraticCurveTo(0, -40, 20, 0);\r\n                ctx.fill();\r\n            } else {\r\n                ctx.fillStyle = '#f1c40f';\r\n                ctx.fillRect(-10, -5, 20, 5);\r\n            }\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n}\r\n\r\n/**\r\n * Payload - Satellite or other payload after deployment\r\n */\r\nexport class Payload extends Vessel {\r\n    /** Visual color */\r\n    public color: string = '#bdc3c7';\r\n\r\n    /** Stage separation config (for debugging/testing) */\r\n    public nextStage: StageSeparation;\r\n\r\n    constructor(x: number, y: number, vx: number = 0, vy: number = 0) {\r\n        super(x, y);\r\n        this.vx = vx;\r\n        this.vy = vy;\r\n        this.mass = 1000;\r\n        this.w = 20;\r\n        this.h = 20;\r\n        this.active = true;\r\n\r\n        // Payload has neutral stability (satellite shape)\r\n        this.aeroConfig = PAYLOAD_AERO_CONFIG;\r\n        // Full ablative heat shield for re-entry capability\r\n        this.tpsConfig = PAYLOAD_TPS_CONFIG;\r\n        // No main engine (satellite)\r\n        this.propConfig = PAYLOAD_PROP_CONFIG;\r\n        this.propState = createInitialPropulsionState(PAYLOAD_PROP_CONFIG);\r\n        this.ignitersRemaining = 0;\r\n\r\n        this.nextStage = {\r\n            type: 'Booster',\r\n            separationVelocity: 5,\r\n            offsetY: -30\r\n        };\r\n    }\r\n\r\n    draw(ctx: CanvasRenderingContext2D, camY: number): void {\r\n        ctx.save();\r\n        ctx.translate(this.x, this.y - camY);\r\n        ctx.rotate(this.angle);\r\n\r\n        // Satellite body\r\n        ctx.fillStyle = '#f1c40f';\r\n        ctx.fillRect(-10, -10, 20, 20);\r\n\r\n        // Solar panels\r\n        ctx.fillStyle = '#3498db';\r\n        ctx.fillRect(-40, -5, 30, 10);\r\n        ctx.fillRect(10, -5, 30, 10);\r\n\r\n        ctx.restore();\r\n    }\r\n}\r\n\r\n/**\r\n * Fairing - Payload fairing half after separation\r\n */\r\nexport class Fairing extends Vessel {\r\n    /** Which side (left=-1, right=1) */\r\n    public side: number;\r\n\r\n    constructor(x: number, y: number, vx: number = 0, vy: number = 0, side: number = 1) {\r\n        super(x, y);\r\n        this.vx = vx + side * 5; // Lateral separation velocity\r\n        this.vy = vy;\r\n        this.side = side;\r\n        this.active = false;  // No thrust\r\n        this.h = 40;\r\n        this.cd = 2.0;  // High drag\r\n    }\r\n\r\n    draw(ctx: CanvasRenderingContext2D, camY: number): void {\r\n        ctx.save();\r\n        ctx.translate(this.x, this.y - camY);\r\n        ctx.rotate(this.angle);\r\n\r\n        this.drawPlasma(ctx);\r\n\r\n        ctx.fillStyle = '#fff';\r\n        ctx.beginPath();\r\n        if (this.side === -1) {\r\n            ctx.moveTo(0, 0);\r\n            ctx.lineTo(-20, 0);\r\n            ctx.quadraticCurveTo(0, -40, 0, 0);\r\n        } else {\r\n            ctx.moveTo(0, 0);\r\n            ctx.lineTo(20, 0);\r\n            ctx.quadraticCurveTo(0, -40, 0, 0);\r\n        }\r\n        ctx.fill();\r\n\r\n        ctx.restore();\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\ThermalProtection.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\physics\\Vessel.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SCALE_HEIGHT' is defined but never used.","line":19,"column":5,"messageId":"unusedVar","endLine":19,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SCALE_HEIGHT"},"fix":{"range":[490,509],"text":""},"desc":"Remove unused variable \"SCALE_HEIGHT\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SPEED_OF_SOUND' is defined but never used.","line":21,"column":5,"messageId":"unusedVar","endLine":21,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SPEED_OF_SOUND"},"fix":{"range":[523,544],"text":""},"desc":"Remove unused variable \"SPEED_OF_SOUND\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AerodynamicForces' is defined but never used.","line":34,"column":5,"messageId":"unusedVar","endLine":34,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AerodynamicForces"},"fix":{"range":[892,916],"text":""},"desc":"Remove unused variable \"AerodynamicForces\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'attemptIgnition' is defined but never used.","line":55,"column":5,"messageId":"unusedVar","endLine":55,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"attemptIgnition"},"fix":{"range":[1417,1439],"text":""},"desc":"Remove unused variable \"attemptIgnition\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'commandShutdown' is defined but never used.","line":56,"column":5,"messageId":"unusedVar","endLine":56,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"commandShutdown"},"fix":{"range":[1439,1461],"text":""},"desc":"Remove unused variable \"commandShutdown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'t' is defined but never used. Allowed unused args must match /^_/u.","line":154,"column":47,"messageId":"unusedVar","endLine":154,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'dt' is defined but never used. Allowed unused args must match /^_/u.","line":154,"column":58,"messageId":"unusedVar","endLine":154,"endColumn":60},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'q' is assigned a value but never used.","line":166,"column":15,"messageId":"unusedVar","endLine":166,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'dt' is defined but never used. Allowed unused args must match /^_/u.","line":286,"column":28,"messageId":"unusedVar","endLine":286,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'altitude' is defined but never used. Allowed unused args must match /^_/u.","line":451,"column":54,"messageId":"unusedVar","endLine":451,"endColumn":62},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ctx' is defined but never used. Allowed unused args must match /^_/u.","line":737,"column":10,"messageId":"unusedVar","endLine":737,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'camY' is defined but never used. Allowed unused args must match /^_/u.","line":737,"column":41,"messageId":"unusedVar","endLine":737,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Vessel Base Class\r\n * \r\n * Abstract base for all rocket stages and debris.\r\n * Implements RK4 integration for accurate orbital mechanics.\r\n * \r\n * Physics model includes:\r\n * - Thrust with pressure-dependent Isp\r\n * - Atmospheric drag with transonic effects\r\n * - Inverse-square gravity\r\n * - Centrifugal acceleration for orbital motion\r\n */\r\n\r\nimport { IVessel, PhysicsState, Derivatives, OrbitalElements } from '../types';\r\nimport {\r\n    CONFIG,\r\n    PIXELS_PER_METER,\r\n    RHO_SL,\r\n    SCALE_HEIGHT,\r\n    R_EARTH,\r\n    SPEED_OF_SOUND,\r\n    getAtmosphericDensity,\r\n    getGravity,\r\n    getDynamicPressure,\r\n    getTransonicDragMultiplier,\r\n    getMachNumber,\r\n    DT\r\n} from '../constants';\r\nimport { state, addParticle, currentWindVelocity, currentDensityMultiplier } from '../state';\r\nimport { Particle } from './Particle';\r\nimport {\r\n    AerodynamicsConfig,\r\n    AerodynamicState,\r\n    AerodynamicForces,\r\n    DEFAULT_AERO_CONFIG,\r\n    calculateAerodynamicState,\r\n    calculateAerodynamicForces,\r\n    calculateAerodynamicDamageRate\r\n} from './Aerodynamics';\r\nimport {\r\n    TPSConfig,\r\n    ThermalState,\r\n    DEFAULT_TPS_CONFIG,\r\n    updateThermalState,\r\n    getThermalDamageRate,\r\n    createInitialThermalState\r\n} from './ThermalProtection';\r\nimport {\r\n    PropulsionConfig,\r\n    PropulsionState,\r\n    EngineState,\r\n    FULLSTACK_PROP_CONFIG,\r\n    createInitialPropulsionState,\r\n    updatePropulsionState,\r\n    attemptIgnition,\r\n    commandShutdown,\r\n    getIgnitionFailureMessage\r\n} from './Propulsion';\r\nimport {\r\n    ReliabilitySystem,\r\n    ReliabilityConfig,\r\n    DEFAULT_RELIABILITY_CONFIG\r\n} from './Reliability';\r\n\r\nexport class Vessel implements IVessel {\r\n    // Position (pixels)\r\n    public x: number;\r\n    public y: number;\r\n\r\n    // Velocity (m/s)\r\n    public vx: number = 0;\r\n    public vy: number = 0;\r\n\r\n    // Orientation (radians)\r\n    public angle: number = 0;\r\n    public gimbalAngle: number = 0;\r\n\r\n    // Physical properties\r\n    public mass: number = 1000;\r\n    public w: number = 40;        // Width (pixels)\r\n    public h: number = 100;       // Height (pixels)\r\n\r\n    // Engine state\r\n    public throttle: number = 0;\r\n    public fuel: number = 1.0;    // 0-1 normalized\r\n    public active: boolean = true;\r\n    public maxThrust: number = 100000;\r\n\r\n    // Aerodynamics (legacy)\r\n    public cd: number = CONFIG.DRAG_COEFF;\r\n    public q: number = 0;         // Dynamic pressure\r\n\r\n    // Advanced Aerodynamics\r\n    public aeroConfig: AerodynamicsConfig = DEFAULT_AERO_CONFIG;\r\n    public aeroState: AerodynamicState | null = null;\r\n    public aoa: number = 0;                    // Angle of Attack (radians)\r\n    public stabilityMargin: number = 0;        // (CP - CoM) / length\r\n    public isAeroStable: boolean = true;       // CP behind CoM\r\n    public liftForce: number = 0;              // Current lift force (N)\r\n    public dragForce: number = 0;              // Current drag force (N)\r\n\r\n    // Propulsion\r\n    public ispVac: number = 300;\r\n    public ispSL: number = 280;\r\n\r\n    // State\r\n    public crashed: boolean = false;\r\n    public health: number = 100;\r\n    public apogee: number = 0;\r\n\r\n    // Thermal Protection System\r\n    public tpsConfig: TPSConfig = DEFAULT_TPS_CONFIG;\r\n    public thermalState: ThermalState = createInitialThermalState();\r\n    public skinTemp: number = 293;              // Skin temperature (K)\r\n    public heatShieldRemaining: number = 1.0;   // Heat shield fraction (0-1)\r\n    public isAblating: boolean = false;         // Currently ablating\r\n    public isThermalCritical: boolean = false;  // Temperature critical\r\n\r\n    // Propulsion State Machine\r\n    public propConfig: PropulsionConfig = FULLSTACK_PROP_CONFIG;\r\n    public propState: PropulsionState = createInitialPropulsionState(FULLSTACK_PROP_CONFIG);\r\n    public engineState: EngineState = 'off';    // Current engine state\r\n    public ignitersRemaining: number = 3;       // Remaining igniter cartridges\r\n    public ullageSettled: boolean = true;       // Fuel settled for ignition\r\n    public actualThrottle: number = 0;          // Lagged throttle output\r\n\r\n    // Reliability System\r\n    public reliability: ReliabilitySystem = new ReliabilitySystem();\r\n    public reliabilityConfig: ReliabilityConfig = DEFAULT_RELIABILITY_CONFIG;\r\n\r\n    // Orbit prediction cache\r\n    public orbitPath: OrbitalElements[] | null = null;\r\n    public lastOrbitUpdate: number = 0;\r\n\r\n    /**\r\n     * Create a new vessel\r\n     * \r\n     * @param x - Initial X position (pixels)\r\n     * @param y - Initial Y position (pixels)\r\n     */\r\n    constructor(x: number, y: number) {\r\n        this.x = x;\r\n        this.y = y;\r\n    }\r\n\r\n    /**\r\n     * Calculate physics derivatives for RK4 integration\r\n     * \r\n     * @param s - Current state\r\n     * @param t - Current time (unused, for interface)\r\n     * @param dt - Time step\r\n     * @returns Derivatives for integration\r\n     */\r\n    protected getDerivatives(s: PhysicsState, t: number, dt: number): Derivatives {\r\n        const altitude = (state.groundY - s.y * PIXELS_PER_METER - this.h) / PIXELS_PER_METER;\r\n        const safeAlt = Math.max(0, altitude);\r\n\r\n        // Atmospheric density\r\n        const rho = getAtmosphericDensity(safeAlt);\r\n\r\n        // Velocity magnitude (relative to wind for aerodynamic calculations)\r\n        const relVx = s.vx - currentWindVelocity.x;\r\n        const relVy = s.vy - currentWindVelocity.y;\r\n        const vSq = relVx * relVx + relVy * relVy;\r\n        const v = Math.sqrt(vSq);\r\n        const q = getDynamicPressure(rho * currentDensityMultiplier, v);\r\n        const mach = getMachNumber(v);\r\n\r\n        // Calculate aerodynamic state using relative velocity (AoA, CP, CoM, stability)\r\n        const vehicleLengthM = this.h / PIXELS_PER_METER;\r\n        const fuelFraction = this.fuel;  // 0-1 normalized fuel level\r\n\r\n        const aeroState = calculateAerodynamicState(\r\n            this.aeroConfig,\r\n            relVx,\r\n            relVy,\r\n            this.angle,\r\n            fuelFraction,\r\n            vehicleLengthM,\r\n            mach\r\n        );\r\n\r\n        // Calculate aerodynamic forces using relative velocity (lift and drag)\r\n        const aeroForces = calculateAerodynamicForces(\r\n            this.aeroConfig,\r\n            aeroState,\r\n            safeAlt,\r\n            v,\r\n            relVx,\r\n            relVy\r\n        );\r\n\r\n        // Apply transonic drag multiplier to base drag\r\n        const machMult = getTransonicDragMultiplier(mach);\r\n        const adjustedDragX = aeroForces.forceX * machMult;\r\n        const adjustedDragY = aeroForces.forceY * machMult;\r\n\r\n        // Gravity (inverse square law)\r\n        const realRad = safeAlt + R_EARTH;\r\n        const g = getGravity(safeAlt);\r\n\r\n        // Initialize forces\r\n        let fx = 0;\r\n        let fy = s.mass * g;  // Weight (positive = downward in our coordinate system)\r\n\r\n        // Centrifugal acceleration (for orbital motion)\r\n        const f_cent = (s.mass * s.vx * s.vx) / realRad;\r\n        fy -= f_cent;\r\n\r\n        // Add aerodynamic forces (lift and drag combined)\r\n        fx += adjustedDragX;\r\n        fy += adjustedDragY;\r\n\r\n        // Thrust (uses propulsion state machine for realistic spool-up)\r\n        let flowRate = 0;\r\n        if (this.active && this.actualThrottle > 0 && this.fuel > 0) {\r\n            // Pressure-dependent Isp\r\n            const pRatio = rho / RHO_SL;\r\n            const isp = this.ispVac + (this.ispSL - this.ispVac) * pRatio;\r\n            const thrust = this.actualThrottle * this.maxThrust * (isp / this.ispVac);\r\n\r\n            // Thrust direction based on vessel angle\r\n            fx += Math.sin(this.angle) * thrust;\r\n            fy -= Math.cos(this.angle) * thrust;\r\n\r\n            // Fuel consumption rate (kg/s)\r\n            flowRate = (this.actualThrottle * this.maxThrust) / (9.8 * this.ispVac);\r\n        }\r\n\r\n        // Store aerodynamic state for telemetry (will be updated after integration)\r\n        this.aoa = aeroState.aoa;\r\n        this.stabilityMargin = aeroState.stabilityMargin;\r\n        this.isAeroStable = aeroState.isStable;\r\n        this.liftForce = aeroForces.lift;\r\n        this.dragForce = aeroForces.drag;\r\n        this.aeroState = aeroState;\r\n\r\n        return {\r\n            dx: s.vx,\r\n            dy: s.vy,\r\n            dvx: fx / s.mass,\r\n            dvy: fy / s.mass,\r\n            dmass: -flowRate\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Apply physics update using RK4 integration\r\n     * \r\n     * @param dt - Time step (seconds)\r\n     * @param keys - Input keys (legacy compatibility)\r\n     */\r\n    applyPhysics(dt: number, keys: Record<string, boolean>): void {\r\n        if (this.crashed) return;\r\n\r\n        // Apply control input\r\n        const isBooster = this.constructor.name === 'Booster';\r\n        this.control(dt, keys, isBooster);\r\n\r\n        // Run physics integration\r\n        this.updatePhysics(dt);\r\n    }\r\n\r\n    /**\r\n     * Control input handling (can be overridden by subclasses)\r\n     */\r\n    protected control(dt: number, keys: Record<string, boolean>, isBooster: boolean): void {\r\n        if (state.autopilotEnabled && isBooster) {\r\n            this.runAutopilot(dt);\r\n        } else {\r\n            let targetGimbal = 0;\r\n            if (keys['ArrowLeft']) targetGimbal = 0.2;\r\n            else if (keys['ArrowRight']) targetGimbal = -0.2;\r\n\r\n            this.gimbalAngle += (targetGimbal - this.gimbalAngle) * 10 * dt;\r\n\r\n            if (Math.abs(this.gimbalAngle) > 0.001) {\r\n                this.angle -= this.gimbalAngle * 2.0 * dt;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Autopilot (can be overridden by subclasses like Booster)\r\n     */\r\n    protected runAutopilot(dt: number): void {\r\n        // Default: no autopilot\r\n    }\r\n\r\n    /**\r\n     * RK4 integration step\r\n     */\r\n    protected updatePhysics(dt: number): void {\r\n        if (this.crashed) return;\r\n\r\n        // Convert to meters for physics\r\n        const stateDict: PhysicsState = {\r\n            x: this.x / PIXELS_PER_METER,\r\n            y: this.y / PIXELS_PER_METER,\r\n            vx: this.vx,\r\n            vy: this.vy,\r\n            mass: this.mass\r\n        };\r\n\r\n        // RK4 evaluation helper\r\n        const evaluate = (s: PhysicsState, t: number, dt: number, d: Derivatives | null): Derivatives => {\r\n            const tempState: PhysicsState = {\r\n                x: s.x + (d ? d.dx * dt : 0),\r\n                y: s.y + (d ? d.dy * dt : 0),\r\n                vx: s.vx + (d ? d.dvx * dt : 0),\r\n                vy: s.vy + (d ? d.dvy * dt : 0),\r\n                mass: s.mass\r\n            };\r\n            return this.getDerivatives(tempState, t, dt);\r\n        };\r\n\r\n        // RK4 integration\r\n        const k1 = evaluate(stateDict, 0, 0, null);\r\n        const k2 = evaluate(stateDict, 0, dt * 0.5, k1);\r\n        const k3 = evaluate(stateDict, 0, dt * 0.5, k2);\r\n        const k4 = evaluate(stateDict, 0, dt, k3);\r\n\r\n        // Weighted average\r\n        const dxdt = (k1.dx + 2 * k2.dx + 2 * k3.dx + k4.dx) / 6;\r\n        const dydt = (k1.dy + 2 * k2.dy + 2 * k3.dy + k4.dy) / 6;\r\n        const dvxdt = (k1.dvx + 2 * k2.dvx + 2 * k3.dvx + k4.dvx) / 6;\r\n        const dvydt = (k1.dvy + 2 * k2.dvy + 2 * k3.dvy + k4.dvy) / 6;\r\n\r\n        // Apply integration result\r\n        this.vx += dvxdt * dt;\r\n        this.vy += dvydt * dt;\r\n        this.x += dxdt * dt * PIXELS_PER_METER;\r\n        this.y += dydt * dt * PIXELS_PER_METER;\r\n\r\n        // Fuel consumption (uses actual throttle, not commanded)\r\n        if (this.actualThrottle > 0 && this.fuel > 0) {\r\n            const flowRate = (this.actualThrottle * this.maxThrust) / (9.8 * this.ispVac);\r\n            this.fuel -= (flowRate / CONFIG.FUEL_MASS) * dt;\r\n            this.mass -= flowRate * dt;\r\n        }\r\n\r\n        // Update dynamic pressure\r\n        const altitude = (state.groundY - this.y - this.h) / PIXELS_PER_METER;\r\n        const rho = getAtmosphericDensity(altitude);\r\n        const v = Math.sqrt(this.vx ** 2 + this.vy ** 2);\r\n        this.q = getDynamicPressure(rho, v);\r\n\r\n        // Update propulsion state (spool-up/down, ullage, igniters)\r\n        this.updatePropulsionState(v, altitude, dt);\r\n\r\n        // Update thermal state\r\n        this.updateThermalState(v, Math.max(0, altitude), dt);\r\n\r\n        // Update reliability state\r\n        this.updateReliability(dt);\r\n\r\n        // Aerodynamic stress damage\r\n        this.checkAerodynamicStress(v, altitude);\r\n\r\n        // Ground collision\r\n        this.checkGroundCollision();\r\n    }\r\n\r\n    /**\r\n     * Update thermal protection system state\r\n     */\r\n    private updateThermalState(velocity: number, altitude: number, dt: number): void {\r\n        // Update thermal state using TPS module\r\n        this.thermalState = updateThermalState(\r\n            this.tpsConfig,\r\n            this.thermalState,\r\n            velocity,\r\n            altitude,\r\n            this.aoa,\r\n            dt\r\n        );\r\n\r\n        // Update public properties for HUD display\r\n        this.skinTemp = this.thermalState.skinTemp;\r\n        this.heatShieldRemaining = this.thermalState.heatShieldRemaining;\r\n        this.isAblating = this.thermalState.isAblating;\r\n        this.isThermalCritical = this.thermalState.isCritical;\r\n\r\n        // Apply thermal damage to health\r\n        const thermalDamageRate = getThermalDamageRate(this.thermalState, this.tpsConfig);\r\n        if (thermalDamageRate > 0) {\r\n            this.health -= thermalDamageRate * dt;\r\n\r\n            // Spawn debris when taking thermal damage\r\n            if (Math.random() > 0.9) {\r\n                addParticle(new Particle(this.x, this.y + this.h / 2, 'debris'));\r\n            }\r\n\r\n            // Log thermal warning\r\n            if (this.isThermalCritical && state.missionLog) {\r\n                state.missionLog.log(\r\n                    `THERMAL WARNING: Skin temp ${Math.round(this.skinTemp - 273)}°C`,\r\n                    \"warn\"\r\n                );\r\n            }\r\n        }\r\n\r\n        // Structural failure from thermal overload\r\n        if (this.health <= 0 && this.thermalState.thermalDamage > 50) {\r\n            if (state.missionLog) {\r\n                state.missionLog.log(\"STRUCTURAL FAILURE: THERMAL OVERLOAD\", \"warn\");\r\n            }\r\n            this.explode();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update propulsion state machine\r\n     * Handles engine spool-up/down, ullage, and igniter management\r\n     */\r\n    private updatePropulsionState(velocity: number, altitude: number, dt: number): void {\r\n        // Calculate current acceleration for ullage check\r\n        const g = getGravity(Math.max(0, altitude));\r\n        const currentAccel = this.actualThrottle > 0\r\n            ? (this.actualThrottle * this.maxThrust / this.mass) - g\r\n            : g;  // On ground, gravity settles fuel\r\n\r\n        // Update propulsion state\r\n        this.propState = updatePropulsionState(\r\n            this.propState,\r\n            this.propConfig,\r\n            this.throttle,  // commanded throttle\r\n            this.fuel > 0,\r\n            Math.abs(currentAccel),\r\n            dt\r\n        );\r\n\r\n        // Copy state to public properties for HUD display\r\n        this.engineState = this.propState.engineState;\r\n        this.ignitersRemaining = this.propState.ignitersRemaining;\r\n        this.ullageSettled = this.propState.ullageSettled;\r\n        this.actualThrottle = this.propState.actualThrottle;\r\n\r\n        // Log ignition failures\r\n        const failureMsg = getIgnitionFailureMessage(this.propState);\r\n        if (failureMsg && state.missionLog) {\r\n            state.missionLog.log(failureMsg, \"warn\");\r\n            // Reset the failure message after logging\r\n            this.propState.lastIgnitionResult = 'none';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check for aerodynamic overstress using advanced stability analysis\r\n     */\r\n    private checkAerodynamicStress(velocity: number, altitude: number): void {\r\n        // Use the aerodynamic state if available for advanced damage calculation\r\n        if (this.aeroState) {\r\n            const damageRate = calculateAerodynamicDamageRate(this.aeroState, this.q);\r\n\r\n            if (damageRate > 0) {\r\n                // Apply damage based on rate (per second, scaled to frame time)\r\n                this.health -= damageRate * (1 / 60); // Assuming 60 FPS\r\n\r\n                // Spawn debris particles when taking damage\r\n                if (Math.random() > 0.8) {\r\n                    addParticle(new Particle(this.x, this.y + this.h / 2, 'debris'));\r\n                }\r\n\r\n                // Log instability warning once when stability margin goes negative\r\n                if (!this.isAeroStable && this.q > 5000 && state.missionLog) {\r\n                    state.missionLog.log(\r\n                        `STABILITY WARNING: AoA=${(Math.abs(this.aoa) * 180 / Math.PI).toFixed(1)}° Margin=${(this.stabilityMargin * 100).toFixed(1)}%`,\r\n                        \"warn\"\r\n                    );\r\n                }\r\n            }\r\n        } else {\r\n            // Fallback to legacy damage calculation\r\n            let alpha = 0;\r\n            if (velocity > 10) {\r\n                const velAngle = Math.atan2(this.vx, -this.vy);\r\n                alpha = Math.abs(this.angle - velAngle);\r\n                if (alpha > Math.PI) alpha = Math.PI * 2 - alpha;\r\n            }\r\n\r\n            if (this.q > 5000 && alpha > 0.2) {\r\n                this.health -= 100 * (1 / 60);\r\n                if (Math.random() > 0.8) {\r\n                    addParticle(new Particle(this.x, this.y + this.h / 2, 'debris'));\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this.health <= 0) {\r\n            if (state.missionLog) {\r\n                state.missionLog.log(\"STRUCTURAL FAILURE DUE TO AERO FORCES\", \"warn\");\r\n            }\r\n            this.explode();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check for ground collision\r\n     */\r\n    private checkGroundCollision(): void {\r\n        if (this.y + this.h > state.groundY) {\r\n            this.y = state.groundY - this.h;\r\n\r\n            // Check landing velocity and angle\r\n            if (this.vy > 15 || Math.abs(this.angle) > 0.3) {\r\n                this.explode();\r\n            } else {\r\n                // Successful landing\r\n                this.vy = 0;\r\n                this.vx = 0;\r\n\r\n                // Only cut throttle if not trying to launch\r\n                if (this.engineState !== 'starting' && this.engineState !== 'running') {\r\n                    this.throttle = 0;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Explode the vessel\r\n     */\r\n    explode(): void {\r\n        if (this.crashed) return;\r\n\r\n        this.crashed = true;\r\n        this.active = false;\r\n        this.throttle = 0;\r\n\r\n        if (state.audio) {\r\n            state.audio.playExplosion();\r\n        }\r\n\r\n        // Spawn explosion particles\r\n        for (let i = 0; i < 30; i++) {\r\n            addParticle(new Particle(\r\n                this.x + Math.random() * 20 - 10,\r\n                this.y + this.h - Math.random() * 20,\r\n                'fire'\r\n            ));\r\n            addParticle(new Particle(\r\n                this.x,\r\n                this.y + this.h / 2,\r\n                'debris'\r\n            ));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update reliability system\r\n     */\r\n    private updateReliability(dt: number): void {\r\n        if (!this.active || this.crashed) return;\r\n\r\n        // Calculate stress factor\r\n        // Base stress is 1.0 when active\r\n        // High Q or high G adds stress\r\n        let stress = 0;\r\n\r\n        if (this.actualThrottle > 0) {\r\n            stress = 1.0;\r\n\r\n            // Add stress from dynamic pressure\r\n            if (this.q > 10000) stress += 0.5;\r\n\r\n            // Add stress from high angle of attack\r\n            if (Math.abs(this.aoa) > 0.1) stress += 0.5;\r\n        }\r\n\r\n        const failures = this.reliability.update(dt, stress);\r\n\r\n        // Handle new failures\r\n        for (const failure of failures) {\r\n            switch (failure) {\r\n                case 'ENGINE_FLAME_OUT':\r\n                    this.active = false;\r\n                    this.throttle = 0;\r\n                    this.actualThrottle = 0; // Immediate cut\r\n                    break;\r\n\r\n                case 'ENGINE_EXPLOSION':\r\n                    this.explode();\r\n                    break;\r\n\r\n                case 'STRUCTURAL_FATIGUE':\r\n                    // Immediate structural failure\r\n                    this.health = 0;\r\n                    this.explode();\r\n                    break;\r\n\r\n                case 'GIMBAL_LOCK':\r\n                    // Gimbal stuck - disable control\r\n                    // This is handled in control() by checking failures\r\n                    break;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Spawn exhaust particles\r\n     * \r\n     * @param timeScale - Time warp multiplier\r\n     */\r\n    spawnExhaust(timeScale: number): void {\r\n        if (this.throttle <= 0 || this.fuel <= 0 || this.crashed) return;\r\n\r\n        const rawCount = Math.ceil(this.throttle * 5 * timeScale);\r\n\r\n        // Clamp particle count to prevent performance issues during time warp\r\n        const MAX_PARTICLES = 20;\r\n        let count = rawCount;\r\n        let sizeScale = 1.0;\r\n\r\n        if (count > MAX_PARTICLES) {\r\n            count = MAX_PARTICLES;\r\n            // Scale size by sqrt of count reduction to maintain visual mass (area)\r\n            sizeScale = Math.sqrt(rawCount / count);\r\n        }\r\n\r\n        const altitude = (state.groundY - this.y - this.h) / PIXELS_PER_METER;\r\n        const vacuumFactor = Math.min(Math.max(0, altitude) / 30000, 1.0);\r\n\r\n        // Exhaust spreads more in vacuum\r\n        const spreadBase = 0.1 + (vacuumFactor * 1.5);\r\n\r\n        // Exhaust position (engine nozzle)\r\n        const exX = this.x - Math.sin(this.angle) * this.h;\r\n        const exY = this.y + Math.cos(this.angle) * this.h;\r\n        const ejectionSpeed = 30 + (this.throttle * 20);\r\n\r\n        for (let i = 0; i < count; i++) {\r\n            const particleAngle = this.angle + Math.PI + (Math.random() - 0.5) * spreadBase;\r\n            const ejectVx = Math.sin(particleAngle) * ejectionSpeed;\r\n            const ejectVy = -Math.cos(particleAngle) * ejectionSpeed;\r\n\r\n            // Convert rocket velocity from m/s to pixels/frame\r\n            const rocketVxPx = this.vx * PIXELS_PER_METER * DT;\r\n            const rocketVyPx = this.vy * PIXELS_PER_METER * DT;\r\n\r\n            const p = new Particle(exX, exY, 'fire', rocketVxPx + ejectVx, rocketVyPx + ejectVy);\r\n\r\n            // Apply visual scaling\r\n            if (sizeScale > 1.0) {\r\n                p.size *= sizeScale;\r\n            }\r\n\r\n            if (vacuumFactor > 0.8) {\r\n                p.decay *= 0.5; // Particles last longer in vacuum\r\n            }\r\n            addParticle(p);\r\n\r\n            // Add smoke at lower altitudes\r\n            if (Math.random() > 0.5 && vacuumFactor < 0.5) {\r\n                const s = new Particle(exX, exY, 'smoke', rocketVxPx + ejectVx, rocketVyPx + ejectVy);\r\n                if (sizeScale > 1.0) {\r\n                    s.size *= sizeScale;\r\n                }\r\n                addParticle(s);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draw plasma heating effects based on skin temperature\r\n     */\r\n    protected drawPlasma(ctx: CanvasRenderingContext2D): void {\r\n        // Start showing plasma effects above 500K (227°C)\r\n        const plasmaThreshold = 500;\r\n\r\n        if (this.skinTemp > plasmaThreshold) {\r\n            // Intensity based on temperature (500K to 2000K range)\r\n            const tempRange = this.skinTemp - plasmaThreshold;\r\n            const intensity = Math.min(tempRange / 1500, 0.9);\r\n\r\n            ctx.save();\r\n            ctx.globalCompositeOperation = 'screen';\r\n\r\n            // Color shifts from orange to white with temperature\r\n            const r = 255;\r\n            const g = Math.floor(100 + intensity * 155); // 100 -> 255\r\n            const b = Math.floor(50 + intensity * 200);  // 50 -> 250\r\n\r\n            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${intensity})`;\r\n            ctx.beginPath();\r\n            ctx.arc(0, this.h, 20 + Math.random() * 10 * intensity, 0, Math.PI * 2);\r\n            ctx.fill();\r\n\r\n            // Nose cone glow\r\n            if (intensity > 0.3) {\r\n                ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${intensity * 0.6})`;\r\n                ctx.beginPath();\r\n                ctx.arc(0, -10, 15 + Math.random() * 5, 0, Math.PI * 2);\r\n                ctx.fill();\r\n            }\r\n\r\n            // Body streamers at high temps\r\n            if (intensity > 0.2) {\r\n                ctx.fillStyle = `rgba(255, 200, 100, ${intensity * 0.4})`;\r\n                ctx.fillRect(-this.w / 2 - 5, 20, this.w + 10, this.h - 20);\r\n            }\r\n\r\n            // Ablation particles when shield is active\r\n            if (this.isAblating && Math.random() > 0.7) {\r\n                ctx.fillStyle = `rgba(255, 255, 200, 0.8)`;\r\n                const sparkX = (Math.random() - 0.5) * this.w;\r\n                const sparkY = Math.random() * this.h;\r\n                ctx.beginPath();\r\n                ctx.arc(sparkX, sparkY, 2, 0, Math.PI * 2);\r\n                ctx.fill();\r\n            }\r\n\r\n            ctx.restore();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draw shockwave effects\r\n     */\r\n    protected drawShockwave(ctx: CanvasRenderingContext2D): void {\r\n        if (this.q > 5000 && this.vy < -50) {\r\n            const intensity = Math.min((this.q - 5000) / 10000, 0.5);\r\n            ctx.save();\r\n            ctx.strokeStyle = `rgba(255, 255, 255, ${intensity})`;\r\n            ctx.lineWidth = 3;\r\n            ctx.beginPath();\r\n            ctx.moveTo(-50, 40);\r\n            ctx.quadraticCurveTo(0, -80, 50, 40);\r\n            ctx.stroke();\r\n            ctx.restore();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draw the vessel (to be overridden by subclasses)\r\n     */\r\n    draw(ctx: CanvasRenderingContext2D, camY: number): void {\r\n        // Base implementation does nothing\r\n        // Subclasses implement specific rendering\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\safety\\FaultInjector.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\safety\\FlightTermination.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\safety\\LaunchChecklist.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\state.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\telemetry\\BlackBoxRecorder.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getAtmosphericDensity' is defined but never used.","line":9,"column":28,"messageId":"unusedVar","endLine":9,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getAtmosphericDensity"},"fix":{"range":[249,272],"text":""},"desc":"Remove unused variable \"getAtmosphericDensity\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * BlackBoxRecorder - Flight Data Recorder\r\n * \r\n * Records all flight variables at 20Hz for post-flight analysis.\r\n * Provides export functionality to CSV and JSON formats.\r\n */\r\n\r\nimport { IVessel } from '../types';\r\nimport { PIXELS_PER_METER, getAtmosphericDensity, getMachNumber } from '../constants';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\n/**\r\n * A single frame of flight data\r\n */\r\nexport interface FlightDataFrame {\r\n    t: number;           // Mission time (seconds)\r\n    alt: number;         // Altitude (meters)\r\n    vx: number;          // Velocity X (m/s)\r\n    vy: number;          // Velocity Y (m/s)\r\n    speed: number;       // Total speed (m/s)\r\n    accelX: number;      // Acceleration X (m/s²)\r\n    accelY: number;      // Acceleration Y (m/s²)\r\n    gForce: number;      // G-force (g)\r\n    angle: number;       // Pitch angle (degrees)\r\n    gimbal: number;      // Gimbal angle (degrees)\r\n    throttle: number;    // Throttle (0-1)\r\n    mass: number;        // Total mass (kg)\r\n    fuel: number;        // Fuel fraction (0-1)\r\n    q: number;           // Dynamic pressure (Pa)\r\n    mach: number;        // Mach number\r\n    aoa: number;         // Angle of attack (degrees)\r\n    skinTemp: number;    // Skin temperature (K)\r\n    engineState: string; // Engine state\r\n    apogee: number;      // Predicted apogee (m)\r\n}\r\n\r\n/**\r\n * Recording state\r\n */\r\nexport type RecordingState = 'idle' | 'recording' | 'paused' | 'stopped';\r\n\r\n/**\r\n * Flight summary metadata\r\n */\r\nexport interface FlightSummary {\r\n    missionName: string;\r\n    startTime: Date;\r\n    endTime: Date | null;\r\n    duration: number;        // seconds\r\n    maxAltitude: number;     // meters\r\n    maxVelocity: number;     // m/s\r\n    maxGForce: number;       // g\r\n    maxQ: number;            // Pa\r\n    maxMach: number;\r\n    finalState: string;      // 'landed' | 'crashed' | 'in-flight'\r\n    frameCount: number;\r\n    sampleRate: number;      // Hz\r\n}\r\n\r\n// ============================================================================\r\n// BlackBoxRecorder Class\r\n// ============================================================================\r\n\r\nexport class BlackBoxRecorder {\r\n    /** Recorded data frames */\r\n    private frames: FlightDataFrame[] = [];\r\n\r\n    /** Current recording state */\r\n    private state: RecordingState = 'idle';\r\n\r\n    /** Mission start time */\r\n    private missionStartTime: number = 0;\r\n\r\n    /** Last sample time for rate limiting */\r\n    private lastSampleTime: number = 0;\r\n\r\n    /** Sample interval in seconds (20Hz = 0.05s) */\r\n    private readonly sampleInterval: number = 0.05;\r\n\r\n    /** Ground Y position for altitude calculation */\r\n    private groundY: number;\r\n\r\n    /** Previous velocity for acceleration calculation */\r\n    private prevVx: number = 0;\r\n    private prevVy: number = 0;\r\n    private prevTime: number = 0;\r\n\r\n    /** Flight summary statistics */\r\n    private summary: FlightSummary;\r\n\r\n    /** Mission name */\r\n    private missionName: string = 'Mission';\r\n\r\n    constructor(groundY: number) {\r\n        this.groundY = groundY;\r\n        this.summary = this.createInitialSummary();\r\n    }\r\n\r\n    /**\r\n     * Create initial summary\r\n     */\r\n    private createInitialSummary(): FlightSummary {\r\n        return {\r\n            missionName: this.missionName,\r\n            startTime: new Date(),\r\n            endTime: null,\r\n            duration: 0,\r\n            maxAltitude: 0,\r\n            maxVelocity: 0,\r\n            maxGForce: 0,\r\n            maxQ: 0,\r\n            maxMach: 0,\r\n            finalState: 'in-flight',\r\n            frameCount: 0,\r\n            sampleRate: 20\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Start recording\r\n     */\r\n    start(missionName: string = 'Mission'): void {\r\n        this.missionName = missionName;\r\n        this.frames = [];\r\n        this.state = 'recording';\r\n        this.missionStartTime = performance.now() / 1000;\r\n        this.lastSampleTime = 0;\r\n        this.prevVx = 0;\r\n        this.prevVy = 0;\r\n        this.prevTime = 0;\r\n        this.summary = this.createInitialSummary();\r\n        this.summary.missionName = missionName;\r\n        this.summary.startTime = new Date();\r\n    }\r\n\r\n    /**\r\n     * Stop recording\r\n     */\r\n    stop(finalState: 'landed' | 'crashed' | 'in-flight' = 'in-flight'): void {\r\n        if (this.state === 'recording' || this.state === 'paused') {\r\n            this.state = 'stopped';\r\n            this.summary.endTime = new Date();\r\n            this.summary.finalState = finalState;\r\n            this.summary.frameCount = this.frames.length;\r\n\r\n            if (this.frames.length > 0) {\r\n                const lastFrame = this.frames[this.frames.length - 1];\r\n                if (lastFrame) {\r\n                    this.summary.duration = lastFrame.t;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Pause recording\r\n     */\r\n    pause(): void {\r\n        if (this.state === 'recording') {\r\n            this.state = 'paused';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Resume recording\r\n     */\r\n    resume(): void {\r\n        if (this.state === 'paused') {\r\n            this.state = 'recording';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Toggle recording state\r\n     */\r\n    toggle(): void {\r\n        switch (this.state) {\r\n            case 'idle':\r\n                this.start();\r\n                break;\r\n            case 'recording':\r\n                this.pause();\r\n                break;\r\n            case 'paused':\r\n                this.resume();\r\n                break;\r\n            case 'stopped':\r\n                this.start();\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Record a frame from vessel state\r\n     */\r\n    record(vessel: IVessel, missionTime: number): void {\r\n        if (this.state !== 'recording') return;\r\n\r\n        // Rate limiting - only sample at 20Hz\r\n        if (missionTime - this.lastSampleTime < this.sampleInterval) {\r\n            return;\r\n        }\r\n        this.lastSampleTime = missionTime;\r\n\r\n        // Calculate derived values\r\n        const alt = (this.groundY - vessel.y - vessel.h) / PIXELS_PER_METER;\r\n        const speed = Math.sqrt(vessel.vx * vessel.vx + vessel.vy * vessel.vy);\r\n        const mach = getMachNumber(speed);\r\n\r\n        // Calculate acceleration\r\n        const dt = missionTime - this.prevTime;\r\n        let accelX = 0;\r\n        let accelY = 0;\r\n        if (dt > 0 && this.prevTime > 0) {\r\n            accelX = (vessel.vx - this.prevVx) / dt;\r\n            accelY = (vessel.vy - this.prevVy) / dt;\r\n        }\r\n        const gForce = Math.sqrt(accelX * accelX + accelY * accelY) / 9.81;\r\n\r\n        // Create frame\r\n        const frame: FlightDataFrame = {\r\n            t: missionTime,\r\n            alt: alt,\r\n            vx: vessel.vx,\r\n            vy: vessel.vy,\r\n            speed: speed,\r\n            accelX: accelX,\r\n            accelY: accelY,\r\n            gForce: gForce,\r\n            angle: vessel.angle * 180 / Math.PI,\r\n            gimbal: vessel.gimbalAngle * 180 / Math.PI,\r\n            throttle: vessel.throttle,\r\n            mass: vessel.mass,\r\n            fuel: vessel.fuel,\r\n            q: vessel.q,\r\n            mach: mach,\r\n            aoa: vessel.aoa * 180 / Math.PI,\r\n            skinTemp: vessel.skinTemp,\r\n            engineState: vessel.engineState,\r\n            apogee: vessel.apogee\r\n        };\r\n\r\n        this.frames.push(frame);\r\n\r\n        // Update summary statistics\r\n        this.summary.maxAltitude = Math.max(this.summary.maxAltitude, alt);\r\n        this.summary.maxVelocity = Math.max(this.summary.maxVelocity, speed);\r\n        this.summary.maxGForce = Math.max(this.summary.maxGForce, gForce);\r\n        this.summary.maxQ = Math.max(this.summary.maxQ, vessel.q);\r\n        this.summary.maxMach = Math.max(this.summary.maxMach, mach);\r\n\r\n        // Store for next acceleration calculation\r\n        this.prevVx = vessel.vx;\r\n        this.prevVy = vessel.vy;\r\n        this.prevTime = missionTime;\r\n    }\r\n\r\n    /**\r\n     * Get current recording state\r\n     */\r\n    getState(): RecordingState {\r\n        return this.state;\r\n    }\r\n\r\n    /**\r\n     * Check if recording\r\n     */\r\n    isRecording(): boolean {\r\n        return this.state === 'recording';\r\n    }\r\n\r\n    /**\r\n     * Get recorded frames\r\n     */\r\n    getFrames(): readonly FlightDataFrame[] {\r\n        return this.frames;\r\n    }\r\n\r\n    /**\r\n     * Get frame count\r\n     */\r\n    getFrameCount(): number {\r\n        return this.frames.length;\r\n    }\r\n\r\n    /**\r\n     * Get flight summary\r\n     */\r\n    getSummary(): FlightSummary {\r\n        return { ...this.summary };\r\n    }\r\n\r\n    /**\r\n     * Get recording duration in seconds\r\n     */\r\n    getDuration(): number {\r\n        if (this.frames.length === 0) return 0;\r\n        const lastFrame = this.frames[this.frames.length - 1];\r\n        return lastFrame ? lastFrame.t : 0;\r\n    }\r\n\r\n    /**\r\n     * Clear all recorded data\r\n     */\r\n    clear(): void {\r\n        this.frames = [];\r\n        this.state = 'idle';\r\n        this.summary = this.createInitialSummary();\r\n    }\r\n\r\n    /**\r\n     * Get status string for HUD display\r\n     */\r\n    getStatusString(): string {\r\n        switch (this.state) {\r\n            case 'idle': return '';\r\n            case 'recording': return `● REC ${this.frames.length}`;\r\n            case 'paused': return '⏸ PAUSED';\r\n            case 'stopped': return `■ ${this.frames.length} frames`;\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\telemetry\\TelemetryExporter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\types\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\types\\units.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\ManeuverPlanner.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MU' is defined but never used.","line":15,"column":5,"messageId":"unusedVar","endLine":15,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MU"},"fix":{"range":[359,368],"text":""},"desc":"Remove unused variable \"MU\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":320,"column":21,"messageId":"unexpectedAny","endLine":320,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13995,13998],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13995,13998],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Maneuver Planner UI\r\n * \r\n * Interface for planning orbital maneuvers.\r\n * Allows users to calculate burns for circularization and Hohmann transfers.\r\n */\r\n\r\nimport { Game } from '../core/Game';\r\nimport {\r\n    calculateOrbitalElements,\r\n    calculateCircularizationFromElements,\r\n    calculateHohmannTransfer,\r\n    KeplerianElements,\r\n    ManeuverPlan,\r\n    MU\r\n} from '../physics/OrbitalMechanics';\r\nimport { vec2 } from '../types';\r\nimport { R_EARTH } from '../constants';\r\n\r\nexport class ManeuverPlanner {\r\n    private game: Game;\r\n    private modal: HTMLElement | null = null;\r\n    private contentDiv: HTMLElement | null = null;\r\n    private isVisible: boolean = false;\r\n    private updateInterval: number | null = null;\r\n\r\n    constructor(game: Game) {\r\n        this.game = game;\r\n        this.createModal();\r\n        this.attachEventListeners();\r\n    }\r\n\r\n    /**\r\n     * Create the modal HTML structure\r\n     */\r\n    private createModal(): void {\r\n        if (document.getElementById('maneuver-planner-modal')) return;\r\n\r\n        const modal = document.createElement('div');\r\n        modal.id = 'maneuver-planner-modal';\r\n        modal.className = 'script-editor-modal'; // Reuse script editor styling for consistency\r\n        modal.style.display = 'none'; // Hidden by default\r\n        modal.innerHTML = `\r\n            <div class=\"script-editor-content\" style=\"max-width: 500px;\">\r\n                <div class=\"script-editor-header\">\r\n                    <h2>📐 Orbital Maneuver Planner</h2>\r\n                    <button id=\"planner-close-btn\" class=\"script-close-btn\">×</button>\r\n                </div>\r\n                \r\n                <div class=\"script-editor-body\" style=\"padding: 15px;\">\r\n                    <div class=\"maneuver-section\">\r\n                        <h3>Current Orbit</h3>\r\n                        <div id=\"planner-orbit-stats\" class=\"stats-grid\">\r\n                            Loading...\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"maneuver-section\" style=\"margin-top: 20px;\">\r\n                        <h3>Select Maneuver</h3>\r\n                        <select id=\"maneuver-type-select\" class=\"script-select\" style=\"width: 100%; margin-bottom: 10px;\">\r\n                            <option value=\"circularize-apo\">Circularize at Apoapsis</option>\r\n                            <option value=\"circularize-peri\">Circularize at Periapsis</option>\r\n                            <option value=\"hohmann\">Hohmann Transfer</option>\r\n                        </select>\r\n\r\n                        <div id=\"hohmann-inputs\" style=\"display: none; margin-bottom: 10px;\">\r\n                            <label style=\"color: #aaa; font-size: 0.9em;\">Target Altitude (km):</label>\r\n                            <input type=\"number\" id=\"target-alt-input\" class=\"script-name-input\" \r\n                                value=\"500\" style=\"width: 100px;\">\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"maneuver-section\" style=\"margin-top: 20px;\">\r\n                        <h3>Maneuver Plan</h3>\r\n                        <div id=\"planner-results\" style=\"background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-family: monospace;\">\r\n                            Select a maneuver to calculate...\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"script-editor-footer\">\r\n                    <button id=\"planner-refresh-btn\" class=\"script-btn\">🔄 Refresh</button>\r\n                    <!-- Future: Load to flight computer -->\r\n                    <!-- <button id=\"planner-program-btn\" class=\"script-btn script-btn-primary\">Program Flight Computer</button> -->\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        document.body.appendChild(modal);\r\n        this.modal = modal;\r\n        this.contentDiv = document.getElementById('planner-results');\r\n    }\r\n\r\n    /**\r\n     * Attach event listeners\r\n     */\r\n    private attachEventListeners(): void {\r\n        document.getElementById('planner-close-btn')?.addEventListener('click', () => this.hide());\r\n\r\n        // Maneuver select change\r\n        document.getElementById('maneuver-type-select')?.addEventListener('change', (e) => {\r\n            const select = e.target as HTMLSelectElement;\r\n            const hohmannInputs = document.getElementById('hohmann-inputs');\r\n            if (hohmannInputs) {\r\n                hohmannInputs.style.display = select.value === 'hohmann' ? 'block' : 'none';\r\n            }\r\n            this.calculateManeuver();\r\n        });\r\n\r\n        // Target altitude input change\r\n        document.getElementById('target-alt-input')?.addEventListener('change', () => {\r\n            this.calculateManeuver();\r\n        });\r\n\r\n        // Refresh button\r\n        document.getElementById('planner-refresh-btn')?.addEventListener('click', () => {\r\n            this.updateOrbitStats();\r\n            this.calculateManeuver();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Show the planner\r\n     */\r\n    show(): void {\r\n        if (this.modal) {\r\n            this.modal.style.display = 'flex';\r\n            this.modal.classList.add('visible');\r\n            this.isVisible = true;\r\n            this.updateOrbitStats();\r\n            this.calculateManeuver();\r\n\r\n            // Auto-update every second\r\n            this.updateInterval = window.setInterval(() => {\r\n                if (this.isVisible) this.updateOrbitStats();\r\n            }, 1000);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Hide the planner\r\n     */\r\n    hide(): void {\r\n        if (this.modal) {\r\n            this.modal.style.display = 'none';\r\n            this.modal.classList.remove('visible');\r\n            this.isVisible = false;\r\n\r\n            if (this.updateInterval) {\r\n                clearInterval(this.updateInterval);\r\n                this.updateInterval = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Toggle visibility\r\n     */\r\n    toggle(): void {\r\n        if (this.isVisible) this.hide();\r\n        else this.show();\r\n    }\r\n\r\n    /**\r\n     * Update current orbit statistics display\r\n     */\r\n    private updateOrbitStats(): KeplerianElements | null {\r\n        const vessel = this.game.mainStack; // Assume main stack for now\r\n        if (!vessel) return null;\r\n\r\n        // Position relative to Earth Center\r\n        // Simulation coordinates: y=groundY is surface. Earth center is groundY + R_EARTH\r\n        // But y decreases as we go up.\r\n        // So altitude = (groundY - y - h) / PIXELS_PER_METER\r\n        // r = R_EARTH + altitude\r\n        // Let's rely on calculating elements freshly\r\n\r\n        // NOTE: Coordinate system in OrbitMechanics expects standard physics vectors.\r\n        // We need to convert from sim coordinates to meters.\r\n\r\n        // 1. Get state in meters relative to Earth Center\r\n        // Sim Origin: Top-Left (0,0)\r\n        // Ground Level: game.groundY\r\n        // Earth Center: (vessel.x, game.groundY + R_EARTH*PPM) - approximate since x is flat\r\n        // Improved approximation:\r\n        // r_vec = (0, R_EARTH + altitude) -- treating current pos as vertical for simplicity?\r\n        // No, we need 2D orbital elements.\r\n        // Let's use the local planet-centered frame:\r\n        // Center = (0, 0)\r\n        // Vessel = (x / 10, -(groundY - y)/10 - R_EARTH) ?? \r\n        // Actually, let's just use scalar magnitude for altitude and velocity since \r\n        // the game uses 2D flat earth approximation for \"x\" but \"y\" is radial gravity...\r\n        // Wait, the game *does* use radial gravity:\r\n        // Game.ts: const pG = 9.8 * Math.pow(R_EARTH / pRad, 2); \r\n        // Vessel.ts: const dist = R_EARTH + (this.groundY - this.y - this.h) / PIXELS_PER_METER;\r\n\r\n        // So 'y' is effectively the radial distance axis, and 'x' is tangential?\r\n        // Let's verify Vessel.ts gravity application.\r\n        // Vessel.ts: \r\n        // const g = 9.8 * Math.pow(R_EARTH/dist, 2);\r\n        // derivatives.dvy += g; (which implies g acts downwards in +y)\r\n        // This is a \"Flat Earth with Gravity Gradient\" model, NOT a true spherical gravity model.\r\n        // X position does not curve around the planet.\r\n        // This makes \"Orbital Mechanics\" slightly fake but we can approximate.\r\n        // In this model:\r\n        // r = R_EARTH + altitude\r\n        // v = sqrt(vx^2 + vy^2)\r\n        // We can treat it as a 1D radial problem + tangential velocity?\r\n        // Real orbital elements require a central potential.\r\n        // Since gravity direction is constant (down), specific angular momentum is tricky.\r\n        // BUT, for the purpose of this \"Planner\", we can pretend we are in a central force field\r\n        // where r = R_EARTH + altitude, and v_tangential = vx, v_radial = -vy.\r\n\r\n        const altitude = (this.game.groundY - vessel.y - vessel.h) / 10; // PIXELS_PER_METER = 10\r\n        const r = R_EARTH + altitude;\r\n\r\n        // Velocity (vx is horizontal/tangential, vy is vertical/radial)\r\n        // define state vector relative to Earth center\r\n        // Let's define Earth Center at (0, 0)\r\n        // Vessel Position: (0, r) \r\n        // Vessel Velocity: (vessel.vx, -vessel.vy)  (vy is positive down, so -vy is up/radial)\r\n\r\n        // Position vector r (meters)\r\n        // We place ship at (0, r) for calculation simplicity\r\n        const rVec = vec2(0, r);\r\n        // Velocity vector v (m/s)\r\n        const vVec = vec2(vessel.vx, -vessel.vy);\r\n\r\n        const elements = calculateOrbitalElements(rVec, vVec);\r\n\r\n        const statsDiv = document.getElementById('planner-orbit-stats');\r\n        if (statsDiv) {\r\n            statsDiv.innerHTML = `\r\n                <div><strong>Apoapsis:</strong> ${(elements.apoapsis / 1000).toFixed(1)} km</div>\r\n                <div><strong>Periapsis:</strong> ${(elements.periapsis / 1000).toFixed(1)} km</div>\r\n                <div><strong>Period:</strong> ${(elements.period / 60).toFixed(1)} min</div>\r\n                <div><strong>Eccentricity:</strong> ${elements.eccentricity.toFixed(3)}</div>\r\n            `;\r\n        }\r\n\r\n        return elements;\r\n    }\r\n\r\n    /**\r\n     * Calculate and display maneuver plan\r\n     */\r\n    private calculateManeuver(): void {\r\n        const vessel = this.game.mainStack;\r\n        if (!vessel) return;\r\n\r\n        // Recalculate elements (should ideally cache this)\r\n        const altitude = (this.game.groundY - vessel.y - vessel.h) / 10;\r\n        const r = R_EARTH + altitude;\r\n        const rVec = vec2(0, r);\r\n        const vVec = vec2(vessel.vx, -vessel.vy);\r\n        const elements = calculateOrbitalElements(rVec, vVec);\r\n\r\n        const select = document.getElementById('maneuver-type-select') as HTMLSelectElement;\r\n        const type = select.value;\r\n        const resultDiv = document.getElementById('planner-results');\r\n\r\n        if (!resultDiv) return;\r\n\r\n        // Current vessel capabilities\r\n        // Estimate thrust (use max thrust for now as we burn at 100%)\r\n        // We need to know which engine is active/available. \r\n        // Simplified: Use current max thrust.\r\n        // For mass, use current mass.\r\n        const thrust = vessel.maxThrust; // N\r\n        const mass = vessel.mass; // kg\r\n\r\n        try {\r\n            let plan: ManeuverPlan | null = null;\r\n            let planText = '';\r\n\r\n            if (type === 'circularize-apo') {\r\n                plan = calculateCircularizationFromElements(elements, true, thrust, mass);\r\n                planText = this.formatPlan(plan);\r\n            }\r\n            else if (type === 'circularize-peri') {\r\n                plan = calculateCircularizationFromElements(elements, false, thrust, mass);\r\n                planText = this.formatPlan(plan);\r\n            }\r\n            else if (type === 'hohmann') {\r\n                const targetAltKm = parseFloat((document.getElementById('target-alt-input') as HTMLInputElement).value) || 500;\r\n                const targetR = R_EARTH + targetAltKm * 1000;\r\n\r\n                // Assume starting from circular orbit at current altitude for simplicity of the planner?\r\n                // Or calculate from current circular orbit radius?\r\n                // Standard Hohmann starts from one circular to another.\r\n                // Let's use current semi-major axis as \"r1\" approx? \r\n                // No, Hohmann equations provided need r1, r2.\r\n                // Best approximation: r1 = current (r_apo + r_peri)/2, i.e., semi-major axis?\r\n                // Or just current altitude if roughly circular.\r\n                // Let's use current semi-major axis as starting \"radius\" (mean radius).\r\n\r\n                // For proper Hohmann, we assume we are in circular orbit 1 and want to go to circular orbit 2.\r\n                // If we are elliptical, it's more complex (Elliptical Transfer).\r\n                // Simplified: r1 = SemiMajorAxis, r2 = TargetR\r\n                // This gives delta-v between two generic circular orbits.\r\n\r\n                const r1 = elements.semiMajorAxis;\r\n                const hResult = calculateHohmannTransfer(r1, targetR, thrust, mass);\r\n\r\n                planText = `\r\n                    <strong>Hohmann Transfer to ${targetAltKm} km</strong><br>\r\n                    <hr style=\"border: 0; border-top: 1px solid #555; margin: 5px 0;\">\r\n                    <div>Transfer Time: ${(hResult.transferTime / 60).toFixed(1)} min</div>\r\n                    <div style=\"margin-top: 5px; color: #f39c12;\">Burn 1 (Departure):</div>\r\n                    <div>ΔV: ${hResult.deltaV1.toFixed(1)} m/s</div>\r\n                    <div>Duration: ${hResult.burnTime1.toFixed(1)} s</div>\r\n                    <div style=\"margin-top: 5px; color: #f39c12;\">Burn 2 (Arrival):</div>\r\n                    <div>ΔV: ${hResult.deltaV2.toFixed(1)} m/s</div>\r\n                    <div>Total ΔV: ${(hResult.deltaV1 + hResult.deltaV2).toFixed(1)} m/s</div>\r\n                `;\r\n            }\r\n\r\n            resultDiv.innerHTML = planText;\r\n\r\n        } catch (e: any) {\r\n            resultDiv.innerHTML = `<span style=\"color: #e74c3c;\">Error: ${e.message}</span>`;\r\n        }\r\n    }\r\n\r\n    private formatPlan(plan: ManeuverPlan): string {\r\n        return `\r\n            <strong>${plan.description}</strong><br>\r\n            <hr style=\"border: 0; border-top: 1px solid #555; margin: 5px 0;\">\r\n            <div>Target Orbit: ${(plan.targetOrbit.apoapsis / 1000).toFixed(0)} x ${(plan.targetOrbit.periapsis / 1000).toFixed(0)} km</div>\r\n            <div style=\"margin-top: 8px;\">\r\n                <span style=\"color: #3498db; font-size: 1.2em;\">ΔV: ${plan.deltaV.toFixed(1)} m/s</span>\r\n            </div>\r\n            <div>Burn Duration: ${plan.burnTime.toFixed(1)} s</div>\r\n            <div style=\"font-size: 0.8em; color: #888; margin-top: 5px;\">\r\n                Wait for ${plan.description.includes('Apoapsis') ? 'Apoapsis' : 'Periapsis'} to execute.\r\n            </div>\r\n        `;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\MissionControl.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'R_EARTH' is defined but never used.","line":10,"column":10,"messageId":"unusedVar","endLine":10,"endColumn":17,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"R_EARTH"},"fix":{"range":[283,324],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'moved' is assigned a value but never used.","line":126,"column":21,"messageId":"unusedVar","endLine":126,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'velMag' is assigned a value but never used.","line":170,"column":19,"messageId":"unusedVar","endLine":170,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Mission Control Dashboard\r\n * \r\n * Visualizes the rocket's ground track, impact point, and key telemetry\r\n * on a world map (Mercator projection).\r\n */\r\n\r\nimport { Game } from '../core/Game';\r\nimport { calculateGroundTrack, LAUNCH_SITE } from '../physics/OrbitalMechanics';\r\nimport { R_EARTH } from '../constants';\r\n\r\nexport class MissionControl {\r\n    private game: Game;\r\n    private isVisible: boolean = false;\r\n    private pathPoints: { lat: number, lon: number }[] = [];\r\n    private lastPathUpdate: number = 0;\r\n\r\n    constructor(game: Game) {\r\n        this.game = game;\r\n        // Pre-fill path with launch site\r\n        this.pathPoints.push({ lat: LAUNCH_SITE.lat, lon: LAUNCH_SITE.lon });\r\n    }\r\n\r\n    toggle(): void {\r\n        this.isVisible = !this.isVisible;\r\n        const mcOverlay = document.getElementById('mission-control-overlay');\r\n        if (mcOverlay) {\r\n            mcOverlay.style.display = this.isVisible ? 'block' : 'none';\r\n        }\r\n    }\r\n\r\n    update(dt: number, time: number): void {\r\n        if (!this.game.trackedEntity) return;\r\n\r\n        // Update path every 1 second or so to save memory/perf, or if distance moved is significant\r\n        if (time - this.lastPathUpdate > 1.0) { // Every 1 sec\r\n            const downrange = this.game.trackedEntity.x;\r\n            const track = calculateGroundTrack(downrange, time);\r\n            this.pathPoints.push(track);\r\n            this.lastPathUpdate = time;\r\n\r\n            // Limit path length to prevent memory leak (e.g. last 1000 points)\r\n            if (this.pathPoints.length > 3600) { // ~1 hour of flight\r\n                this.pathPoints.shift();\r\n            }\r\n        }\r\n    }\r\n\r\n    draw(ctx: CanvasRenderingContext2D, width: number, height: number): void {\r\n        if (!this.isVisible) return;\r\n\r\n        // Draw background\r\n        ctx.fillStyle = '#0a0a1a';\r\n        ctx.fillRect(0, 0, width, height);\r\n\r\n        // Draw Map Grid (Mercator)\r\n        // Mercator range: Lon [-PI, PI], Lat limit usually ~85 deg\r\n        // Map Area: Let's use a central box, e.g., 80% width/height\r\n        const mapW = width * 0.9;\r\n        const mapH = height * 0.8;\r\n        const mapX = (width - mapW) / 2;\r\n        const mapY = (height - mapH) / 2;\r\n\r\n        ctx.strokeStyle = '#333';\r\n        ctx.lineWidth = 1;\r\n        ctx.strokeRect(mapX, mapY, mapW, mapH);\r\n\r\n        // Grid Lines\r\n        ctx.beginPath();\r\n        // Longitude lines (every 30 deg)\r\n        for (let i = -180; i <= 180; i += 30) {\r\n            const x = this.lonToMask(i * Math.PI / 180, mapX, mapW);\r\n            ctx.moveTo(x, mapY);\r\n            ctx.lineTo(x, mapY + mapH);\r\n        }\r\n        // Latitude lines (Equator, Tropics, Circles)\r\n        const latLines = [0, 23.5, -23.5, 66.5, -66.5];\r\n        latLines.forEach(lat => {\r\n            const y = this.latToMask(lat * Math.PI / 180, mapY, mapH);\r\n            ctx.moveTo(mapX, y);\r\n            ctx.lineTo(mapX + mapW, y);\r\n        });\r\n        ctx.stroke();\r\n\r\n        // Draw Prime Meridian & Equator thicker\r\n        ctx.beginPath();\r\n        ctx.strokeStyle = '#555';\r\n        ctx.lineWidth = 2;\r\n        // Equator\r\n        const eqY = this.latToMask(0, mapY, mapH);\r\n        ctx.moveTo(mapX, eqY);\r\n        ctx.lineTo(mapX + mapW, eqY);\r\n        // Prime Meridian\r\n        const pmX = this.lonToMask(0, mapX, mapW);\r\n        ctx.moveTo(pmX, mapY);\r\n        ctx.lineTo(pmX, mapY + mapH);\r\n        ctx.stroke();\r\n\r\n        // Draw Launch Site\r\n        const lsX = this.lonToMask(LAUNCH_SITE.lon, mapX, mapW);\r\n        const lsY = this.latToMask(LAUNCH_SITE.lat, mapY, mapH);\r\n        ctx.fillStyle = '#f1c40f';\r\n        ctx.beginPath();\r\n        ctx.arc(lsX, lsY, 4, 0, Math.PI * 2);\r\n        ctx.fill();\r\n        ctx.fillText(\"CAPE\", lsX + 5, lsY);\r\n\r\n        // Draw Path\r\n        if (this.pathPoints.length > 1) {\r\n            ctx.strokeStyle = '#e74c3c'; // Red trail\r\n            ctx.lineWidth = 2;\r\n            ctx.beginPath();\r\n\r\n            // Handle wrapping? Simple drawing for now, might draw lines across map if wrapping.\r\n            // Improve: Break line if dLon > PI\r\n\r\n            let moved = false;\r\n            for (let i = 0; i < this.pathPoints.length; i++) {\r\n                const p = this.pathPoints[i];\r\n                if (!p) continue;\r\n                const px = this.lonToMask(p.lon, mapX, mapW);\r\n                const py = this.latToMask(p.lat, mapY, mapH);\r\n\r\n                if (i === 0) {\r\n                    ctx.moveTo(px, py);\r\n                    moved = true;\r\n                } else {\r\n                    const prev = this.pathPoints[i - 1];\r\n                    // Check for wrapping (dateline crossing)\r\n                    if (prev && Math.abs(p.lon - prev.lon) > Math.PI) {\r\n                        ctx.stroke();\r\n                        ctx.beginPath();\r\n                        ctx.moveTo(px, py);\r\n                    } else {\r\n                        ctx.lineTo(px, py);\r\n                    }\r\n                }\r\n            }\r\n            ctx.stroke();\r\n        }\r\n\r\n        // Current Position\r\n        if (this.game.trackedEntity) {\r\n            const currentTrack = calculateGroundTrack(this.game.trackedEntity.x, this.game.missionTime);\r\n            const cx = this.lonToMask(currentTrack.lon, mapX, mapW);\r\n            const cy = this.latToMask(currentTrack.lat, mapY, mapH);\r\n\r\n            ctx.fillStyle = '#2ecc71'; // Green current\r\n            ctx.beginPath();\r\n            ctx.arc(cx, cy, 6, 0, Math.PI * 2);\r\n            ctx.fill();\r\n\r\n            // Ripple effect\r\n            ctx.strokeStyle = '#2ecc71';\r\n            ctx.lineWidth = 1;\r\n            const ripple = (Date.now() % 1000) / 1000 * 20;\r\n            ctx.beginPath();\r\n            ctx.arc(cx, cy, ripple, 0, Math.PI * 2);\r\n            ctx.stroke();\r\n\r\n            // Draw Impact Point (Simple ballistic)\r\n            // If suborbital (ecc < 1 and periapsis < 0 approx)\r\n            // This is hard to calc exactly without full propagator, \r\n            // but we can just project forward a bit or use current velocity vector direction?\r\n            // \"Current Heading\" line\r\n            ctx.strokeStyle = 'rgba(46, 204, 113, 0.5)';\r\n            ctx.beginPath();\r\n            ctx.moveTo(cx, cy);\r\n            // arrow length scaling\r\n            const velMag = Math.sqrt(this.game.trackedEntity.vx ** 2 + this.game.trackedEntity.vy ** 2);\r\n            // simple heading estimation (not quite right but visual)\r\n            // heading derived from lat/lon change?\r\n            // No, just draw a small leader line\r\n            // ctx.lineTo(cx + 20, cy); \r\n            // We need heading angle.\r\n        }\r\n\r\n        // Overlay Text\r\n        ctx.fillStyle = 'white';\r\n        ctx.font = '24px monospace';\r\n        ctx.fillText(\"MISSION CONTROL - GROUND TRACK\", mapX, mapY - 15);\r\n\r\n        ctx.font = '14px monospace';\r\n        ctx.fillStyle = '#aaa';\r\n        const lastPoint = this.pathPoints[this.pathPoints.length - 1];\r\n        if (lastPoint) {\r\n            const latDeg = (lastPoint.lat * 180 / Math.PI).toFixed(4);\r\n            const lonDeg = (lastPoint.lon * 180 / Math.PI).toFixed(4);\r\n            ctx.fillText(`LAT: ${latDeg}°  LON: ${lonDeg}°`, mapX + mapW - 250, mapY - 15);\r\n        }\r\n    }\r\n\r\n    // Helper: Longitude to Screen X (Mercator)\r\n    private lonToMask(lon: number, mapX: number, mapW: number): number {\r\n        // lon in [-PI, PI] -> [0, 1] relative\r\n        const rel = (lon + Math.PI) / (2 * Math.PI);\r\n        return mapX + rel * mapW;\r\n    }\r\n\r\n    // Helper: Latitude to Screen Y (Mercator)\r\n    private latToMask(lat: number, mapY: number, mapH: number): number {\r\n        // lat in [-85 deg, 85 deg] to avoid infinity\r\n        // y = ln(tan(PI/4 + lat/2))\r\n        const MAX_LAT = 85 * Math.PI / 180;\r\n        const clampedLat = Math.max(-MAX_LAT, Math.min(MAX_LAT, lat));\r\n\r\n        const mercN = Math.log(Math.tan(Math.PI / 4 + clampedLat / 2));\r\n        // Normalize: Max Mercator Y (at 85 deg) is approx 3.13\r\n        const MAX_MERC = 3.13; // Math.log(Math.tan(Math.PI/4 + MAX_LAT/2))\r\n\r\n        // Map [-MAX_MERC, MAX_MERC] to [height, 0] (Top is North)\r\n        // rel from 0 (North) to 1 (South)\r\n        const rel = 1 - (mercN + MAX_MERC) / (2 * MAX_MERC);\r\n        return mapY + rel * mapH;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\MissionLog.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\Navball.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\ScriptEditor.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'deserializeScript' is defined but never used.","line":8,"column":45,"messageId":"unusedVar","endLine":8,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"deserializeScript"},"fix":{"range":[248,267],"text":""},"desc":"Remove unused variable \"deserializeScript\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'serializeScript' is defined but never used.","line":8,"column":64,"messageId":"unusedVar","endLine":8,"endColumn":79,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"serializeScript"},"fix":{"range":[267,284],"text":""},"desc":"Remove unused variable \"serializeScript\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":35,"messageId":"unexpectedAny","endLine":186,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7691,7694],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7691,7694],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":187,"column":22,"messageId":"unexpectedAny","endLine":187,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7736,7739],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7736,7739],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ScriptEditor - Flight Computer Script Editor UI\r\n * \r\n * Modal editor for creating and editing mission scripts.\r\n * Features syntax validation, preset loading, and localStorage persistence.\r\n */\r\n\r\nimport { parseMissionScript, MissionScript, deserializeScript, serializeScript } from '../guidance/FlightScript';\r\nimport { FlightComputer, PRESET_SCRIPTS } from '../guidance/FlightComputer';\r\n\r\nconst STORAGE_KEY = 'rocket-sim-scripts';\r\n\r\nexport class ScriptEditor {\r\n    private modal: HTMLElement | null = null;\r\n    private textarea: HTMLTextAreaElement | null = null;\r\n    private errorDisplay: HTMLElement | null = null;\r\n    private saveSelect: HTMLSelectElement | null = null;\r\n    private flightComputer: FlightComputer;\r\n    private onScriptLoaded: ((script: MissionScript) => void) | null = null;\r\n\r\n    constructor(flightComputer: FlightComputer) {\r\n        this.flightComputer = flightComputer;\r\n        this.createModal();\r\n        this.attachEventListeners();\r\n    }\r\n\r\n    /**\r\n     * Set callback for when a script is loaded\r\n     */\r\n    setOnScriptLoaded(callback: (script: MissionScript) => void): void {\r\n        this.onScriptLoaded = callback;\r\n    }\r\n\r\n    /**\r\n     * Create the modal HTML structure\r\n     */\r\n    private createModal(): void {\r\n        // Check if modal already exists\r\n        if (document.getElementById('script-editor-modal')) {\r\n            this.modal = document.getElementById('script-editor-modal');\r\n            this.textarea = document.getElementById('script-textarea') as HTMLTextAreaElement;\r\n            this.errorDisplay = document.getElementById('script-errors');\r\n            this.saveSelect = document.getElementById('script-save-select') as HTMLSelectElement;\r\n            return;\r\n        }\r\n\r\n        // Create modal container\r\n        const modal = document.createElement('div');\r\n        modal.id = 'script-editor-modal';\r\n        modal.className = 'script-editor-modal';\r\n        modal.innerHTML = `\r\n            <div class=\"script-editor-content\">\r\n                <div class=\"script-editor-header\">\r\n                    <h2>✈️ Flight Computer - Script Editor</h2>\r\n                    <button id=\"script-editor-close\" class=\"script-close-btn\">×</button>\r\n                </div>\r\n                \r\n                <div class=\"script-editor-body\">\r\n                    <div class=\"script-toolbar\">\r\n                        <select id=\"script-preset-select\" class=\"script-select\">\r\n                            <option value=\"\">-- Load Preset --</option>\r\n                            ${Object.keys(PRESET_SCRIPTS).map(name =>\r\n            `<option value=\"${name}\">${name}</option>`\r\n        ).join('')}\r\n                        </select>\r\n                        \r\n                        <select id=\"script-save-select\" class=\"script-select\">\r\n                            <option value=\"\">-- Saved Scripts --</option>\r\n                        </select>\r\n                        \r\n                        <button id=\"script-validate-btn\" class=\"script-btn\">✓ Validate</button>\r\n                        <button id=\"script-clear-btn\" class=\"script-btn script-btn-danger\">Clear</button>\r\n                    </div>\r\n                    \r\n                    <div class=\"script-syntax-help\">\r\n                        <strong>Syntax:</strong> WHEN &lt;condition&gt; THEN &lt;action&gt;\r\n                        <br>\r\n                        <span class=\"script-help-vars\">\r\n                            Variables: ALTITUDE, VELOCITY, APOGEE, FUEL, TIME | \r\n                            Actions: PITCH &lt;deg&gt;, THROTTLE &lt;0-100&gt;, STAGE, SAS &lt;mode&gt;\r\n                        </span>\r\n                    </div>\r\n                    \r\n                    <textarea id=\"script-textarea\" class=\"script-textarea\" \r\n                        placeholder=\"# Mission Script\r\n# Example:\r\nWHEN ALTITUDE > 1000 THEN PITCH 80\r\nWHEN ALTITUDE > 10000 THEN PITCH 60\r\nWHEN APOGEE > 100000 THEN THROTTLE 0\"></textarea>\r\n                    \r\n                    <div id=\"script-errors\" class=\"script-errors\"></div>\r\n                </div>\r\n                \r\n                <div class=\"script-editor-footer\">\r\n                    <div class=\"script-footer-left\">\r\n                        <input type=\"text\" id=\"script-name-input\" class=\"script-name-input\" \r\n                            placeholder=\"Script name...\" value=\"My Mission\">\r\n                        <button id=\"script-save-btn\" class=\"script-btn script-btn-secondary\">💾 Save</button>\r\n                        <button id=\"script-delete-btn\" class=\"script-btn script-btn-danger\">🗑️ Delete</button>\r\n                    </div>\r\n                    <div class=\"script-footer-right\">\r\n                        <button id=\"script-load-btn\" class=\"script-btn script-btn-primary\">📥 Load to FC</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        document.body.appendChild(modal);\r\n        this.modal = modal;\r\n        this.textarea = document.getElementById('script-textarea') as HTMLTextAreaElement;\r\n        this.errorDisplay = document.getElementById('script-errors');\r\n        this.saveSelect = document.getElementById('script-save-select') as HTMLSelectElement;\r\n\r\n        this.updateSavedScriptsList();\r\n    }\r\n\r\n    /**\r\n     * Attach event listeners\r\n     */\r\n    private attachEventListeners(): void {\r\n        // Close button\r\n        document.getElementById('script-editor-close')?.addEventListener('click', () => {\r\n            this.hide();\r\n        });\r\n\r\n        // Click outside to close\r\n        this.modal?.addEventListener('click', (e) => {\r\n            if (e.target === this.modal) {\r\n                this.hide();\r\n            }\r\n        });\r\n\r\n        // Preset select\r\n        document.getElementById('script-preset-select')?.addEventListener('change', (e) => {\r\n            const select = e.target as HTMLSelectElement;\r\n            const presetName = select.value;\r\n            if (presetName && PRESET_SCRIPTS[presetName as keyof typeof PRESET_SCRIPTS]) {\r\n                if (this.textarea) {\r\n                    this.textarea.value = PRESET_SCRIPTS[presetName as keyof typeof PRESET_SCRIPTS];\r\n                }\r\n                this.validate();\r\n            }\r\n            select.value = '';\r\n        });\r\n\r\n        // Saved scripts select\r\n        this.saveSelect?.addEventListener('change', (e) => {\r\n            const select = e.target as HTMLSelectElement;\r\n            const scriptName = select.value;\r\n            if (scriptName) {\r\n                this.loadSavedScript(scriptName);\r\n            }\r\n        });\r\n\r\n        // Validate button\r\n        document.getElementById('script-validate-btn')?.addEventListener('click', () => {\r\n            this.validate();\r\n        });\r\n\r\n        // Clear button\r\n        document.getElementById('script-clear-btn')?.addEventListener('click', () => {\r\n            if (this.textarea) {\r\n                this.textarea.value = '';\r\n            }\r\n            this.clearErrors();\r\n        });\r\n\r\n        // Save button\r\n        document.getElementById('script-save-btn')?.addEventListener('click', () => {\r\n            this.saveScript();\r\n        });\r\n\r\n        // Delete button\r\n        document.getElementById('script-delete-btn')?.addEventListener('click', () => {\r\n            this.deleteScript();\r\n        });\r\n\r\n        // Load to FC button\r\n        document.getElementById('script-load-btn')?.addEventListener('click', () => {\r\n            this.loadToFlightComputer();\r\n        });\r\n\r\n        // Real-time validation on input\r\n        this.textarea?.addEventListener('input', () => {\r\n            // Debounced validation\r\n            clearTimeout((this as any).validateTimeout);\r\n            (this as any).validateTimeout = setTimeout(() => {\r\n                this.validate();\r\n            }, 500);\r\n        });\r\n\r\n        // Keyboard shortcut to close\r\n        document.addEventListener('keydown', (e) => {\r\n            if (e.key === 'Escape' && this.isVisible()) {\r\n                this.hide();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Show the editor modal\r\n     */\r\n    show(): void {\r\n        if (this.modal) {\r\n            this.modal.classList.add('visible');\r\n            this.textarea?.focus();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Hide the editor modal\r\n     */\r\n    hide(): void {\r\n        if (this.modal) {\r\n            this.modal.classList.remove('visible');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if modal is visible\r\n     */\r\n    isVisible(): boolean {\r\n        return this.modal?.classList.contains('visible') ?? false;\r\n    }\r\n\r\n    /**\r\n     * Toggle modal visibility\r\n     */\r\n    toggle(): void {\r\n        if (this.isVisible()) {\r\n            this.hide();\r\n        } else {\r\n            this.show();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Open the editor (alias for show)\r\n     */\r\n    open(): void {\r\n        this.show();\r\n    }\r\n\r\n    /**\r\n     * Validate the current script\r\n     */\r\n    validate(): boolean {\r\n        if (!this.textarea) return false;\r\n\r\n        const scriptText = this.textarea.value;\r\n        const name = (document.getElementById('script-name-input') as HTMLInputElement)?.value || 'Unnamed';\r\n        const result = parseMissionScript(scriptText, name);\r\n\r\n        if (result.success) {\r\n            this.showSuccess(`✓ Valid script with ${result.script?.commands.length} commands`);\r\n            return true;\r\n        } else {\r\n            const errorMessages = result.errors.map(e => `Line ${e.line}: ${e.error}`).join('\\n');\r\n            this.showErrors(errorMessages);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Show error messages\r\n     */\r\n    private showErrors(message: string): void {\r\n        if (this.errorDisplay) {\r\n            this.errorDisplay.textContent = message;\r\n            this.errorDisplay.className = 'script-errors script-errors-error';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Show success message\r\n     */\r\n    private showSuccess(message: string): void {\r\n        if (this.errorDisplay) {\r\n            this.errorDisplay.textContent = message;\r\n            this.errorDisplay.className = 'script-errors script-errors-success';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clear error display\r\n     */\r\n    private clearErrors(): void {\r\n        if (this.errorDisplay) {\r\n            this.errorDisplay.textContent = '';\r\n            this.errorDisplay.className = 'script-errors';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Save current script to localStorage\r\n     */\r\n    private saveScript(): void {\r\n        if (!this.textarea) return;\r\n\r\n        const scriptText = this.textarea.value;\r\n        const name = (document.getElementById('script-name-input') as HTMLInputElement)?.value || 'Unnamed';\r\n\r\n        const result = parseMissionScript(scriptText, name);\r\n        if (!result.success || !result.script) {\r\n            this.showErrors('Cannot save invalid script. Please fix errors first.');\r\n            return;\r\n        }\r\n\r\n        // Get existing scripts\r\n        const scripts = this.getSavedScripts();\r\n        scripts[name] = {\r\n            text: scriptText,\r\n            script: result.script\r\n        };\r\n\r\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(scripts));\r\n        this.updateSavedScriptsList();\r\n        this.showSuccess(`✓ Saved \"${name}\"`);\r\n    }\r\n\r\n    /**\r\n     * Delete a saved script\r\n     */\r\n    private deleteScript(): void {\r\n        const name = (document.getElementById('script-name-input') as HTMLInputElement)?.value;\r\n        if (!name) return;\r\n\r\n        const scripts = this.getSavedScripts();\r\n        if (scripts[name]) {\r\n            delete scripts[name];\r\n            localStorage.setItem(STORAGE_KEY, JSON.stringify(scripts));\r\n            this.updateSavedScriptsList();\r\n            this.showSuccess(`Deleted \"${name}\"`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load a saved script\r\n     */\r\n    private loadSavedScript(name: string): void {\r\n        const scripts = this.getSavedScripts();\r\n        if (scripts[name] && this.textarea) {\r\n            this.textarea.value = scripts[name].text;\r\n            const nameInput = document.getElementById('script-name-input') as HTMLInputElement;\r\n            if (nameInput) nameInput.value = name;\r\n            this.validate();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get saved scripts from localStorage\r\n     */\r\n    private getSavedScripts(): Record<string, { text: string; script: MissionScript }> {\r\n        try {\r\n            const stored = localStorage.getItem(STORAGE_KEY);\r\n            return stored ? JSON.parse(stored) : {};\r\n        } catch {\r\n            return {};\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update the saved scripts dropdown\r\n     */\r\n    private updateSavedScriptsList(): void {\r\n        if (!this.saveSelect) return;\r\n\r\n        const scripts = this.getSavedScripts();\r\n        const names = Object.keys(scripts);\r\n\r\n        // Clear existing options except first\r\n        while (this.saveSelect.options.length > 1) {\r\n            this.saveSelect.remove(1);\r\n        }\r\n\r\n        // Add saved scripts\r\n        names.forEach(name => {\r\n            const option = document.createElement('option');\r\n            option.value = name;\r\n            option.textContent = name;\r\n            this.saveSelect!.appendChild(option);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Load script to Flight Computer\r\n     */\r\n    private loadToFlightComputer(): void {\r\n        if (!this.textarea) return;\r\n\r\n        const scriptText = this.textarea.value;\r\n        const name = (document.getElementById('script-name-input') as HTMLInputElement)?.value || 'Mission Script';\r\n\r\n        const result = this.flightComputer.loadScript(scriptText, name);\r\n\r\n        if (result.success) {\r\n            this.showSuccess(`✓ Loaded to Flight Computer! Press G to activate.`);\r\n\r\n            if (this.onScriptLoaded && this.flightComputer.state.script) {\r\n                this.onScriptLoaded(this.flightComputer.state.script);\r\n            }\r\n\r\n            // Auto-close after short delay\r\n            setTimeout(() => {\r\n                this.hide();\r\n            }, 1500);\r\n        } else {\r\n            this.showErrors(result.errors.join('\\n'));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set textarea content\r\n     */\r\n    setContent(text: string): void {\r\n        if (this.textarea) {\r\n            this.textarea.value = text;\r\n            this.validate();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get textarea content\r\n     */\r\n    getContent(): string {\r\n        return this.textarea?.value ?? '';\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\Telemetry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\UIConstants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\ui\\VABEditor.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":285,"column":34,"messageId":"unexpectedAny","endLine":285,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10137,10140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10137,10140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * VAB Editor\r\n * \r\n * Visual vehicle builder UI with parts catalog, stacking area, and stage manager.\r\n */\r\n\r\nimport {\r\n    RocketPart,\r\n    PartCategory,\r\n    PARTS_CATALOG,\r\n    getPartsByCategory\r\n} from '../vab/PartsCatalog';\r\nimport {\r\n    VehicleBlueprint,\r\n    VehicleStats,\r\n    createBlueprint,\r\n    addStage,\r\n    addPartToStage,\r\n    removePartFromStage,\r\n    removeStage,\r\n    calculateStats,\r\n    createFalconPreset,\r\n    createSimplePreset,\r\n    saveBlueprints,\r\n    loadBlueprints\r\n} from '../vab/VehicleBlueprint';\r\n\r\nexport class VABEditor {\r\n    private container: HTMLElement;\r\n    private blueprint: VehicleBlueprint;\r\n    private savedBlueprints: VehicleBlueprint[] = [];\r\n    private selectedCategory: PartCategory = 'engine';\r\n    private onLaunch: (blueprint: VehicleBlueprint) => void;\r\n\r\n    constructor(containerId: string, onLaunch: (blueprint: VehicleBlueprint) => void) {\r\n        const container = document.getElementById(containerId);\r\n        if (!container) throw new Error(`Container ${containerId} not found`);\r\n        this.container = container;\r\n        this.onLaunch = onLaunch;\r\n        this.blueprint = createFalconPreset();\r\n        this.savedBlueprints = loadBlueprints();\r\n        this.render();\r\n    }\r\n\r\n    /**\r\n     * Show the VAB editor\r\n     */\r\n    public show(): void {\r\n        this.container.style.display = 'flex';\r\n        this.render();\r\n    }\r\n\r\n    /**\r\n     * Hide the VAB editor\r\n     */\r\n    public hide(): void {\r\n        this.container.style.display = 'none';\r\n    }\r\n\r\n    /**\r\n     * Get current blueprint\r\n     */\r\n    public getBlueprint(): VehicleBlueprint {\r\n        return this.blueprint;\r\n    }\r\n\r\n    /**\r\n     * Render the complete VAB UI\r\n     */\r\n    private render(): void {\r\n        const stats = calculateStats(this.blueprint);\r\n\r\n        this.container.innerHTML = `\r\n            <div class=\"vab-editor\">\r\n                <div class=\"vab-header\">\r\n                    <h2>⚙️ Vehicle Assembly Building</h2>\r\n                    <input type=\"text\" class=\"vab-name-input\" value=\"${this.blueprint.name}\" placeholder=\"Rocket Name\">\r\n                </div>\r\n                \r\n                <div class=\"vab-main\">\r\n                    <!-- Parts Catalog -->\r\n                    <div class=\"vab-parts-panel\">\r\n                        <h3>Parts Catalog</h3>\r\n                        <div class=\"vab-category-tabs\">\r\n                            ${this.renderCategoryTabs()}\r\n                        </div>\r\n                        <div class=\"vab-parts-list\">\r\n                            ${this.renderPartsList()}\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Vehicle Preview -->\r\n                    <div class=\"vab-preview-panel\">\r\n                        <h3>Vehicle Preview</h3>\r\n                        <div class=\"vab-vehicle-display\">\r\n                            ${this.renderVehiclePreview()}\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Stage Manager -->\r\n                    <div class=\"vab-stages-panel\">\r\n                        <h3>Stages</h3>\r\n                        <div class=\"vab-stages-list\">\r\n                            ${this.renderStagesList()}\r\n                        </div>\r\n                        <button class=\"vab-add-stage-btn\">+ Add Stage</button>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Stats Bar -->\r\n                <div class=\"vab-stats-bar\">\r\n                    ${this.renderStats(stats)}\r\n                </div>\r\n                \r\n                <!-- Action Buttons -->\r\n                <div class=\"vab-actions\">\r\n                    <div class=\"vab-presets\">\r\n                        <button class=\"vab-preset-btn\" data-preset=\"falcon\">Load Falcon 9</button>\r\n                        <button class=\"vab-preset-btn\" data-preset=\"simple\">Load Simple</button>\r\n                        <button class=\"vab-preset-btn\" data-preset=\"new\">New Rocket</button>\r\n                    </div>\r\n                    <div class=\"vab-main-actions\">\r\n                        <button class=\"vab-save-btn\">💾 Save</button>\r\n                        <button class=\"vab-cancel-btn\">Cancel</button>\r\n                        <button class=\"vab-launch-btn primary large\">🚀 GO FOR LAUNCH</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        this.attachEventListeners();\r\n    }\r\n\r\n    /**\r\n     * Render category tabs\r\n     */\r\n    private renderCategoryTabs(): string {\r\n        const categories: { id: PartCategory; icon: string; label: string }[] = [\r\n            { id: 'engine', icon: '🔥', label: 'Engines' },\r\n            { id: 'tank', icon: '⛽', label: 'Tanks' },\r\n            { id: 'avionics', icon: '🎛️', label: 'Avionics' },\r\n            { id: 'fairing', icon: '🛡️', label: 'Fairings' },\r\n            { id: 'decoupler', icon: '⚡', label: 'Decouplers' },\r\n            { id: 'srb', icon: '🚀', label: 'SRBs' }\r\n        ];\r\n\r\n        return categories.map(cat => `\r\n            <button class=\"vab-cat-tab ${this.selectedCategory === cat.id ? 'active' : ''}\"\r\n                    data-category=\"${cat.id}\">\r\n                ${cat.icon} ${cat.label}\r\n            </button>\r\n        `).join('');\r\n    }\r\n\r\n    /**\r\n     * Render parts list for selected category\r\n     */\r\n    private renderPartsList(): string {\r\n        const parts = getPartsByCategory(this.selectedCategory);\r\n\r\n        if (parts.length === 0) {\r\n            return '<div class=\"vab-no-parts\">No parts in this category</div>';\r\n        }\r\n\r\n        return parts.map(part => `\r\n            <div class=\"vab-part-item\" data-part-id=\"${part.id}\">\r\n                <div class=\"vab-part-icon\">${this.getPartIcon(part)}</div>\r\n                <div class=\"vab-part-info\">\r\n                    <div class=\"vab-part-name\">${part.name}</div>\r\n                    <div class=\"vab-part-desc\">${part.description}</div>\r\n                    <div class=\"vab-part-stats\">\r\n                        ${this.formatPartStats(part)}\r\n                    </div>\r\n                </div>\r\n                <div class=\"vab-part-cost\">$${part.cost}</div>\r\n            </div>\r\n        `).join('');\r\n    }\r\n\r\n    /**\r\n     * Get icon for part category\r\n     */\r\n    private getPartIcon(part: RocketPart): string {\r\n        switch (part.category) {\r\n            case 'engine': return '🔥';\r\n            case 'tank': return '⛽';\r\n            case 'avionics': return '🎛️';\r\n            case 'fairing': return '🛡️';\r\n            case 'decoupler': return '⚡';\r\n            case 'srb': return '🚀';\r\n            default: return '📦';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Format part stats for display\r\n     */\r\n    private formatPartStats(part: RocketPart): string {\r\n        const stats: string[] = [`${part.mass}kg`];\r\n\r\n        if (part.thrust) {\r\n            stats.push(`${(part.thrust / 1000).toFixed(0)}kN`);\r\n        }\r\n        if (part.ispVac) {\r\n            stats.push(`${part.ispVac}s Isp`);\r\n        }\r\n        if (part.fuelCapacity) {\r\n            stats.push(`${(part.fuelCapacity / 1000).toFixed(1)}t fuel`);\r\n        }\r\n\r\n        return stats.join(' | ');\r\n    }\r\n\r\n    /**\r\n     * Render vehicle preview\r\n     */\r\n    private renderVehiclePreview(): string {\r\n        if (this.blueprint.stages.length === 0) {\r\n            return '<div class=\"vab-empty-vehicle\">Add stages and parts to build your rocket</div>';\r\n        }\r\n\r\n        // Build visual representation from top to bottom\r\n        let html = '';\r\n        for (let i = this.blueprint.stages.length - 1; i >= 0; i--) {\r\n            const stage = this.blueprint.stages[i];\r\n            if (!stage) continue;\r\n\r\n            html += `<div class=\"vab-stage-preview\" data-stage=\"${i}\">`;\r\n\r\n            // Render parts in stage (top to bottom in visual order)\r\n            for (let j = stage.parts.length - 1; j >= 0; j--) {\r\n                const inst = stage.parts[j];\r\n                if (!inst) continue;\r\n                html += `\r\n                    <div class=\"vab-part-preview\" \r\n                         data-instance=\"${inst.instanceId}\"\r\n                         style=\"height: ${inst.part.height}px; width: ${inst.part.width}px;\">\r\n                        <span class=\"part-label\">${inst.part.name}</span>\r\n                        <button class=\"remove-part\" data-stage=\"${i}\" data-instance=\"${inst.instanceId}\">×</button>\r\n                    </div>\r\n                `;\r\n            }\r\n\r\n            // Show decoupler if present\r\n            if (stage.hasDecoupler && i > 0) {\r\n                html += '<div class=\"vab-decoupler-marker\">⚡ STAGE SEP</div>';\r\n            }\r\n\r\n            html += '</div>';\r\n        }\r\n\r\n        return html;\r\n    }\r\n\r\n    /**\r\n     * Render stages list\r\n     */\r\n    private renderStagesList(): string {\r\n        if (this.blueprint.stages.length === 0) {\r\n            return '<div class=\"vab-no-stages\">No stages yet. Click \"Add Stage\" to begin.</div>';\r\n        }\r\n\r\n        return this.blueprint.stages.map((stage, i) => {\r\n            const stageStats = this.getStageStats(stage);\r\n            return `\r\n                <div class=\"vab-stage-item ${i === 0 ? 'first-stage' : ''}\" data-stage=\"${i}\">\r\n                    <div class=\"vab-stage-header\">\r\n                        <span class=\"stage-number\">Stage ${i + 1}</span>\r\n                        <span class=\"stage-info\">${stage.parts.length} parts</span>\r\n                        ${i > 0 ? '<button class=\"remove-stage\" data-stage=\"' + i + '\">🗑️</button>' : ''}\r\n                    </div>\r\n                    <div class=\"vab-stage-stats\">\r\n                        <span>Mass: ${(stageStats.mass / 1000).toFixed(1)}t</span>\r\n                        <span>ΔV: ${stageStats.deltaV.toFixed(0)} m/s</span>\r\n                    </div>\r\n                    <button class=\"vab-add-to-stage\" data-stage=\"${i}\">+ Add Selected Part</button>\r\n                </div>\r\n            `;\r\n        }).join('');\r\n    }\r\n\r\n    /**\r\n     * Get simple stats for a single stage\r\n     */\r\n    private getStageStats(stage: any): { mass: number; deltaV: number } {\r\n        let mass = 0;\r\n        let fuel = 0;\r\n        let isp = 0;\r\n        let engineCount = 0;\r\n\r\n        for (const inst of stage.parts) {\r\n            mass += inst.part.mass;\r\n            if (inst.part.fuelCapacity) {\r\n                fuel += inst.part.fuelCapacity;\r\n                mass += inst.part.fuelCapacity;\r\n            }\r\n            if (inst.part.ispVac) {\r\n                isp += inst.part.ispVac;\r\n                engineCount++;\r\n            }\r\n        }\r\n\r\n        if (engineCount > 0) isp /= engineCount;\r\n\r\n        const m0 = mass;\r\n        const mf = mass - fuel;\r\n        const deltaV = (isp > 0 && mf > 0 && m0 > mf)\r\n            ? isp * 9.81 * Math.log(m0 / mf)\r\n            : 0;\r\n\r\n        return { mass, deltaV };\r\n    }\r\n\r\n    /**\r\n     * Render stats bar\r\n     */\r\n    private renderStats(stats: VehicleStats): string {\r\n        const twr = stats.stageTWR[0] || 0;\r\n        const twrClass = twr > 1.2 ? 'good' : twr > 1.0 ? 'warning' : 'bad';\r\n        const dvClass = stats.totalDeltaV > 9000 ? 'good' : stats.totalDeltaV > 5000 ? 'warning' : 'bad';\r\n\r\n        return `\r\n            <div class=\"vab-stat\">\r\n                <div class=\"vab-stat-label\">Total Mass</div>\r\n                <div class=\"vab-stat-value\">${(stats.wetMass / 1000).toFixed(1)}</div>\r\n                <div class=\"vab-stat-unit\">tons</div>\r\n            </div>\r\n            <div class=\"vab-stat\">\r\n                <div class=\"vab-stat-label\">Total ΔV</div>\r\n                <div class=\"vab-stat-value ${dvClass}\">${stats.totalDeltaV.toFixed(0)}</div>\r\n                <div class=\"vab-stat-unit\">m/s</div>\r\n            </div>\r\n            <div class=\"vab-stat\">\r\n                <div class=\"vab-stat-label\">TWR (Stage 1)</div>\r\n                <div class=\"vab-stat-value ${twrClass}\">${twr.toFixed(2)}</div>\r\n                <div class=\"vab-stat-unit\">ratio</div>\r\n            </div>\r\n            <div class=\"vab-stat\">\r\n                <div class=\"vab-stat-label\">Stages</div>\r\n                <div class=\"vab-stat-value\">${this.blueprint.stages.length}</div>\r\n                <div class=\"vab-stat-unit\">count</div>\r\n            </div>\r\n            <div class=\"vab-stat\">\r\n                <div class=\"vab-stat-label\">Total Cost</div>\r\n                <div class=\"vab-stat-value\">${stats.totalCost.toLocaleString()}</div>\r\n                <div class=\"vab-stat-unit\">credits</div>\r\n            </div>\r\n            <div class=\"vab-stat\">\r\n                <div class=\"vab-stat-indicator ${stats.hasAvionics ? 'ok' : 'warn'}\">\r\n                    ${stats.hasAvionics ? '✓' : '⚠'} Avionics\r\n                </div>\r\n                <div class=\"vab-stat-indicator ${stats.hasFairing ? 'ok' : 'warn'}\">\r\n                    ${stats.hasFairing ? '✓' : '⚠'} Fairing\r\n                </div>\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    /**\r\n     * Attach event listeners\r\n     */\r\n    private attachEventListeners(): void {\r\n        // Category tabs\r\n        this.container.querySelectorAll('.vab-cat-tab').forEach(btn => {\r\n            btn.addEventListener('click', (e) => {\r\n                const target = e.currentTarget as HTMLElement;\r\n                this.selectedCategory = target.dataset.category as PartCategory;\r\n                this.render();\r\n            });\r\n        });\r\n\r\n        // Part items (select part)\r\n        this.container.querySelectorAll('.vab-part-item').forEach(item => {\r\n            item.addEventListener('click', (e) => {\r\n                // Toggle selection\r\n                this.container.querySelectorAll('.vab-part-item').forEach(i => i.classList.remove('selected'));\r\n                (e.currentTarget as HTMLElement).classList.add('selected');\r\n            });\r\n        });\r\n\r\n        // Add to stage buttons\r\n        this.container.querySelectorAll('.vab-add-to-stage').forEach(btn => {\r\n            btn.addEventListener('click', (e) => {\r\n                const stageIndex = parseInt((e.currentTarget as HTMLElement).dataset.stage || '0');\r\n                const selectedPart = this.container.querySelector('.vab-part-item.selected');\r\n                if (selectedPart) {\r\n                    const partId = (selectedPart as HTMLElement).dataset.partId;\r\n                    const part = PARTS_CATALOG.find(p => p.id === partId);\r\n                    if (part) {\r\n                        this.blueprint = addPartToStage(this.blueprint, stageIndex, part);\r\n                        this.render();\r\n                    }\r\n                }\r\n            });\r\n        });\r\n\r\n        // Remove part buttons\r\n        this.container.querySelectorAll('.remove-part').forEach(btn => {\r\n            btn.addEventListener('click', (e) => {\r\n                e.stopPropagation();\r\n                const target = e.currentTarget as HTMLElement;\r\n                const stageIndex = parseInt(target.dataset.stage || '0');\r\n                const instanceId = target.dataset.instance || '';\r\n                this.blueprint = removePartFromStage(this.blueprint, stageIndex, instanceId);\r\n                this.render();\r\n            });\r\n        });\r\n\r\n        // Add stage button\r\n        this.container.querySelector('.vab-add-stage-btn')?.addEventListener('click', () => {\r\n            this.blueprint = addStage(this.blueprint);\r\n            this.render();\r\n        });\r\n\r\n        // Remove stage buttons\r\n        this.container.querySelectorAll('.remove-stage').forEach(btn => {\r\n            btn.addEventListener('click', (e) => {\r\n                e.stopPropagation();\r\n                const stageIndex = parseInt((e.currentTarget as HTMLElement).dataset.stage || '0');\r\n                this.blueprint = removeStage(this.blueprint, stageIndex);\r\n                this.render();\r\n            });\r\n        });\r\n\r\n        // Preset buttons\r\n        this.container.querySelectorAll('.vab-preset-btn').forEach(btn => {\r\n            btn.addEventListener('click', (e) => {\r\n                const preset = (e.currentTarget as HTMLElement).dataset.preset;\r\n                switch (preset) {\r\n                    case 'falcon':\r\n                        this.blueprint = createFalconPreset();\r\n                        break;\r\n                    case 'simple':\r\n                        this.blueprint = createSimplePreset();\r\n                        break;\r\n                    case 'new':\r\n                        this.blueprint = createBlueprint('New Rocket');\r\n                        this.blueprint = addStage(this.blueprint);\r\n                        break;\r\n                }\r\n                this.render();\r\n            });\r\n        });\r\n\r\n        // Name input\r\n        this.container.querySelector('.vab-name-input')?.addEventListener('change', (e) => {\r\n            this.blueprint.name = (e.target as HTMLInputElement).value;\r\n        });\r\n\r\n        // Save button\r\n        this.container.querySelector('.vab-save-btn')?.addEventListener('click', () => {\r\n            // Update or add to saved blueprints\r\n            const existing = this.savedBlueprints.findIndex(b => b.id === this.blueprint.id);\r\n            if (existing >= 0) {\r\n                this.savedBlueprints[existing] = this.blueprint;\r\n            } else {\r\n                this.savedBlueprints.push(this.blueprint);\r\n            }\r\n            saveBlueprints(this.savedBlueprints);\r\n            alert('Blueprint saved!');\r\n        });\r\n\r\n        // Cancel button\r\n        this.container.querySelector('.vab-cancel-btn')?.addEventListener('click', () => {\r\n            this.hide();\r\n        });\r\n\r\n        // Launch button\r\n        this.container.querySelector('.vab-launch-btn')?.addEventListener('click', () => {\r\n            const stats = calculateStats(this.blueprint);\r\n            if (this.blueprint.stages.length === 0 || (stats.stageTWR[0] || 0) < 1.0) {\r\n                alert('Vehicle not ready! Ensure you have stages and TWR > 1.0');\r\n                return;\r\n            }\r\n            this.hide();\r\n            this.onLaunch(this.blueprint);\r\n        });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\utils\\AssetLoader.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\utils\\AudioEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\utils\\PIDController.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\utils\\SAS.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\vab\\PartsCatalog.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\vab\\VehicleBlueprint.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DECOUPLER' is defined but never used.","line":306,"column":5,"messageId":"unusedVar","endLine":306,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DECOUPLER"},"fix":{"range":[8239,8255],"text":""},"desc":"Remove unused variable \"DECOUPLER\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":376,"column":64,"messageId":"unexpectedAny","endLine":376,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10544,10547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10544,10547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":378,"column":43,"messageId":"unexpectedAny","endLine":378,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10621,10624],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10621,10624],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Vehicle Blueprint\r\n * \r\n * Data structures for user-designed rockets.\r\n * Blueprints can be saved/loaded and converted to playable vehicles.\r\n */\r\n\r\nimport { RocketPart, PartInstance, getPartById, createPartInstance } from './PartsCatalog';\r\n\r\n// ============================================================================\r\n// Blueprint Types\r\n// ============================================================================\r\n\r\n/**\r\n * A single stage of the vehicle\r\n */\r\nexport interface VehicleStage {\r\n    /** Stage number (0 = first to fire, like a real rocket) */\r\n    stageNumber: number;\r\n    /** Parts in this stage (bottom to top) */\r\n    parts: PartInstance[];\r\n    /** Whether this stage has a decoupler at the top */\r\n    hasDecoupler: boolean;\r\n}\r\n\r\n/**\r\n * Complete vehicle blueprint\r\n */\r\nexport interface VehicleBlueprint {\r\n    /** User-assigned name */\r\n    name: string;\r\n    /** Unique ID for localStorage */\r\n    id: string;\r\n    /** Creation timestamp */\r\n    createdAt: number;\r\n    /** Last modified timestamp */\r\n    modifiedAt: number;\r\n    /** Stages from bottom (first stage) to top (payload) */\r\n    stages: VehicleStage[];\r\n}\r\n\r\n/**\r\n * Calculated vehicle statistics\r\n */\r\nexport interface VehicleStats {\r\n    /** Total dry mass in kg */\r\n    dryMass: number;\r\n    /** Total fuel mass in kg */\r\n    fuelMass: number;\r\n    /** Total wet mass (dry + fuel) in kg */\r\n    wetMass: number;\r\n    /** Total height in pixels */\r\n    totalHeight: number;\r\n    /** Total cost in credits */\r\n    totalCost: number;\r\n    /** Per-stage delta-V in m/s */\r\n    stageDeltaV: number[];\r\n    /** Total delta-V in m/s */\r\n    totalDeltaV: number;\r\n    /** Per-stage TWR at ignition */\r\n    stageTWR: number[];\r\n    /** Has avionics for control */\r\n    hasAvionics: boolean;\r\n    /** Has fairing for payload */\r\n    hasFairing: boolean;\r\n}\r\n\r\n// ============================================================================\r\n// Blueprint Factory\r\n// ============================================================================\r\n\r\nlet blueprintCounter = 0;\r\n\r\n/**\r\n * Create a new empty blueprint\r\n */\r\nexport function createBlueprint(name: string = 'New Rocket'): VehicleBlueprint {\r\n    const now = Date.now();\r\n    return {\r\n        name,\r\n        id: `blueprint-${++blueprintCounter}-${now}`,\r\n        createdAt: now,\r\n        modifiedAt: now,\r\n        stages: []\r\n    };\r\n}\r\n\r\n/**\r\n * Add a new empty stage to blueprint\r\n */\r\nexport function addStage(blueprint: VehicleBlueprint): VehicleBlueprint {\r\n    const newStage: VehicleStage = {\r\n        stageNumber: blueprint.stages.length,\r\n        parts: [],\r\n        hasDecoupler: blueprint.stages.length > 0 // All stages except first have decouplers\r\n    };\r\n    return {\r\n        ...blueprint,\r\n        stages: [...blueprint.stages, newStage],\r\n        modifiedAt: Date.now()\r\n    };\r\n}\r\n\r\n/**\r\n * Add a part to a stage\r\n */\r\nexport function addPartToStage(\r\n    blueprint: VehicleBlueprint,\r\n    stageIndex: number,\r\n    part: RocketPart\r\n): VehicleBlueprint {\r\n    const stages = [...blueprint.stages];\r\n    const stage = stages[stageIndex];\r\n    if (!stage) return blueprint;\r\n\r\n    const instance = createPartInstance(part, stageIndex);\r\n    stages[stageIndex] = {\r\n        ...stage,\r\n        parts: [...stage.parts, instance]\r\n    };\r\n\r\n    return {\r\n        ...blueprint,\r\n        stages,\r\n        modifiedAt: Date.now()\r\n    };\r\n}\r\n\r\n/**\r\n * Remove a part from a stage\r\n */\r\nexport function removePartFromStage(\r\n    blueprint: VehicleBlueprint,\r\n    stageIndex: number,\r\n    instanceId: string\r\n): VehicleBlueprint {\r\n    const stages = [...blueprint.stages];\r\n    const stage = stages[stageIndex];\r\n    if (!stage) return blueprint;\r\n\r\n    stages[stageIndex] = {\r\n        ...stage,\r\n        parts: stage.parts.filter(p => p.instanceId !== instanceId)\r\n    };\r\n\r\n    return {\r\n        ...blueprint,\r\n        stages,\r\n        modifiedAt: Date.now()\r\n    };\r\n}\r\n\r\n/**\r\n * Remove a stage (and all its parts)\r\n */\r\nexport function removeStage(blueprint: VehicleBlueprint, stageIndex: number): VehicleBlueprint {\r\n    if (stageIndex < 0 || stageIndex >= blueprint.stages.length) return blueprint;\r\n\r\n    const stages = blueprint.stages\r\n        .filter((_, i) => i !== stageIndex)\r\n        .map((stage, i) => ({ ...stage, stageNumber: i }));\r\n\r\n    return {\r\n        ...blueprint,\r\n        stages,\r\n        modifiedAt: Date.now()\r\n    };\r\n}\r\n\r\n// ============================================================================\r\n// Statistics Calculator\r\n// ============================================================================\r\n\r\nconst G = 9.81; // Standard gravity\r\n\r\n/**\r\n * Calculate vehicle statistics from blueprint\r\n */\r\nexport function calculateStats(blueprint: VehicleBlueprint): VehicleStats {\r\n    let dryMass = 0;\r\n    let fuelMass = 0;\r\n    let totalHeight = 0;\r\n    let totalCost = 0;\r\n    let hasAvionics = false;\r\n    let hasFairing = false;\r\n\r\n    const stageDeltaV: number[] = [];\r\n    const stageTWR: number[] = [];\r\n\r\n    // Calculate totals\r\n    for (const stage of blueprint.stages) {\r\n        for (const inst of stage.parts) {\r\n            const part = inst.part;\r\n            dryMass += part.mass;\r\n            totalHeight += part.height;\r\n            totalCost += part.cost;\r\n\r\n            if (part.fuelCapacity) {\r\n                fuelMass += part.fuelCapacity;\r\n            }\r\n            if (part.sasCapable) {\r\n                hasAvionics = true;\r\n            }\r\n            if (part.category === 'fairing') {\r\n                hasFairing = true;\r\n            }\r\n        }\r\n\r\n        // Add decoupler mass\r\n        if (stage.hasDecoupler) {\r\n            dryMass += 50;\r\n            totalHeight += 5;\r\n            totalCost += 100;\r\n        }\r\n    }\r\n\r\n    const wetMass = dryMass + fuelMass;\r\n\r\n    // Calculate per-stage delta-V (Tsiolkovsky rocket equation)\r\n    // Process stages in reverse (top to bottom for delta-V calculation)\r\n    let remainingMass = wetMass;\r\n\r\n    for (let i = blueprint.stages.length - 1; i >= 0; i--) {\r\n        const stage = blueprint.stages[i];\r\n        if (!stage) continue;\r\n\r\n        // Get stage propulsion\r\n        let stageThrust = 0;\r\n        let stageIsp = 0;\r\n        let stageFuel = 0;\r\n        let stageDry = 0;\r\n        let engineCount = 0;\r\n\r\n        for (const inst of stage.parts) {\r\n            const part = inst.part;\r\n            stageDry += part.mass;\r\n\r\n            if (part.thrust && part.ispVac) {\r\n                stageThrust += part.thrust;\r\n                stageIsp += part.ispVac;\r\n                engineCount++;\r\n            }\r\n            if (part.fuelCapacity) {\r\n                stageFuel += part.fuelCapacity;\r\n            }\r\n        }\r\n\r\n        // Average Isp for multiple engines\r\n        if (engineCount > 0) {\r\n            stageIsp /= engineCount;\r\n        }\r\n\r\n        // Calculate stage delta-V\r\n        const m0 = remainingMass;\r\n        const mf = remainingMass - stageFuel;\r\n\r\n        if (stageIsp > 0 && mf > 0 && m0 > mf) {\r\n            const dv = stageIsp * G * Math.log(m0 / mf);\r\n            stageDeltaV.unshift(dv);\r\n        } else {\r\n            stageDeltaV.unshift(0);\r\n        }\r\n\r\n        // Calculate TWR at stage ignition\r\n        if (stageThrust > 0 && remainingMass > 0) {\r\n            const twr = stageThrust / (remainingMass * G);\r\n            stageTWR.unshift(twr);\r\n        } else {\r\n            stageTWR.unshift(0);\r\n        }\r\n\r\n        // Subtract this stage's mass for next iteration\r\n        remainingMass -= stageDry + stageFuel;\r\n        if (stage.hasDecoupler) {\r\n            remainingMass -= 50;\r\n        }\r\n    }\r\n\r\n    const totalDeltaV = stageDeltaV.reduce((sum, dv) => sum + dv, 0);\r\n\r\n    return {\r\n        dryMass,\r\n        fuelMass,\r\n        wetMass,\r\n        totalHeight,\r\n        totalCost,\r\n        stageDeltaV,\r\n        totalDeltaV,\r\n        stageTWR,\r\n        hasAvionics,\r\n        hasFairing\r\n    };\r\n}\r\n\r\n// ============================================================================\r\n// Preset Blueprints\r\n// ============================================================================\r\n\r\nimport {\r\n    ENGINE_MERLIN_1D,\r\n    ENGINE_MERLIN_VAC,\r\n    TANK_LARGE,\r\n    TANK_MEDIUM,\r\n    AVIONICS_BASIC,\r\n    FAIRING_SMALL,\r\n    DECOUPLER\r\n} from './PartsCatalog';\r\n\r\n/**\r\n * Create a preset Falcon-like two-stage rocket\r\n */\r\nexport function createFalconPreset(): VehicleBlueprint {\r\n    let blueprint = createBlueprint('Falcon 9');\r\n\r\n    // Stage 0: First stage (bottom)\r\n    blueprint = addStage(blueprint);\r\n    blueprint = addPartToStage(blueprint, 0, ENGINE_MERLIN_1D);\r\n    blueprint = addPartToStage(blueprint, 0, TANK_LARGE);\r\n    blueprint = addPartToStage(blueprint, 0, TANK_LARGE);\r\n\r\n    // Stage 1: Second stage\r\n    blueprint = addStage(blueprint);\r\n    blueprint = addPartToStage(blueprint, 1, ENGINE_MERLIN_VAC);\r\n    blueprint = addPartToStage(blueprint, 1, TANK_MEDIUM);\r\n    blueprint = addPartToStage(blueprint, 1, AVIONICS_BASIC);\r\n    blueprint = addPartToStage(blueprint, 1, FAIRING_SMALL);\r\n\r\n    return blueprint;\r\n}\r\n\r\n/**\r\n * Create a simple single-stage rocket\r\n */\r\nexport function createSimplePreset(): VehicleBlueprint {\r\n    let blueprint = createBlueprint('Simple Rocket');\r\n\r\n    blueprint = addStage(blueprint);\r\n    blueprint = addPartToStage(blueprint, 0, ENGINE_MERLIN_1D);\r\n    blueprint = addPartToStage(blueprint, 0, TANK_MEDIUM);\r\n    blueprint = addPartToStage(blueprint, 0, AVIONICS_BASIC);\r\n\r\n    return blueprint;\r\n}\r\n\r\n// ============================================================================\r\n// Serialization for localStorage\r\n// ============================================================================\r\n\r\n/**\r\n * Serialize blueprint to JSON string\r\n */\r\nexport function serializeBlueprint(blueprint: VehicleBlueprint): string {\r\n    // Convert to a format that only stores part IDs\r\n    const serializable = {\r\n        ...blueprint,\r\n        stages: blueprint.stages.map(stage => ({\r\n            ...stage,\r\n            parts: stage.parts.map(inst => ({\r\n                partId: inst.part.id,\r\n                instanceId: inst.instanceId,\r\n                stageIndex: inst.stageIndex\r\n            }))\r\n        }))\r\n    };\r\n    return JSON.stringify(serializable);\r\n}\r\n\r\n/**\r\n * Deserialize blueprint from JSON string\r\n */\r\nexport function deserializeBlueprint(json: string): VehicleBlueprint | null {\r\n    try {\r\n        const data = JSON.parse(json);\r\n\r\n        // Reconstruct part instances from IDs\r\n        const stages: VehicleStage[] = data.stages.map((stage: any) => ({\r\n            ...stage,\r\n            parts: stage.parts.map((inst: any) => {\r\n                const part = getPartById(inst.partId);\r\n                if (!part) throw new Error(`Unknown part: ${inst.partId}`);\r\n                return {\r\n                    part,\r\n                    instanceId: inst.instanceId,\r\n                    stageIndex: inst.stageIndex\r\n                };\r\n            })\r\n        }));\r\n\r\n        return {\r\n            ...data,\r\n            stages\r\n        };\r\n    } catch (e) {\r\n        console.error('Failed to deserialize blueprint:', e);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Save blueprints to localStorage\r\n */\r\nexport function saveBlueprints(blueprints: VehicleBlueprint[]): void {\r\n    const data = blueprints.map(serializeBlueprint);\r\n    localStorage.setItem('vab-blueprints', JSON.stringify(data));\r\n}\r\n\r\n/**\r\n * Load blueprints from localStorage\r\n */\r\nexport function loadBlueprints(): VehicleBlueprint[] {\r\n    const data = localStorage.getItem('vab-blueprints');\r\n    if (!data) return [];\r\n\r\n    try {\r\n        const jsons = JSON.parse(data) as string[];\r\n        return jsons\r\n            .map(deserializeBlueprint)\r\n            .filter((b): b is VehicleBlueprint => b !== null);\r\n    } catch (e) {\r\n        console.error('Failed to load blueprints:', e);\r\n        return [];\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\E Drive Projects\\professional-rocket-launch-simulation\\src\\vab\\VehicleFactory.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateStats' is defined but never used.","line":7,"column":42,"messageId":"unusedVar","endLine":7,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateStats"},"fix":{"range":[145,161],"text":""},"desc":"Remove unused variable \"calculateStats\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Vehicle Factory\r\n * \r\n * Converts VehicleBlueprint into playable ModularVessel instances.\r\n */\r\n\r\nimport { VehicleBlueprint, VehicleStage, calculateStats } from './VehicleBlueprint';\r\nimport { RocketPart } from './PartsCatalog';\r\n\r\n/**\r\n * Aggregated stage properties for physics simulation\r\n */\r\nexport interface StageProperties {\r\n    /** Dry mass of this stage in kg */\r\n    dryMass: number;\r\n    /** Fuel capacity in kg */\r\n    fuelCapacity: number;\r\n    /** Total thrust in Newtons */\r\n    thrust: number;\r\n    /** Vacuum Isp (averaged if multiple engines) */\r\n    ispVac: number;\r\n    /** Sea-level Isp (averaged if multiple engines) */\r\n    ispSL: number;\r\n    /** Max gimbal range in radians */\r\n    gimbalRange: number;\r\n    /** Can throttle engines */\r\n    throttleable: boolean;\r\n    /** Max engine restarts */\r\n    restarts: number;\r\n    /** Height in pixels */\r\n    height: number;\r\n    /** Has SAS capability */\r\n    hasSAS: boolean;\r\n    /** Has fairing */\r\n    hasFairing: boolean;\r\n    /** Parts list for rendering */\r\n    parts: RocketPart[];\r\n}\r\n\r\n/**\r\n * Complete vehicle spec for physics engine\r\n */\r\nexport interface VehicleSpec {\r\n    /** Vehicle name */\r\n    name: string;\r\n    /** Stages from bottom (0) to top */\r\n    stages: StageProperties[];\r\n    /** Total height in pixels */\r\n    totalHeight: number;\r\n    /** Width in pixels */\r\n    width: number;\r\n}\r\n\r\n/**\r\n * Calculate aggregated properties for a single stage\r\n */\r\nfunction calculateStageProperties(stage: VehicleStage): StageProperties {\r\n    let dryMass = 0;\r\n    let fuelCapacity = 0;\r\n    let thrust = 0;\r\n    let ispVacSum = 0;\r\n    let ispSLSum = 0;\r\n    let gimbalRange = 0;\r\n    let throttleable = true;\r\n    let restarts = 0;\r\n    let height = 0;\r\n    let hasSAS = false;\r\n    let hasFairing = false;\r\n    let engineCount = 0;\r\n    const parts: RocketPart[] = [];\r\n\r\n    for (const inst of stage.parts) {\r\n        const part = inst.part;\r\n        parts.push(part);\r\n\r\n        dryMass += part.mass;\r\n        height += part.height;\r\n\r\n        if (part.fuelCapacity) {\r\n            fuelCapacity += part.fuelCapacity;\r\n        }\r\n\r\n        if (part.thrust) {\r\n            thrust += part.thrust;\r\n            ispVacSum += part.ispVac || 0;\r\n            ispSLSum += part.ispSL || 0;\r\n            gimbalRange = Math.max(gimbalRange, part.gimbalRange || 0);\r\n            if (part.throttleable === false) throttleable = false;\r\n            restarts = Math.max(restarts, part.restarts || 0);\r\n            engineCount++;\r\n        }\r\n\r\n        if (part.sasCapable) hasSAS = true;\r\n        if (part.category === 'fairing') hasFairing = true;\r\n    }\r\n\r\n    // Add decoupler mass if present\r\n    if (stage.hasDecoupler) {\r\n        dryMass += 50;\r\n        height += 5;\r\n    }\r\n\r\n    // Average Isp across engines\r\n    const ispVac = engineCount > 0 ? ispVacSum / engineCount : 0;\r\n    const ispSL = engineCount > 0 ? ispSLSum / engineCount : 0;\r\n\r\n    return {\r\n        dryMass,\r\n        fuelCapacity,\r\n        thrust,\r\n        ispVac,\r\n        ispSL,\r\n        gimbalRange,\r\n        throttleable,\r\n        restarts,\r\n        height,\r\n        hasSAS,\r\n        hasFairing,\r\n        parts\r\n    };\r\n}\r\n\r\n/**\r\n * Convert a VehicleBlueprint to a VehicleSpec for physics\r\n */\r\nexport function createVehicleSpec(blueprint: VehicleBlueprint): VehicleSpec {\r\n    const stages = blueprint.stages.map(calculateStageProperties);\r\n    const totalHeight = stages.reduce((sum, s) => sum + s.height, 0);\r\n\r\n    // Use max width from any part\r\n    let width = 40; // default\r\n    for (const stage of blueprint.stages) {\r\n        for (const inst of stage.parts) {\r\n            width = Math.max(width, inst.part.width);\r\n        }\r\n    }\r\n\r\n    return {\r\n        name: blueprint.name,\r\n        stages,\r\n        totalHeight,\r\n        width\r\n    };\r\n}\r\n\r\n/**\r\n * Get initial physics values for a modular vessel\r\n */\r\nexport function getInitialVesselState(spec: VehicleSpec): {\r\n    mass: number;\r\n    fuel: number;\r\n    maxFuel: number;\r\n    thrust: number;\r\n    ispVac: number;\r\n    ispSL: number;\r\n    gimbalRange: number;\r\n    height: number;\r\n    width: number;\r\n} {\r\n    // Start with first stage active (stage 0)\r\n    const activeStage = spec.stages[0];\r\n    if (!activeStage) {\r\n        return {\r\n            mass: 1000,\r\n            fuel: 0,\r\n            maxFuel: 0,\r\n            thrust: 0,\r\n            ispVac: 300,\r\n            ispSL: 250,\r\n            gimbalRange: 0.1,\r\n            height: 100,\r\n            width: 40\r\n        };\r\n    }\r\n\r\n    // Calculate total mass (all stages)\r\n    let totalMass = 0;\r\n    let totalFuel = 0;\r\n    for (const stage of spec.stages) {\r\n        totalMass += stage.dryMass + stage.fuelCapacity;\r\n        totalFuel += stage.fuelCapacity;\r\n    }\r\n\r\n    return {\r\n        mass: totalMass,\r\n        fuel: totalFuel,\r\n        maxFuel: totalFuel,\r\n        thrust: activeStage.thrust,\r\n        ispVac: activeStage.ispVac,\r\n        ispSL: activeStage.ispSL,\r\n        gimbalRange: activeStage.gimbalRange,\r\n        height: spec.totalHeight,\r\n        width: spec.width\r\n    };\r\n}\r\n\r\n/**\r\n * Get stage separation data\r\n */\r\nexport function getStageSeparationData(spec: VehicleSpec, currentStage: number): {\r\n    separatedMass: number;\r\n    separatedHeight: number;\r\n    nextStageThrust: number;\r\n    nextStageIsp: number;\r\n    hasNextStage: boolean;\r\n} {\r\n    if (currentStage >= spec.stages.length - 1) {\r\n        return {\r\n            separatedMass: 0,\r\n            separatedHeight: 0,\r\n            nextStageThrust: 0,\r\n            nextStageIsp: 0,\r\n            hasNextStage: false\r\n        };\r\n    }\r\n\r\n    const current = spec.stages[currentStage];\r\n    if (!current) {\r\n        return {\r\n            separatedMass: 0,\r\n            separatedHeight: 0,\r\n            nextStageThrust: 0,\r\n            nextStageIsp: 0,\r\n            hasNextStage: false\r\n        };\r\n    }\r\n    const next = spec.stages[currentStage + 1];\r\n    if (!next) {\r\n        return {\r\n            separatedMass: current.dryMass,\r\n            separatedHeight: current.height,\r\n            nextStageThrust: 0,\r\n            nextStageIsp: 0,\r\n            hasNextStage: false\r\n        };\r\n    }\r\n\r\n    return {\r\n        separatedMass: current.dryMass,\r\n        separatedHeight: current.height,\r\n        nextStageThrust: next.thrust,\r\n        nextStageIsp: next.ispVac,\r\n        hasNextStage: true\r\n    };\r\n}\r\n","usedDeprecatedRules":[]}]