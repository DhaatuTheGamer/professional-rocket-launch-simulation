<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self'; img-src 'self' data: blob:; connect-src 'self'; font-src 'self'; worker-src 'self' blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeltaV Lab</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- VAB Modal - Content rendered by VABEditor.ts -->
    <div id="vab-modal"></div>

    <div id="splash-screen">
        <div class="content">
            <h1>Delta-V Lab <span
                    style="font-size: 0.4em; vertical-align: text-top; opacity: 0.6; font-weight: normal;">v3.1.0</span>
            </h1>
            <p class="subtitle">Engineering-Grade Spaceflight Simulation</p>

            <div class="mission-guide">
                <h2>Full Mission Profile Guide</h2>
                <ol>
                    <li><strong>LIFTOFF:</strong> Press <span class="key">SPACE</span>. Engines ignite at T-0.</li>
                    <li><strong>GRAVITY TURN:</strong> At <strong>2.0 km</strong>, tap <span class="key">RIGHT
                            ARROW</span> to tilt slightly (~10°).</li>
                    <li><strong>MAX Q:</strong> Watch for camera shake and vapor cones around 300 m/s.</li>
                    <li><strong>STAGING:</strong> When APOGEE > 100km (or fuel low), press <span class="key">S</span>.
                    </li>
                </ol>
            </div>

            <div class="splash-menu">
                <div id="instruction-panel"
                    style="background:rgba(0,0,0,0.5); padding:15px; border-radius:8px; margin-bottom:20px; text-align:left; max-width:400px; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.2);">
                    <h3 style="margin-top:0; color:#3498db; border-bottom:1px solid #3498db; padding-bottom:5px;">
                        FLIGHT MANUAL</h3>
                    <ul style="padding-left:20px; color:#ddd; line-height:1.6;">
                        <li><strong>Launch:</strong> Press <span style="color:#f1c40f">[SPACE]</span> to
                            ignite.</li>
                        <li><strong>Throttle:</strong> <span style="color:#f1c40f">[SHIFT]</span> / <span
                                style="color:#f1c40f">[CTRL]</span> or Touch Slider.</li>
                        <li><strong>Steer:</strong> <span style="color:#f1c40f">[ARROWS]</span> or Virtual
                            Joystick.</li>
                        <li><strong>Staging:</strong> Press <span style="color:#f1c40f">[S]</span> when fuel
                            empty.</li>
                        <li><strong>Map:</strong> Press <span style="color:#f1c40f">[M]</span> to view
                            Orbit.</li>
                        <li><strong>SAS:</strong> <span style="color:#f1c40f">[T]</span> Stability, <span style="color:#f1c40f">[ []</span> Prograde, <span style="color:#f1c40f">[ ]]</span> Retrograde.</li>
                    </ul>
                    <div style="margin-top:10px; font-size:0.8rem; color:#aaa; font-style:italic;">
                        Tip: Use gravity turn at 5km altitude (tilt 45&deg; East).
                    </div>
                </div>

                <button id="start-btn" class="menu-btn">ENTER MISSION CONTROL</button>
                <button id="open-vab-btn" class="menu-btn secondary">VEHICLE ASSEMBLY (VAB)</button>
            </div>
        </div>
    </div>

    <div id="ui-layer">
        <!-- New HUD Header -->
        <div id="hud-top-bar">
            <div class="hud-module">
                <div class="hud-label">ALTITUDE</div>
                <div class="hud-value-large"><span id="hud-alt">0.0</span> <span class="unit">km</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">APOGEE</div>
                <div class="hud-value-large"><span id="hud-apogee">0.0</span> <span class="unit">km</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">VELOCITY</div>
                <div class="hud-value-large"><span id="hud-vel">0</span> <span class="unit">m/s</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">AoA</div>
                <div class="hud-value-large"><span id="hud-aoa" style="color: #2ecc71;">0.0°</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">STABILITY</div>
                <div class="hud-value-large"><span id="hud-stability" style="color: #2ecc71;">30.0%</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">SKIN TEMP</div>
                <div class="hud-value-large"><span id="hud-skin-temp" style="color: #2ecc71;">20°C</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">TPS</div>
                <div class="hud-value-large"><span id="hud-tps-status" style="color: #95a5a6;">N/A</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">ENGINE</div>
                <div class="hud-value-large"><span id="hud-engine-status" style="color: #95a5a6;">OFF</span></div>
            </div>
            <div class="hud-module">
                <div class="hud-label">IGN</div>
                <div class="hud-value-large"><span id="hud-igniters" style="color: #2ecc71;">3</span></div>
            </div>
            <div class="hud-module environment">
                <div class="hud-label">WIND</div>
                <div class="hud-value-large"><span id="hud-wind-speed" style="color: #2ecc71;">0 m/s</span> <span
                        id="hud-wind-dir" class="unit">N</span></div>
            </div>
            <div class="hud-module environment">
                <div class="hud-label">LOCAL TIME</div>
                <div class="hud-value-large"><span id="hud-time-of-day" style="color: #3498db;">12:00</span></div>
            </div>
            <div class="hud-module environment launch-status">
                <div class="hud-label">LAUNCH</div>
                <div class="hud-value-large"><span id="hud-launch-status" class="go-status"
                        style="color: #2ecc71;">GO</span></div>
                <div id="hud-maxq-warning" style="display: none; color: #e67e22; font-size: 0.7rem;"></div>
            </div>
            <div class="hud-module fts-module">
                <div class="hud-label">FTS</div>
                <div class="hud-value-large"><span id="hud-fts-state" style="color: #2ecc71;">SAFE</span></div>
            </div>
        </div>

        <div id="hud-gauges">
            <div class="gauge-container">
                <div class="gauge-bar-bg">
                    <div id="gauge-fuel" class="gauge-bar-fill" style="height: 100%; background-color: #f1c40f;"></div>
                </div>
                <div class="gauge-label">FUEL</div>
            </div>
            <div class="gauge-container">
                <div class="gauge-bar-bg">
                    <div id="gauge-thrust" class="gauge-bar-fill" style="height: 0%; background-color: #e74c3c;"></div>
                </div>
                <div class="gauge-label">THRUST</div>
            </div>
        </div>

        <div style="position: absolute; bottom: 160px; left: 20px; pointer-events: none;">
            <canvas id="navball" width="140" height="140" style="background:transparent;"></canvas>
        </div>
        <div style="display:none">
            <canvas id="graph-canvas"></canvas>
        </div>

        <!-- IMPROVEMENT #10: Camera Panel -->
        <div id="camera-panel">
            <button data-cam="1" class="active" title="Follow Camera [1]">Follow</button>
            <button data-cam="2" title="Orbit Camera [2]">Orbit</button>
            <button data-cam="3" title="Cinema Camera [3]">Cinema</button>
        </div>

        <!-- SAS Controls - Enhanced -->
        <div id="sas-controls">
            <div class="sas-title">SAS CONTROL</div>
            <div class="sas-group">
                <button id="sas-off" class="sas-btn active" title="SAS Off [T]">OFF</button>
                <button id="sas-stability" class="sas-btn" title="Stability Assist [T]">STABILITY</button>
            </div>
            <div class="sas-group">
                <button id="sas-prograde" class="sas-btn" title="Prograde [ []">PROGRADE</button>
                <button id="sas-retrograde" class="sas-btn" title="Retrograde [ ]]">RETROGRADE</button>
            </div>
            <div id="sas-mode-indicator">
                <span class="icon"></span>
                <span id="sas-mode-text">OFF</span>
            </div>
        </div>

        <!-- Flight Computer Status HUD -->
        <div id="fc-status"></div>

        <!-- Black Box Recording Status -->
        <div id="bb-status"></div>

        <!-- IMPROVEMENT #5: Collapsible Mission Log -->
        <div id="mission-log">
            <h3>
                MISSION LOG
                <button id="log-toggle" title="Toggle Mission Log" aria-label="Toggle Mission Log">−</button>
            </h3>
            <ul id="log-list">
            </ul>
        </div>
    </div>

    <div id="controls-help">
        [SPACE] Launch | [S] Stage | [T] SAS | [Alt+T] FTS Arm | [C] Checklist | [Ctrl+I] FIS | [G] Flight PC
    </div>

    <div id="status-msg">T-MINUS 3 SECONDS</div>

    <!-- IMPROVEMENT #7: Onboarding Tooltip Overlay -->
    <div id="tooltip-overlay" class="tooltip-overlay">
        <div class="tooltip-box">
            <h3>Welcome to Mission Control!</h3>
            <p>Ready for your first launch? Press <span class="key-hint">SPACE</span> to ignite the engines!</p>
            <p style="font-size: 0.8rem; color: #888;">Use arrow keys to steer, SHIFT/CTRL for throttle.</p>
            <button id="tooltip-dismiss">GOT IT!</button>
        </div>
    </div>

    <div id="controls">
        <button id="launch-btn" class="primary state-launch" title="Launch [SPACE]">INITIATE LAUNCH</button>
        <button id="checklist-btn" title="Launch Checklist [C]">Checklist</button>
        <button id="fts-destruct-btn" class="fts-destruct" title="FTS Destruct [Alt+T to arm]">FTS DESTRUCT</button>
        <button id="maneuver-btn" title="Maneuver Planner [O]">Maneuver</button>
        <button id="mission-control-btn" title="Mission Control">CAPCOM</button>
        <button id="fc-btn" title="Open Flight Computer Script Editor [F]">Flight PC</button>
        <button id="telemetry-btn" title="Pop Out Telemetry [P]">Telemetry</button>
        <button id="export-btn" title="Export Flight Data [E]">Export Data</button>
        <button id="autopilot-btn" title="Toggle Auto-Land [A]">Auto-Land: OFF</button>
        <button id="audio-btn" class="disabled">Enable Audio</button>
        <button id="reset-btn">Reset</button>
    </div>

    <div id="mobile-controls">
        <div id="joystick-zone">
            <div id="joystick-knob"></div>
        </div>
        <div id="mobile-buttons">
            <button id="btn-stage">STAGE</button>
            <button id="btn-payload">PAYLOAD</button>
            <button id="btn-cam">CAM</button>
        </div>
        <div id="throttle-zone">
            <div id="throttle-handle"></div>
        </div>
    </div>

    <!-- Launch Checklist Panel -->
    <div id="checklist-panel" style="display: none;"></div>

    <!-- Fault Injection System Panel (Instructor) -->
    <div id="fis-panel" style="display: none;"></div>

    <canvas id="canvas"></canvas>

    <!-- TypeScript Compiled Bundle -->
    <script type="module" src="dist/bundle.js"></script>
</body>

</html>